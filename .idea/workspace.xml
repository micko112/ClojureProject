<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="AutoImportSettings">
    <option name="autoReloadType" value="SELECTIVE" />
  </component>
  <component name="ChangeListManager">
    <list default="true" id="4d338447-6f3a-43e8-ab8c-95e214f36644" name="Changes" comment="Front end using htmx with hiccup.Using ring for web server and metosin reitit for routes/ with hiccup. &#10;Server is up, and most basic leaderboard is shown.">
      <change beforePath="$PROJECT_DIR$/.idea/workspace.xml" beforeDir="false" afterPath="$PROJECT_DIR$/.idea/workspace.xml" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/.nrepl-port" beforeDir="false" afterPath="$PROJECT_DIR$/.nrepl-port" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/src/web/server.clj" beforeDir="false" afterPath="$PROJECT_DIR$/src/web/server.clj" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/target/classes/META-INF/maven/ProjectV1/ProjectV1/pom.properties" beforeDir="false" afterPath="$PROJECT_DIR$/target/classes/META-INF/maven/ProjectV1/ProjectV1/pom.properties" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/target/repl-port" beforeDir="false" afterPath="$PROJECT_DIR$/target/repl-port" afterDir="false" />
    </list>
    <option name="SHOW_DIALOG" value="false" />
    <option name="HIGHLIGHT_CONFLICTS" value="true" />
    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
    <option name="LAST_RESOLUTION" value="IGNORE" />
  </component>
  <component name="FileTemplateManagerImpl">
    <option name="RECENT_TEMPLATES">
      <list>
        <option value="Clojure Test Namespace" />
        <option value="Clojure Namespace" />
      </list>
    </option>
  </component>
  <component name="Git.Settings">
    <option name="RECENT_GIT_ROOT_PATH" value="$PROJECT_DIR$" />
  </component>
  <component name="GitHubPullRequestSearchHistory">{
  &quot;lastFilter&quot;: {
    &quot;state&quot;: &quot;OPEN&quot;,
    &quot;assignee&quot;: &quot;micko112&quot;
  }
}</component>
  <component name="GithubPullRequestsUISettings">{
  &quot;selectedUrlAndAccountId&quot;: {
    &quot;url&quot;: &quot;https://github.com/micko112/ClojureProject.git&quot;,
    &quot;accountId&quot;: &quot;3764571a-842a-40c7-838d-20632f3769b4&quot;
  }
}</component>
  <component name="HighlightingSettingsPerFile">
    <setting file="file://$PROJECT_DIR$/src/project/db.clj" root0="FORCE_HIGHLIGHTING" />
  </component>
  <component name="ProjectColorInfo">{
  &quot;associatedIndex&quot;: 5
}</component>
  <component name="ProjectId" id="37ZsZpPnuy4tgd50LQGXH7cfGlR" />
  <component name="ProjectViewState">
    <option name="hideEmptyMiddlePackages" value="true" />
    <option name="showLibraryContents" value="true" />
  </component>
  <component name="PropertiesComponent">{
  &quot;keyToString&quot;: {
    &quot;Clojure REPL.REPL for ProjectV1.executor&quot;: &quot;Run&quot;,
    &quot;ModuleVcsDetector.initialDetectionPerformed&quot;: &quot;true&quot;,
    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,
    &quot;RunOnceActivity.git.unshallow&quot;: &quot;true&quot;,
    &quot;SHARE_PROJECT_CONFIGURATION_FILES&quot;: &quot;true&quot;,
    &quot;clojure.test.Test project.api-test/delta-test.executor&quot;: &quot;Run&quot;,
    &quot;clojure.test.Test project.api-test/leaderboard-rank-ties-test.executor&quot;: &quot;Run&quot;,
    &quot;cursive.last.file.extension.C\\:/xampp/htdocs/Clojure/Clojure for Brave and True/ProjectV1/src&quot;: &quot;clj&quot;,
    &quot;cursive.last.file.extension.C\\:/xampp/htdocs/Clojure/Clojure for Brave and True/ProjectV1/test&quot;: &quot;clj&quot;,
    &quot;git-widget-placeholder&quot;: &quot;main&quot;,
    &quot;last_opened_file_path&quot;: &quot;C:/xampp/htdocs/Clojure/Clojure for Brave and True/ProjectV1/project.clj&quot;,
    &quot;node.js.detected.package.eslint&quot;: &quot;true&quot;,
    &quot;node.js.detected.package.tslint&quot;: &quot;true&quot;,
    &quot;node.js.selected.package.eslint&quot;: &quot;(autodetect)&quot;,
    &quot;node.js.selected.package.tslint&quot;: &quot;(autodetect)&quot;,
    &quot;nodejs_package_manager_path&quot;: &quot;npm&quot;,
    &quot;settings.editor.selected.configurable&quot;: &quot;preferences.lookFeel&quot;,
    &quot;vue.rearranger.settings.migration&quot;: &quot;true&quot;
  },
  &quot;keyToStringList&quot;: {
    &quot;GitStage.ChangesTree.GroupingKeys&quot;: [
      &quot;directory&quot;,
      &quot;module&quot;,
      &quot;repository&quot;
    ]
  }
}</component>
  <component name="RecentsManager">
    <key name="MoveFile.RECENT_KEYS">
      <recent name="C:\xampp\htdocs\Clojure\Clojure for Brave and True\ProjectV1\src\playground" />
    </key>
  </component>
  <component name="ReplState" timestamp="1769433344839">{:repl-history {:ide [], :local [{:command &quot;(fact\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; {{:delta -1 :user/username \&quot;A\&quot;}\n      {:delta 1 :user/username \&quot;B\&quot;}\n      {:delta 0 :user/username \&quot;C\&quot;}}\n\n)&quot;, :offset 181, :ns &quot;project.api-test&quot;} {:command &quot;(fact\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:delta -1 :user/username \&quot;A\&quot;}\n      {:delta 1 :user/username \&quot;B\&quot;}\n      {:delta 0 :user/username \&quot;C\&quot;}\n      ]\n\n)&quot;, :offset 188, :ns &quot;project.api-test&quot;} {:command &quot;(fact\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:delta -1 :user/username \&quot;A\&quot;}\n      {:delta 1 :user/username \&quot;B\&quot;}\n      {:user/username \&quot;C\&quot; :delta 0 }]\n\n)&quot;, :offset 182, :ns &quot;project.api-test&quot;} {:command &quot;(def users\n  [{:user/username \&quot;A\&quot; :user/xp 300}\n   {:user/username \&quot;B\&quot; :user/xp 200}\n    {:user/username \&quot;C\&quot; :user/xp 150}\n   ])&quot;, :offset 128, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test delta funkcije\&quot;\n      (let [new-lb [{:user/username \&quot;A\&quot; :user/xp 300}\n                    {:user/username \&quot;B\&quot; :user/xp 200}\n                    {:user/username \&quot;C\&quot; :user/xp 150}\n                    {:user/username \&quot;D\&quot; :user/xp 150}\n                    ]])\n      (let [delta (lb/leaderboard-delta old-lb new-lb)]\n        delta)\n      =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n          {:user/username \&quot;B\&quot; :delta 1 }\n          {:user/username \&quot;C\&quot; :delta 0 }]\n      )&quot;, :offset 471, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test delta funkcije\&quot;\n      (let [new-lb [{:user/username \&quot;A\&quot; :user/xp 300}\n                    {:user/username \&quot;B\&quot; :user/xp 200}\n                    {:user/username \&quot;C\&quot; :user/xp 150}\n                    {:user/username \&quot;D\&quot; :user/xp 150}\n                    ]]\n        (let [delta (lb/leaderboard-delta old-lb new-lb)]\n          delta))\n     \n      =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n          {:user/username \&quot;B\&quot; :delta 1 }\n          {:user/username \&quot;C\&quot; :delta 0 }]\n      )&quot;, :offset 481, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test delta funkcije\&quot;\n        (let [delta (lb/leaderboard-delta old-lb new-lb)]\n          delta))&quot;, :offset 103, :ns &quot;project.api-test&quot;} {:command &quot;(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 1}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :user/xp 4}\n   ])&quot;, :offset 149, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.leaderboard\n  (:require [project.db :as db]\n            [datomic.api :as d]\n            [project.connection :refer [conn]]\n            [project.time :as t]\n            [clojure.pprint :refer [print-table]])\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n\n(defn desc [a b] ; nasao sam na guglu kako se sortira od najveceg ka najmanjem.\n  (compare b a))\n\n\n\n\n\n(defn leaderboard-rank-ties [db period date]\n  (let [users (db/get-all-users db)\n        users-with-xp (map (fn [user]\n                             {:user/username (:user/username user)\n                              :user/xp (db/xp-per-user db (:user/username user) period date)})\n                           users)\n        sorted-users-with-xp (sort-by :user/xp &gt; users-with-xp)\n        ]\n    (loop [users-left sorted-users-with-xp\n           result []\n           current-rank 1\n           prev-xp nil\n           same-count 0]\n      (if (empty? users-left)\n        result\n        (let [user (first users-left)\n              user-xp (:user/xp user)]\n          (if (= user-xp prev-xp)\n            (recur (rest users-left)\n                   (conj result (assoc user :rank current-rank))\n                   current-rank\n                   user-xp\n                   (inc same-count))\n            (let [new-rank (+ current-rank same-count)]\n              (recur (rest users-left)\n                     (conj result (assoc user :rank new-rank))\n                     new-rank\n                     user-xp\n                     1))))))))\n\n; leaderboard delta pokazuje koliko je koji user promenio rank\n(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     [username])lb)])\n  )\n\n\n(defn leaderboard-delta [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             new-lb))]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n             {:user/username username\n              :delta (- old-r new-r)}))\n         (keys new-ranks))))\n\n(defn leaderboard [db period date]\n\n  (let [\n        previous-date (case period\n                        :daily (.minusDays date 1)\n                        :weekly (.minusWeeks date 1)\n                        :monthly (.minusMonths date 1)\n                        date)\n        old-lb (leaderboard-rank-ties db period date)\n        new-lb (leaderboard-rank-ties db period previous-date)\n        delta (leaderboard-delta old-lb new-lb)\n        delta-map (into {} (map (fn [{:user/keys [username] :keys [delta]}]\n                                  [username delta])\n                                delta))\n        ]\n    (map (fn [user-rank]\n           (assoc user-rank :delta (get delta-map (:user/username user-rank) 0)))\n         new-lb)))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot;, :offset 3190, :ns &quot;project.api-test&quot;} {:command &quot;(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     [username])lb)]\n    names)\n  )&quot;, :offset 125, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     username)lb)]\n    names)\n  )&quot;, :offset 123, :ns &quot;project.leaderboard&quot;} {:command &quot;(get-all-names (leaderboard (d/db conn) :all (LocalDate/now)))&quot;, :offset 62, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn new-user-check [old-names new-names]\n  (if (= old-names new-names) 10) 20)&quot;, :offset 80, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn new-user-check [old-names new-names]\n  (if (= (get-all-names old-names) (get-all-names new-names)) 10) 20)&quot;, :offset 112, :ns &quot;project.leaderboard&quot;} {:command &quot;(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; 20)&quot;, :offset 75, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; 10)&quot;, :offset 75, :ns &quot;project.api-test&quot;} {:command &quot;(defn new-user-check [old-names new-names]\n  (filter (complement old-names) new-names)\n)&quot;, :offset 88, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n(def old-lb\n  [{:user/username \&quot;A\&quot; :rank 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])\n(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 1}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :user/xp 4}\n   ])\n(def users\n  [{:user/username \&quot;A\&quot; :user/xp 300}\n   {:user/username \&quot;B\&quot; :user/xp 200}\n    {:user/username \&quot;C\&quot; :user/xp 150}\n\n   ])\n\n(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta 1 }\n      {:user/username \&quot;C\&quot; :delta 0 }]\n)\n(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; )\n\n(defn new-user-check [old-names new-names]\n  (filter (complement old-names) new-names)\n)\n\n(fact \&quot;test leaderboard unit fn\&quot;\n      (let []))\n\n\n\n&quot;, :offset 1321, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn new-user-check [old-lb new-lb]\n  (let [old-names (lb/get-all-names old-lb) new-names (lb/get-all-names new-lb)]\n    (filter (complement old-names) new-names))\n  \n)&quot;, :offset 169, :ns &quot;project.api-test&quot;} {:command &quot;(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(lb/get-all-names old-lb)) new-names (set(lb/get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n\n)&quot;, :offset 177, :ns &quot;project.api-test&quot;} {:command &quot;(lb/get-all-names old-lb)&quot;, :offset 25, :ns &quot;project.api-test&quot;} {:command &quot;(new-user-check old-lb new-lb)&quot;, :offset 29, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             new-lb))]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n            \n               {:user/username username\n                :delta (- old-r new-r)}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n             ))\n         (keys new-ranks)))&quot;, :offset 716, :ns &quot;project.leaderboard&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n(def old-lb\n  [{:user/username \&quot;A\&quot; :rank 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])\n(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 1}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :user/xp 4}\n   ])\n(def users\n  [{:user/username \&quot;A\&quot; :user/xp 300}\n   {:user/username \&quot;B\&quot; :user/xp 200}\n    {:user/username \&quot;C\&quot; :user/xp 150}\n\n   ])\n\n(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta 1 }\n      {:user/username \&quot;C\&quot; :delta 0 }]\n)\n(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; )\n\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(lb/get-all-names old-lb)) new-names (set(lb/get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n\n)\n\n(fact \&quot;test leaderboard unit fn\&quot;\n      (let []))\n\n\n\n&quot;, :offset 1410, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               )\n             {:user/username username\n              :delta (- old-r new-r)}\n             )\n           ))\n    (keys new-ranks)))&quot;, :offset 1015, :ns &quot;project.leaderboard&quot;} {:command &quot;(ns project.leaderboard\n  (:require [project.db :as db]\n            [datomic.api :as d]\n            [project.connection :refer [conn]]\n            [project.time :as t]\n            [clojure.pprint :refer [print-table]])\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n\n(defn desc [a b] ; nasao sam na guglu kako se sortira od najveceg ka najmanjem.\n  (compare b a))\n\n\n\n\n\n(defn leaderboard-rank-ties [db period date]\n  (let [users (db/get-all-users db)\n        users-with-xp (map (fn [user]\n                             {:user/username (:user/username user)\n                              :user/xp (db/xp-per-user db (:user/username user) period date)})\n                           users)\n        sorted-users-with-xp (sort-by :user/xp &gt; users-with-xp)\n        ]\n    (loop [users-left sorted-users-with-xp\n           result []\n           current-rank 1\n           prev-xp nil\n           same-count 0]\n      (if (empty? users-left)\n        result\n        (let [user (first users-left)\n              user-xp (:user/xp user)]\n          (if (= user-xp prev-xp)\n            (recur (rest users-left)\n                   (conj result (assoc user :rank current-rank))\n                   current-rank\n                   user-xp\n                   (inc same-count))\n            (let [new-rank (+ current-rank same-count)]\n              (recur (rest users-left)\n                     (conj result (assoc user :rank new-rank))\n                     new-rank\n                     user-xp\n                     1))))))))\n\n; leaderboard delta pokazuje koliko je koji user promenio rank\n(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     username)lb)]\n    names)\n  )\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(get-all-names old-lb)) new-names (set(get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n  )\n\n(defn leaderboard-delta [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             new-lb))]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n\n               {:user/username username\n                :delta (- old-r new-r)}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n             ))\n         (keys new-ranks)))\n\n(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               )\n             {:user/username username\n              :delta (- old-r new-r)}\n             )\n           ))\n    (keys new-ranks)))\n\n\n(defn leaderboard [db period date]\n\n  (let [\n        previous-date (case period\n                        :daily (.minusDays date 1)\n                        :weekly (.minusWeeks date 1)\n                        :monthly (.minusMonths date 1)\n                        date)\n        old-lb (leaderboard-rank-ties db period date)\n        new-lb (leaderboard-rank-ties db period previous-date)\n        delta (leaderboard-delta old-lb new-lb)\n        delta-map (into {} (map (fn [{:user/keys [username] :keys [delta]}]\n                                  [username delta])\n                                delta))\n        ]\n    (map (fn [user-rank]\n           (assoc user-rank :delta (get delta-map (:user/username user-rank) 0)))\n         new-lb)))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot;, :offset 4503, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n               )\n             \n           ))\n    (keys new-ranks)))&quot;, :offset 1035, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n               )\n\n           ))\n    (keys new-ranks)))&quot;, :offset 1022, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (vec(map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n               )\n\n           )))\n    (keys new-ranks)))&quot;, :offset 1027, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (mapv (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n               )\n\n           )(keys new-ranks))\n    ))&quot;, :offset 1023, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (mapv (fn [username]\n            (let [old-r (get old-ranks username)\n                  new-r (get new-ranks username)]\n              (if (new-users username)\n                {:user/username username\n                 :delta (- (inc last-old-rank) new-r)\n                 :status \&quot;New\&quot;}\n                {:user/username username\n                 :delta (- old-r new-r)})))\n          (keys new-ranks))))&quot;, :offset 974, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)\n                 ]\n             (if (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status \&quot;New\&quot;}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n               )\n\n           )(keys new-ranks))\n    ))&quot;, :offset 1022, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n             (cond\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status :new}\n               \n               (and old-r new-r)\n               {:user/username username\n                :delta (- old-r new-r)}\n               \n               :else\n               {:user/username username\n                :delta 0})))\n         (keys new-ranks))))&quot;, :offset 1132, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n             (cond\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status :new}\n\n               (and old-r new-r)\n               {:user/username username\n                :delta (- old-r new-r)}\n\n               :else\n               {:user/username username\n                :delta 0})))\n         (keys new-ranks))))&quot;, :offset 1102, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {}\n                        (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             old-lb))\n        new-ranks (into {}\n                        (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)]\n    (doall\n      (map (fn [username]\n             (let [old-r (get old-ranks username)\n                   new-r (get new-ranks username)]\n               (cond\n                 (nil? new-r)\n                 {:user/username username\n                  :delta 0\n                  :status :invalid}\n\n                 (new-users username)\n                 {:user/username username\n                  :delta (- (inc last-old-rank) new-r)\n                  :status :new}\n\n                 (number? old-r)\n                 {:user/username username\n                  :delta (- old-r new-r)}\n\n                 :else\n                 {:user/username username\n                  :delta 0})))\n           (keys new-ranks)))))\n&quot;, :offset 1307, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)]\n\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n\n             (cond\n               ;; Slučaj 1: Potpuno novi korisnik\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :old-rank nil\n                :new-rank new-r\n                :status \&quot;New\&quot;}\n\n               ;; Slučaj 2: Korisnik koji je pao sa liste (nema ga u novoj)\n               (nil? new-r)  ;; ovo ne bi trebalo da se desi sa tvojim kodom\n               {:user/username username\n                :delta (- old-r (inc last-old-rank))\n                :old-rank old-r\n                :new-rank nil\n                :status \&quot;Removed\&quot;}\n\n               ;; Slučaj 3: Normalno pomeranje\n               :else\n               {:user/username username\n                :delta (- old-r new-r)\n                :old-rank old-r\n                :new-rank new-r\n                :status \&quot;Moved\&quot;})))\n\n         (keys new-ranks))))&quot;, :offset 1596, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)]\n\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n\n             (cond\n               ;; Slučaj 1: Potpuno novi korisnik\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :old-rank nil\n                :new-rank new-r\n                :status \&quot;New\&quot;}\n\n               ;; Slučaj 2: Korisnik koji je bio u staroj, nema ga u novoj\n               ;; ALI OVO SE NIKAD NE DEŠAVA jer (keys new-ranks) sadrži samo one koji SU u new-ranks!\n               (nil? new-r)\n               {:user/username username\n                :delta (- old-r (inc last-old-rank))\n                :old-rank old-r\n                :new-rank nil\n                :status \&quot;Removed\&quot;}\n\n               ;; Slučaj 3: Normalno pomeranje - STARO RANK POSTOJI!\n               (and old-r new-r)  ;; DODAJ OVU PROVERU!\n               {:user/username username\n                :delta (- old-r new-r)\n                :old-rank old-r\n                :new-rank new-r\n                :status \&quot;Moved\&quot;}\n\n               ;; Slučaj 4: Nekonzistentni podaci (trebalo bi da se desi)\n               :else\n               {:user/username username\n                :delta 0  ;; ili neka default vrednost\n                :old-rank old-r\n                :new-rank new-r\n                :status \&quot;Error\&quot;})))\n\n         (keys new-ranks))))&quot;, :offset 1994, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n(def old-lb\n  [{:user/username \&quot;A\&quot; :rank 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])\n(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 1}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :user/xp 4}\n   ])\n(def users\n  [{:user/username \&quot;A\&quot; :user/xp 300}\n   {:user/username \&quot;B\&quot; :user/xp 200}\n    {:user/username \&quot;C\&quot; :user/xp 150}\n\n   ])\n()\n(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta 1 }\n      {:user/username \&quot;C\&quot; :delta 0 }]\n)\n(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; )\n\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(lb/get-all-names old-lb)) new-names (set(lb/get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n\n)\n\n(fact \&quot;test leaderboard unit fn\&quot;\n      (let []))\n\n\n\n&quot;, :offset 1412, :ns &quot;project.api-test&quot;} {:command &quot;(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     username)lb)]\n    names)\n  )\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(get-all-names old-lb)) new-names (set(get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n  )\n&quot;, :offset 297, :ns &quot;project.leaderboard&quot;} {:command &quot;(lb/leaderboard-delta-edge-case old-lb new-lb)&quot;, :offset 45, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.leaderboard\n  (:require [project.db :as db]\n            [datomic.api :as d]\n            [project.connection :refer [conn]]\n            [project.time :as t]\n            [clojure.pprint :refer [print-table]])\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n\n(defn desc [a b] ; nasao sam na guglu kako se sortira od najveceg ka najmanjem.\n  (compare b a))\n\n\n\n\n\n(defn leaderboard-rank-ties [db period date]\n  (let [users (db/get-all-users db)\n        users-with-xp (map (fn [user]\n                             {:user/username (:user/username user)\n                              :user/xp (db/xp-per-user db (:user/username user) period date)})\n                           users)\n        sorted-users-with-xp (sort-by :user/xp &gt; users-with-xp)\n        ]\n    (loop [users-left sorted-users-with-xp\n           result []\n           current-rank 1\n           prev-xp nil\n           same-count 0]\n      (if (empty? users-left)\n        result\n        (let [user (first users-left)\n              user-xp (:user/xp user)]\n          (if (= user-xp prev-xp)\n            (recur (rest users-left)\n                   (conj result (assoc user :rank current-rank))\n                   current-rank\n                   user-xp\n                   (inc same-count))\n            (let [new-rank (+ current-rank same-count)]\n              (recur (rest users-left)\n                     (conj result (assoc user :rank new-rank))\n                     new-rank\n                     user-xp\n                     1))))))))\n\n; leaderboard delta pokazuje koliko je koji user promenio rank\n(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     username)lb)]\n    names)\n  )\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(get-all-names old-lb)) new-names (set(get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n  )\n\n(defn leaderboard-delta [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             new-lb))]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n\n               {:user/username username\n                :delta (- old-r new-r)}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n             ))\n         (keys new-ranks)))\n\n(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n             (cond\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                :status :new}\n\n               (and old-r new-r)\n               {:user/username username\n                :delta (- old-r new-r)}\n\n               :else\n               {:user/username username\n                :delta 0})))\n         (keys new-ranks))))\n\n\n(defn leaderboard [db period date]\n\n  (let [\n        previous-date (case period\n                        :daily (.minusDays date 1)\n                        :weekly (.minusWeeks date 1)\n                        :monthly (.minusMonths date 1)\n                        date)\n        old-lb (leaderboard-rank-ties db period date)\n        new-lb (leaderboard-rank-ties db period previous-date)\n        delta (leaderboard-delta old-lb new-lb)\n        delta-map (into {} (map (fn [{:user/keys [username] :keys [delta]}]\n                                  [username delta])\n                                delta))\n        ]\n    (map (fn [user-rank]\n           (assoc user-rank :delta (get delta-map (:user/username user-rank) 0)))\n         new-lb)))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot;, :offset 4590, :ns &quot;project.core&quot;} {:command &quot;(ns project.db\n  (:require [datomic.api :as d]\n            [clojure.string :as str]\n            [project.time :as t]\n            [project.validation :as v]\n            [project.system :refer [conn]]\n            )\n  (:import (java.time LocalDate)))\n\n\n(defn create-user! [conn name]\n  (v/validate! v/CreateUserInput {:username name})\n  @(d/transact conn [{:user/username name\n                      :user/xp 0\n                      }]))\n\n(defn add-activity! [conn username activity-key duration intensity]\n  (v/validate! v/AddActivityInput {:username username\n                                   :activity-type activity-key\n                                   :duration duration\n                                   :intensity intensity})\n  @(d/transact conn [[:activity/add username activity-key duration intensity]]))\n\n\n(defn user-ids [db] (d/q '[:find ?e .\n                     :where [?e :user/username]] db))\n\n(defn get-all-users [db] (map first (d/q '[:find (pull ?e [*])\n                     :where [?e :user/username]] db)))\n\n(defn get-user-by-name [db username]\n  (let [result (d/pull db \&quot;[*]\&quot; [:user/username username])]\n    (if (:db/id result) result (throw (ex-info \&quot;User not found\&quot; {:user/username username})  ))\n    ))\n\n(defn get-user-activities [db username]\n  (d/q '[:find ?a-start-time ?a-type ?a-duration ?a-intensity ?xp-per-min\n         :in $ ?username\n         :where  [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?a-type]\n         [?a :activity/intensity ?a-intensity ]\n         [?a :activity/duration ?a-duration]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [?a :activity/start-time ?a-start-time ]\n         ] db username))\n\n(defn get-activities-in-interval\n  [db username start-day end-day]\n  (d/q '[:find ?start-time ?type-name ?dur ?int ?xp-per-min\n         :in $ ?username ?start ?end\n         :where\n         [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/start-time ?start-time]\n         [?a :activity/duration ?dur]\n         [?a :activity/intensity ?int]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?type-name]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [(&gt;= ?start-time ?start)]\n         [(&lt; ?start-time ?end)]]\n       db username start-day end-day))\n\n(defn calculate-xp-from-rows [rows]\n  (reduce (fn [total-xp [_ _ dur int xp-per-min]]\n            (+ total-xp (* dur int xp-per-min)))\n          0\n          rows))\n\n(def period-interval\n  {:daily t/day-interval\n   :weekly t/week-interval\n   :monthly t/month-interval\n   :all     nil})\n\n(defn add-xp [conn db username xp-to-add]\n  (let [[e current-xp]\n        (first (d/q '[:find ?e ?xp\n                      :in $ ?username\n                      :where [?e :user/username ?username]\n                      [?e :user/xp ?xp]\n                      ]\n                    db username))\n        new-xp (+ current-xp xp-to-add)]\n    @(d/transact conn [[:db/add e :user/xp new-xp]])\n    ))\n\n(def add-xp-tx {:db/ident :user/add-xp\n                :db/fn (d/function\n                         '{:lang \&quot;clojure\&quot;\n                          :params [db username xp]\n                          :code (let [[e current-xp]\n                                      (first (d/q '[:find ?e ?xp\n                                                    :in $ ?username\n                                                    :where [?e :user/username ?username]\n                                                    [?e :user/xp ?xp]\n                                                    ] db username))]\n                                  [[:db/add e :user/xp (+ current-xp xp)]])})})\n\n(def add-activity-tx\n  {:db/ident :activity/add\n   :db/fn (d/function\n            '{:lang \&quot;clojure\&quot;\n              :params [db username activity-type-key duration intensity]\n              :code (let [\n                          user-e\n                          (d/q '[:find ?e .\n                                 :in $ ?username\n                                 :where [?e :user/username ?username]]\n                               db username)\n                          [act-type-e xp-per-min]\n                          (first (d/q '[:find ?e ?xp-per-minute\n                                        :in $ ?type\n                                        :where [?e :activity-type/key ?type]\n                                        [?e :activity-type/xp-per-minute ?xp-per-minute]\n                                        ] db activity-type-key))\n                          gained-xp (* duration xp-per-min intensity)\n\n                          current-xp (or (:user/xp (d/entity db user-e)) 0)\n\n                          new-xp (+ current-xp gained-xp)\n                          activity-id (d/tempid :db.part/user)]\n                      [\n                       {:db/id activity-id\n                        :activity/user user-e\n                        :activity/type act-type-e\n                        :activity/duration duration\n                        :activity/intensity intensity\n                        :activity/start-time (java.util.Date.)\n                        }\n                       [:db/add user-e :user/xp new-xp\n                        ]])})})\n\n(def get-all-tx-functions [add-xp-tx add-activity-tx])\n\n(defn usernames-xp [db] (vec (d/q '[:find ?username ?xp\n                                    :where [?u :user/username ?username]\n                                    [?u :user/xp ?xp]] db)))\n\n(defn xp-per-user [db username period date]\n  ; slucaj kad je samo all\n  (if (= period :all)\n    (:user/xp (get-user-by-name db username))\n    ;---------------------\n    (let [{:keys [start-day end-day]} ((get period-interval period) date)\n          rows (get-activities-in-interval db username start-day end-day)]\n                        (calculate-xp-from-rows rows))))\n\n(defn report-daily-in-period [db username date]\n\n  ;total xp u danu\n  (let [{:keys [start-day end-day]} ((get period-interval :daily) date)\n        rows (get-activities-in-interval db username start-day end-day)\n        activities-xp (map (fn [[start-time a-type dur int xp-per-min]]\n                               {:activity/time (.toLocalTime (t/instant-&gt;local start-time))\n                                :activity/type a-type\n                                :activity/duration dur\n                                :activity/intensity int\n                                :activity/xp (* dur int xp-per-min)})rows)\n        total-xp (calculate-xp-from-rows rows)]\n\n    {\n     :date date\n     :username username\n     :activities activities-xp\n     :total-xp total-xp\n     }))\n\n(defn get-all-users)\n&quot;, :offset 6675, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n(def old-lb\n  [{:user/username \&quot;A\&quot; :rank 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])\n(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 1}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :rank 4}\n   ])\n(def users\n  [{:user/username \&quot;A\&quot; :user/xp 300}\n   {:user/username \&quot;B\&quot; :user/xp 200}\n    {:user/username \&quot;C\&quot; :user/xp 150}\n\n   ])\n()\n(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta 1 }\n      {:user/username \&quot;C\&quot; :delta 0 }]\n)\n(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; )\n\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(lb/get-all-names old-lb)) new-names (set(lb/get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n\n)\n\n(fact \&quot;test leaderboard unit fn\&quot;\n      (let []))\n\n\n\n&quot;, :offset 1409, :ns &quot;project.db&quot;} {:command &quot;(def old-lb\n  [{:user/username \&quot;A\&quot; :user/xp 1}\n   {:user/username \&quot;B\&quot; :user/xp 2}\n    {:user/username \&quot;C\&quot; :user/xp 3}\n   ])&quot;, :offset 123, :ns &quot;project.api-test&quot;} {:command &quot;(def new-lb\n  [{:user/username \&quot;A\&quot; :user/xp 2}\n   {:user/username \&quot;B\&quot; :user/xp 1}\n    {:user/username \&quot;C\&quot; :user/xp 3}\n   {:user/username \&quot;D\&quot; :user/xp 4}\n   ])&quot;, :offset 158, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; )&quot;, :offset 73, :ns &quot;project.api-test&quot;} {:command &quot;(def old-lb\n  [{:user/username \&quot;A\&quot; :user/xp 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])&quot;, :offset 117, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta 1 }\n      {:user/username \&quot;C\&quot; :delta 0 }]\n)&quot;, :offset 205, :ns &quot;project.api-test&quot;} {:command &quot;(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 1}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :rank 4}\n   ])&quot;, :offset 146, :ns &quot;project.api-test&quot;} {:command &quot;(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 4}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :rank 1}\n   ])&quot;, :offset 146, :ns &quot;project.api-test&quot;} {:command &quot;(def old-lb\n  [{:user/username \&quot;A\&quot; :rank 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])&quot;, :offset 114, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta-edge-case old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta 1 }\n      {:user/username \&quot;C\&quot; :delta 0 }]\n)&quot;, :offset 215, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n(let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                [username rank])\n                              old-lb))\n      new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                [username rank])\n                              new-lb))\n      new-users (set (new-user-check old-lb new-lb))\n      last-old-rank (if (seq old-ranks)\n                      (apply max (vals old-ranks))\n                      0)\n      ]\n    (fn [username]\n      (if (new-users username) username) false)))&quot;, :offset 350, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta-edge-case old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta -2 }\n      {:user/username \&quot;C\&quot; :delta 0 }\n      {:user/username \&quot;D\&quot; :delta 3 }]\n)&quot;, :offset 253, :ns &quot;project.api-test&quot;} {:command &quot;(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n             (cond\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                }\n\n               (and old-r new-r)\n               {:user/username username\n                :delta (- old-r new-r)}\n\n               :else\n               {:user/username username\n                :delta 0})))\n         (keys new-ranks))))&quot;, :offset 1090, :ns &quot;project.leaderboard&quot;} {:command &quot;(fn [old-lb new-lb]\n(let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                [username rank])\n                              old-lb))\n      new-users (set (new-user-check old-lb new-lb))\n      ]\n    (fn [username]\n      (if (new-users username) username false) )))&quot;, :offset 310, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.leaderboard\n  (:require [project.db :as db]\n            [datomic.api :as d]\n            [project.connection :refer [conn]]\n            [project.time :as t]\n            [clojure.pprint :refer [print-table]])\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n\n(defn desc [a b] ; nasao sam na guglu kako se sortira od najveceg ka najmanjem.\n  (compare b a))\n\n\n\n\n\n(defn leaderboard-rank-ties [db period date]\n  (let [users (db/get-all-users db)\n        users-with-xp (map (fn [user]\n                             {:user/username (:user/username user)\n                              :user/xp (db/xp-per-user db (:user/username user) period date)})\n                           users)\n        sorted-users-with-xp (sort-by :user/xp &gt; users-with-xp)\n        ]\n    (loop [users-left sorted-users-with-xp\n           result []\n           current-rank 1\n           prev-xp nil\n           same-count 0]\n      (if (empty? users-left)\n        result\n        (let [user (first users-left)\n              user-xp (:user/xp user)]\n          (if (= user-xp prev-xp)\n            (recur (rest users-left)\n                   (conj result (assoc user :rank current-rank))\n                   current-rank\n                   user-xp\n                   (inc same-count))\n            (let [new-rank (+ current-rank same-count)]\n              (recur (rest users-left)\n                     (conj result (assoc user :rank new-rank))\n                     new-rank\n                     user-xp\n                     1))))))))\n\n; leaderboard delta pokazuje koliko je koji user promenio rank\n(defn get-all-names [lb]\n  (let [names (map (fn [{:user/keys [username]}]\n                     username)lb)]\n    names)\n  )\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(get-all-names old-lb)) new-names (set(get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n  )\n\n(defn leaderboard-delta [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                               [username rank])\n                             new-lb))]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n\n               {:user/username username\n                :delta (- old-r new-r)}\n               {:user/username username\n                :delta (- old-r new-r)}\n               )\n             ))\n         (keys new-ranks)))\n\n(defn leaderboard-delta-edge-case [old-lb new-lb]\n  (let [old-ranks (into {} (map (fn[{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                old-lb))\n        new-ranks (into {} (map (fn [{:user/keys [username] :keys [rank]}]\n                                  [username rank])\n                                new-lb))\n        new-users (set (new-user-check old-lb new-lb))\n        last-old-rank (if (seq old-ranks)\n                        (apply max (vals old-ranks))\n                        0)\n        ]\n    (map (fn [username]\n           (let [old-r (get old-ranks username)\n                 new-r (get new-ranks username)]\n             (cond\n               (new-users username)\n               {:user/username username\n                :delta (- (inc last-old-rank) new-r)\n                }\n\n               (and old-r new-r)\n               {:user/username username\n                :delta (- old-r new-r)}\n\n               :else\n               {:user/username username\n                :delta 0})))\n         (keys new-ranks))))\n\n\n(defn leaderboard [db period date]\n\n  (let [\n        previous-date (case period\n                        :daily (.minusDays date 1)\n                        :weekly (.minusWeeks date 1)\n                        :monthly (.minusMonths date 1)\n                        date)\n        old-lb (leaderboard-rank-ties db period date)\n        new-lb (leaderboard-rank-ties db period previous-date)\n        delta (leaderboard-delta old-lb new-lb)\n        delta-map (into {} (map (fn [{:user/keys [username] :keys [delta]}]\n                                  [username delta])\n                                delta))\n        ]\n    (map (fn [user-rank]\n           (assoc user-rank :delta (get delta-map (:user/username user-rank) 0)))\n         new-lb)))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot;, :offset 4578, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId)))\n\n(def old-lb\n  [{:user/username \&quot;A\&quot; :rank 1}\n   {:user/username \&quot;B\&quot; :rank 2}\n    {:user/username \&quot;C\&quot; :rank 3}\n   ])\n(def new-lb\n  [{:user/username \&quot;A\&quot; :rank 2}\n   {:user/username \&quot;B\&quot; :rank 4}\n    {:user/username \&quot;C\&quot; :rank 3}\n   {:user/username \&quot;D\&quot; :rank 1}\n   ])\n(def users\n  [{:user/username \&quot;A\&quot; :user/xp 300}\n   {:user/username \&quot;B\&quot; :user/xp 200}\n    {:user/username \&quot;C\&quot; :user/xp 150}\n\n   ])\n()\n(fact \&quot;test delta funkcije\&quot;\n  (let [delta (lb/leaderboard-delta-edge-case old-lb new-lb)]\n    delta)\n  =&gt; [{:user/username \&quot;A\&quot; :delta -1 }\n      {:user/username \&quot;B\&quot; :delta -2 }\n      {:user/username \&quot;C\&quot; :delta 0 }\n      {:user/username \&quot;D\&quot; :delta 3 }]\n)\n\n(fact \&quot;New user check\&quot;\n      (lb/new-user-check old-lb new-lb)\n      =&gt; )\n\n(defn new-user-check [old-lb new-lb]\n  (let [old-names (set(lb/get-all-names old-lb)) new-names (set(lb/get-all-names new-lb))]\n    (filter (complement old-names) new-names))\n\n)\n\n(fact \&quot;test leaderboard unit fn\&quot;\n      (let []))\n\n\n\n&quot;, :offset 1458, :ns &quot;project.leaderboard&quot;} {:command &quot;(def fake-db\n  {:users\n   users})&quot;, :offset 33, :ns &quot;project.api-test&quot;} {:command &quot;fake-db&quot;, :offset 7, :ns &quot;project.api-test&quot;} {:command &quot;(fact \&quot;test leaderboard unit fn\&quot;\n      (let [db fake-db\n            ]\n        (lb/leaderboard-rank-ties db :all (LocalDate/now)))\n      =&gt; {:users [#:user {:username \&quot;A\&quot;, :xp 300}\n                  #:user {:username \&quot;B\&quot;, :xp 200}\n                  #:user {:username \&quot;C\&quot;, :xp 150}]}\n      )&quot;, :offset 289, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            \n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId))\n  (:use 'clojure.test))&quot;, :offset 536, :ns &quot;project.api-test&quot;} {:command &quot;(ns project.api-test\n  (:require [midje.sweet :refer :all]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed]\n            [project.api :as api]\n            \n            )\n  (:import (java.time.temporal TemporalAdjusters)\n           (java.util Date)\n           (java.time ZonedDateTime LocalDate ZoneId)\n           (java.time Instant LocalDate DayOfWeek MonthDay YearMonth ZoneId))\n  (:use clojure.test))&quot;, :offset 535, :ns &quot;project.api-test&quot;} {:command &quot;(deftest leaderboard-rank-ties-test\n  (with-redefs\n    [db/get-all-users\n     (fn [_] [{:user/username \&quot;A\&quot; :user/xp 300}\n              {:user/username \&quot;B\&quot; :user/xp 200}\n              {:user/username \&quot;C\&quot; :user/xp 150}\n              ])\n     db/xp-per-user\n     (fn [_ username _ _]\n       ({\&quot;A\&quot; 300\n         \&quot;B\&quot; 200\n         \&quot;C\&quot; 150} username))]\n    (let [result (lb/leaderboard-rank-ties nil :daily nil)]\n      (is (= result\n             [{:user/username \&quot;A\&quot; :user/xp 300 :rank 1}\n              {:user/username \&quot;B\&quot; :user/xp 200 :rank 2}\n              {:user/username \&quot;C\&quot; :user/xp 150  :rank 3}])))))&quot;, :offset 598, :ns &quot;project.api-test&quot;} {:command &quot;(deftest leaderboard-rank-ties-test\n  (with-redefs\n    [project.db/get-all-users\n     (fn [_]\n       [{:user/username \&quot;A\&quot;}\n        {:user/username \&quot;B\&quot;}\n        {:user/username \&quot;C\&quot;}])\n\n     project.db/xp-per-user\n     (fn [_ username _ _]\n       ({\&quot;A\&quot; 300 \&quot;B\&quot; 200 \&quot;C\&quot; 150} username))]\n\n    (is (= (lb/leaderboard-rank-ties ::db :daily ::date)\n           [{:user/username \&quot;A\&quot; :user/xp 300 :rank 1}\n            {:user/username \&quot;B\&quot; :user/xp 200 :rank 2}\n            {:user/username \&quot;C\&quot; :user/xp 150 :rank 3}]))))&quot;, :offset 508, :ns &quot;project.api-test&quot;} {:command &quot;(leaderboard-rank-ties-test)&quot;, :offset 27, :ns &quot;project.api-test&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n          )\n  )&quot;, :offset 197, :ns &quot;project.core&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n          )\n  )\n(def port 3000)\n\n(defn home-page [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5\n           [:head\n            [:title \&quot;BeBetter\&quot;]\n           [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]]\n           [:body\n            [:h1 \&quot;BeBetter - Početna\&quot;]\n            [:p \&quot;Dobrodošao, ovo je tvoj prvi HTML iz Clojure-a!\&quot;]\n            [:button {:hx-post \&quot;/klik\&quot; :hx-swap \&quot;outerHTML\&quot;} \&quot;Klikni me\&quot;]])})\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                                   [\&quot;/\&quot; {:get home-page}]\n                                    [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server [atom nil])\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n&quot;, :offset 1238, :ns &quot;web.server&quot;} {:command &quot;(in-ns 'web.server)(in-ns 'web.server)&quot;, :offset 38, :ns &quot;web.server&quot;} {:command &quot;(in-ns 'web.server)\n(start-server)&quot;, :offset 18, :ns &quot;web.server&quot;} {:command &quot;(in-ns \n  web.server)&quot;, :offset 10, :ns &quot;web.server&quot;} {:command &quot;(in-ns web.server)&quot;, :offset 17, :ns &quot;web.server&quot;} {:command &quot;(defonce server (atom nil))&quot;, :offset 27, :ns &quot;web.server&quot;} {:command &quot;(in-ns 'web.server)&quot;, :offset 8, :ns &quot;web.server&quot;} {:command &quot;(def server (atom nil))&quot;, :offset 23, :ns &quot;web.server&quot;} {:command &quot;(defn leaderboard [db period date]\n\n  (let [\n        previous-date (case period\n                        :daily (.minusDays date 1)\n                        :weekly (.minusWeeks date 1)\n                        :monthly (.minusMonths date 1)\n                        date)\n        old-lb (leaderboard-rank-ties db period date)\n        new-lb (leaderboard-rank-ties db period previous-date)\n        delta (leaderboard-delta-edge-case old-lb new-lb)\n        delta-map (into {} (map (fn [{:user/keys [username] :keys [delta]}]\n                                  [username delta])\n                                delta))\n        ]\n    (map (fn [user-rank]\n           (assoc user-rank :delta (get delta-map (:user/username user-rank) 0)))\n         new-lb)))&quot;, :offset 747, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn leaderboard [db period date]\n\n  (let [\n        previous-date (case period\n                        :daily (.minusDays date 1)\n                        :weekly (.minusWeeks date 1)\n                        :monthly (.minusMonths date 1)\n                        date)\n        old-lb (leaderboard-rank-ties db period previous-date)\n        new-lb (leaderboard-rank-ties db period date)\n        delta (leaderboard-delta-edge-case old-lb new-lb)\n        delta-map (into {} (map (fn [{:user/keys [username] :keys [delta]}]\n                                  [username delta])\n                                delta))\n        ]\n    (map (fn [user-rank]\n           (assoc user-rank :delta (get delta-map (:user/username user-rank) 0)))\n         new-lb)))&quot;, :offset 747, :ns &quot;project.leaderboard&quot;} {:command &quot;(defn get-leaderboard\n  \&quot;Leaderboard prima :daily, :weekly, :monthly, :all\&quot;\n  [period date]\n  (v/validate! v/Period period)\n  (lb/leaderboard (d/db conn) period date)\n  )&quot;, :offset 170, :ns &quot;project.api&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n            )\n  (:import (java.time LocalDate)))\n\n(def port 3000)\n(defn common-layout [content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }\n              table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }\&quot;]]\n    [:body\n     [:h1 \&quot;BeBetter\&quot;]\n     [:hr]\n     content]\n    ))\n(defn leaderboard-table [data]\n  [:div\n   [:h2 \&quot;Rank list \&quot;]\n   [:table\n    [:thead\n     [:tr\n      [:th \&quot;Rank\&quot;]\n      [:th \&quot;Username\&quot;]\n      [:th \&quot;XP\&quot;]\n      [:th \&quot;Delta\&quot;]]]\n    [:tbody\n     (for [user data]\n       [:tr\n        [:td (:rank user)]\n        [:td (:user/username user)]\n        [:td (:user/xp user)]\n        [:td (let [d (:delta user)]\n               (cond\n                 (pos? d) [:span {:style \&quot;color:green\&quot;} (str \&quot;▲ \&quot; d)]\n                 (neg? d) [:span {:style \&quot;color:red\&quot;} (str \&quot;▼ \&quot; (Math/abs d))]\n                 :else    [:span {:style \&quot;color:gray\&quot;} \&quot;-\&quot;]))]\n\n        ])]\n    ]]\n  )\n(defn home-page [request]\n\n  (let [leaderboard-data (api/get-leaderboard :all (LocalDate/now))]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (common-layout (leaderboard-table leaderboard-data))}))\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 2847, :ns &quot;web.server&quot;} {:command &quot;(defn home-page [request]\n\n  (let [leaderboard-data (api/get-leaderboard :weekly (LocalDate/now))]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (common-layout (leaderboard-table leaderboard-data))}))&quot;, :offset 219, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n            )\n  (:import (java.time LocalDate)))\n\n(def port 3000)\n(defn common-layout [content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }\n              table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }\&quot;]]\n    [:body\n     [:h1 \&quot;BeBetter\&quot;]\n     [:hr]\n     content]\n    ))\n(defn leaderboard-table [data]\n  [:div\n   [:h2 \&quot;Rank list \&quot;]\n   [:table\n    [:thead\n     [:tr\n      [:th \&quot;Rank\&quot;]\n      [:th \&quot;Username\&quot;]\n      [:th \&quot;XP\&quot;]\n      [:th \&quot;Delta\&quot;]]]\n    [:tbody\n     (for [user data]\n       [:tr\n        [:td (:rank user)]\n        [:td (:user/username user)]\n        [:td (:user/xp user)]\n        [:td (let [d (:delta user)]\n               (cond\n                 (pos? d) [:span {:style \&quot;color:green\&quot;} (str \&quot;▲ \&quot; d)]\n                 (neg? d) [:span {:style \&quot;color:red\&quot;} (str \&quot;▼ \&quot; (Math/abs d))]\n                 :else    [:span {:style \&quot;color:gray\&quot;} \&quot;-\&quot;]))]\n\n        ])]\n    ]]\n  )\n(defn home-page [request]\n\n  (let [leaderboard-data (api/get-leaderboard :weekly (LocalDate/now))]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (common-layout (leaderboard-table leaderboard-data))}))\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 2850, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n            )\n  (:import (java.time LocalDate)))\n\n(def port 3000)\n(defn common-layout [content current-page]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;\n              body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont,\n              'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #fafafa;\n             display: flex; height: 100vh; overflow: hidden; }\n\n     /* SIDEBAR (Instagram style) */\n             .sidebar { width: 245px; background: white; border-right: 1px solid #dbdbdb;\n             display: flex; flex-direction: column; padding: 20px 10px; flex-shrink: 0; }\n             .logo { font-size: 24px; font-weight: bold; margin-bottom: 40px; padding-left:15px;\n             font-family: 'Cursive', serif; } /* Simulira Instagram logo font */\n\n             .nav-link { display: flex; align-items: center; padding: 12px 15px;\n             color: #000; text-decoration: none; border-radius: 8px; margin-bottom: 5px;\n             transition: background 0.2s; font-size: 16px; }\n             .nav-link:hover { background-color: #f2f2f2; }\n             .nav-link.active { font-weight: bold; }\n             .nav-link span { margin-left: 15px; }\n             .icon { width: 24px; height: 24px; display: inline-block; }\n\n     /* MAIN CONTENT AREA */\n             .main-content { flex-grow: 1; overflow-y: auto; padding: 30px; display: flex;\n             justify-content: center; }\n             .container { width: 100%; max-width: 900px; }\n\n             .calendar-container { border: 1px solid #ddd; background: white; border-radius: 8px;\n             display: flex; flex-direction: column; height: 80vh; }\n             .calendar-header { padding: 15px; border-bottom: 1px solid #ddd; text-align: center;\n             font-weight: bold; font-size: 18px; }\n             .calendar-body { display: grid; grid-template-columns: 60px 1fr; overflow-y: auto;\n             height: 100%; position: relative; }\n\n     /* Time Labels (00:00, 01:00...) */\n             .time-labels { border-right: 1px solid #eee; }\n             .time-label { height: 60px; text-align: right; padding-right: 10px; font-size: 12px; color: #888;\n              position: relative; top: -6px; }\n\n     /* The Grid */\n              .day-column { position: relative; background: repeating-linear-gradient(to bottom,\n              transparent 0px, transparent 59px, #eee 60px); }\n     /* Time Slot (Clickable area) */\n              .time-slot-trigger { height: 60px; width: 100%; cursor: pointer;\n              transition: background 0.1s; }\n              .time-slot-trigger:hover { background-color: rgba(0, 123, 255, 0.1); }\n     /* Actual Activities on Calendar */\n              .calendar-event { position: absolute; left: 5px; right: 5px; background-color: #3788d8;\n              color: white; border-radius: 4px; padding: 4px; font-size: 12px; overflow: hidden;\n              cursor: pointer; border-left: 4px solid #2c6aa8; }\n     /* MODAL (Za dodavanje) */\n              .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n              background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;\n              z-index: 1000; }\n              .modal { background: white; padding: 20px; border-radius: 8px; width: 400px;\n              box-shadow: 0 4px 10px rgba(0,0,0,0.2); }\n              .form-group { margin-bottom: 15px; }\n              .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }\n              .form-group input, .form-group select { width: 100%; padding: 8px;\n              border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}\n\n              table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }\&quot;]]\n    [:body\n     ;; --- SIDEBAR ---\n     [:nav.sidebar\n      [:div.logo \&quot;BeBetter\&quot;]\n      ;; Linkovi (koriste obican href jer menjamo celu stranicu, ili hx-get za SPA osecaj)\n      [:a.nav-link {:href \&quot;/planner\&quot; :class (when (= current-page :planner) \&quot;active\&quot;)}\n       [:span \&quot;📅\&quot;] [:span \&quot;Activities\&quot;]]\n\n      [:a.nav-link {:href \&quot;/leaderboard\&quot; :class (when (= current-page :leaderboard) \&quot;active\&quot;)}\n       [:span \&quot;🏆\&quot;] [:span \&quot;Leaderboard\&quot;]]\n\n      [:a.nav-link {:href \&quot;/search\&quot; :class (when (= current-page :search) \&quot;active\&quot;)}\n       [:span \&quot;🔍\&quot;] [:span \&quot;Search\&quot;]]\n\n      [:a.nav-link {:href \&quot;/profile\&quot; :class (when (= current-page :profile) \&quot;active\&quot;)}\n       [:span \&quot;👤\&quot;] [:span \&quot;My Profile\&quot;]]]\n\n     ;; --- MAIN CONTENT ---\n     [:main.main-content\n      [:div.container\n       content]]\n\n     ;; Mesto za modal koji će se ubaciti preko HTMX-a\n     [:div#modal-container]]))\n\n(defn planner-page [request]\n  (let [today (java.time.LocalDate/now)\n        ;; Ovde bismo pozvali API da dobijemo aktivnosti za danas\n        ;; Za sada fake data da vidis kako izgleda\n        activities [{:start 10.5 :duration 1.5 :title \&quot;Trening\&quot;}\n                    {:start 14.0 :duration 2.0 :title \&quot;Učenje\&quot;}]]\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (common-layout\n             [:div.calendar-container\n              [:div.calendar-header (str \&quot;Planer za \&quot; today)]\n              [:div.calendar-body\n               ;; Leva kolona (sati)\n               [:div.time-labels\n                (for [h (range 24)]\n                  [:div.time-label (str (format \&quot;%02d\&quot; h) \&quot;:00\&quot;)])]\n\n               ;; Desna kolona (Grid + Events)\n               [:div.day-column\n                ;; 1. Iscrtaj \&quot;okidače\&quot; za svaki sat (prazna polja)\n                (for [h (range 24)]\n                  ;; Na klik šaljemo zahtev serveru da nam vrati formu za taj sat\n                  [:div.time-slot-trigger\n                   {:hx-get (str \&quot;/modal/add-activity?hour=\&quot; h)\n                    :hx-target \&quot;#modal-container\&quot;\n                    :hx-swap \&quot;innerHTML\&quot;}])\n\n                ;; 2. Iscrtaj POSTOJEĆE aktivnosti (kao absolute div-ovi)\n                (for [act activities]\n                  (let [top (* (:start act) 60)       ;; 1h = 60px\n                        height (* (:duration act) 60)]\n                    [:div.calendar-event\n                     {:style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n                     (:title act)\n                     [:br]\n                     [:small (str (:duration act) \&quot;h\&quot;)]]))\n                ]]]\n             :planner)}))\n(defn add-activity-modal [request]\n  (let [hour-str (get-in request [:params :hour])\n        hour (Integer/parseInt hour-str)\n        ;; Formatiramo vreme za input type=\&quot;time\&quot; (HH:mm)\n        start-time-str (str (format \&quot;%02d\&quot; hour) \&quot;:00\&quot;)\n        ;; Default kraj je za sat vremena\n        end-time-str   (str (format \&quot;%02d\&quot; (inc hour)) \&quot;:00\&quot;)]\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (html5\n             [:div.modal-overlay {:_ \&quot;on click self.remove()\&quot;} ;; Klik sa strane zatvara (hyperscript pseudo-kod, ili htmx remove)\n              [:div.modal {:onclick \&quot;event.stopPropagation()\&quot;} ;; Klik na modal ne zatvara\n               [:h3 \&quot;Dodaj Aktivnost\&quot;]\n\n               [:form {:hx-post \&quot;/activity\&quot;\n                       :hx-swap \&quot;none\&quot; ;; Za sad ne radimo nista, posle cemo refresh\n                       :onsubmit \&quot;setTimeout(()=&gt;window.location.reload(), 100)\&quot;} ;; Hack za refresh stranice\n\n                ;; Hidden polje za korisnika (hardkodovano za demo)\n                [:input {:type \&quot;hidden\&quot; :name \&quot;username\&quot; :value \&quot;Micko\&quot;}]\n\n                ;; Tip Aktivnosti\n                [:div.form-group\n                 [:label \&quot;Tip Aktivnosti\&quot;]\n                 [:select {:name \&quot;activity-key\&quot;}\n                  [:option {:value \&quot;training\&quot;} \&quot;Trening\&quot;]\n                  [:option {:value \&quot;study\&quot;} \&quot;Učenje\&quot;]\n                  [:option {:value \&quot;coding\&quot;} \&quot;Programiranje\&quot;]\n                  [:option {:value \&quot;hobby\&quot;} \&quot;Hobi\&quot;]]]\n\n                ;; Vreme (Start i End)\n                [:div.form-group\n                 [:label \&quot;Početak\&quot;]\n                 [:input {:type \&quot;time\&quot; :name \&quot;start_time\&quot; :value start-time-str :required true}]]\n\n                [:div.form-group\n                 [:label \&quot;Kraj (Minutaža se računa automatski)\&quot;]\n                 [:input {:type \&quot;time\&quot; :name \&quot;end_time\&quot; :value end-time-str :required true}]]\n\n                ;; Intenzitet\n                [:div.form-group\n                 [:label \&quot;Intenzitet (1-5)\&quot;]\n                 [:input {:type \&quot;range\&quot; :name \&quot;intensity\&quot; :min \&quot;1\&quot; :max \&quot;5\&quot; :value \&quot;3\&quot;\n                          :oninput \&quot;this.nextElementSibling.value = this.value\&quot;} ]\n                 [:output \&quot;3\&quot;]]\n\n                [:div {:style \&quot;display: flex; justify-content: flex-end; gap: 10px;\&quot;}\n                 [:button.btn {:type \&quot;button\&quot; :onclick \&quot;document.querySelector('.modal-overlay').remove()\&quot;} \&quot;Otkaži\&quot;]\n                 [:button.btn {:type \&quot;submit\&quot;} \&quot;Sačuvaj\&quot;]]]]])}))\n\n(defn save-activity-handler [request]\n  (let [params (:params request)\n        username (:username params)\n        activity-key (keyword (:activity-key params))\n        intensity (Integer/parseInt (:intensity params))\n\n        ;; Računanje trajanja\n        start-str (:start_time params) ; \&quot;14:00\&quot;\n        end-str   (:end_time params)   ; \&quot;15:30\&quot;\n\n        start-local (java.time.LocalTime/parse start-str)\n        end-local   (java.time.LocalTime/parse end-str)\n\n        ;; Razlika u minutima\n        duration (.toMinutes (java.time.Duration/between start-local end-local))]\n\n    (if (pos? duration)\n      (do\n        ;; Pozivamo tvoj API!\n        (project.api/log-activity! username activity-key duration intensity)\n        {:status 200 :body \&quot;OK\&quot;})\n\n      {:status 400 :body \&quot;Kraj mora biti posle početka!\&quot;})))\n\n(defn leaderboard-table [data]\n  [:div\n   [:h2 \&quot;Rank list \&quot;]\n   [:table\n    [:thead\n     [:tr\n      [:th \&quot;Rank\&quot;]\n      [:th \&quot;Username\&quot;]\n      [:th \&quot;XP\&quot;]\n      [:th \&quot;Delta\&quot;]]]\n    [:tbody\n     (for [user data]\n       [:tr\n        [:td (:rank user)]\n        [:td (:user/username user)]\n        [:td (:user/xp user)]\n        [:td (let [d (:delta user)]\n               (cond\n                 (pos? d) [:span {:style \&quot;color:green\&quot;} (str \&quot;▲ \&quot; d)]\n                 (neg? d) [:span {:style \&quot;color:red\&quot;} (str \&quot;▼ \&quot; (Math/abs d))]\n                 :else    [:span {:style \&quot;color:gray\&quot;} \&quot;-\&quot;]))]\n\n        ])]\n    ]]\n  )\n(defn home-page [request]\n\n  (let [leaderboard-data (api/get-leaderboard :weekly (LocalDate/now))]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (common-layout (leaderboard-table leaderboard-data))}))\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n(def app\n  (ring/ring-handler\n    (ring/router\n      [\n       [\&quot;/planner\&quot; {:get planner-page}]\n       [\&quot;/leaderboard\&quot; {:get (fn [req]\n                               {:status 200\n                                :body (common-layout (leaderboard-table (api/get-leaderboard :all)) :leaderboard)})}]\n\n       ;; Rute za modal i čuvanje\n       [\&quot;/modal/add-activity\&quot; {:get add-activity-modal}]\n       [\&quot;/activity\&quot; {:post save-activity-handler}]\n\n       ;; Ostalo (placeholders)\n       [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}] ;; Redirect na planner\n       [\&quot;/search\&quot; {:get (fn [_] {:status 200 :body (common-layout [:h1 \&quot;Search - U izradi\&quot;] :search)})}]\n       [\&quot;/profile\&quot; {:get (fn [_] {:status 200 :body (common-layout [:h1 \&quot;Profil - U izradi\&quot;] :profile)})}]\n       ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 12666, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n            )\n  (:import (java.time LocalDate)))\n\n(def port 3000)\n(defn common-layout [content current-page]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;\n              body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont,\n              'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #fafafa;\n             display: flex; height: 100vh; overflow: hidden; }\n\n     /* SIDEBAR (Instagram style) */\n             .sidebar { width: 245px; background: white; border-right: 1px solid #dbdbdb;\n             display: flex; flex-direction: column; padding: 20px 10px; flex-shrink: 0; }\n             .logo { font-size: 24px; font-weight: bold; margin-bottom: 40px; padding-left:15px;\n             font-family: 'Cursive', serif; } /* Simulira Instagram logo font */\n\n             .nav-link { display: flex; align-items: center; padding: 12px 15px;\n             color: #000; text-decoration: none; border-radius: 8px; margin-bottom: 5px;\n             transition: background 0.2s; font-size: 16px; }\n             .nav-link:hover { background-color: #f2f2f2; }\n             .nav-link.active { font-weight: bold; }\n             .nav-link span { margin-left: 15px; }\n             .icon { width: 24px; height: 24px; display: inline-block; }\n\n     /* MAIN CONTENT AREA */\n             .main-content { flex-grow: 1; overflow-y: auto; padding: 30px; display: flex;\n             justify-content: center; }\n             .container { width: 100%; max-width: 900px; }\n\n             .calendar-container { border: 1px solid #ddd; background: white; border-radius: 8px;\n             display: flex; flex-direction: column; height: 80vh; }\n             .calendar-header { padding: 15px; border-bottom: 1px solid #ddd; text-align: center;\n             font-weight: bold; font-size: 18px; }\n             .calendar-body { display: grid; grid-template-columns: 60px 1fr; overflow-y: auto;\n             height: 100%; position: relative; }\n\n     /* Time Labels (00:00, 01:00...) */\n             .time-labels { border-right: 1px solid #eee; }\n             .time-label { height: 60px; text-align: right; padding-right: 10px; font-size: 12px; color: #888;\n              position: relative; top: -6px; }\n\n     /* The Grid */\n              .day-column { position: relative; background: repeating-linear-gradient(to bottom,\n              transparent 0px, transparent 59px, #eee 60px); }\n     /* Time Slot (Clickable area) */\n              .time-slot-trigger { height: 60px; width: 100%; cursor: pointer;\n              transition: background 0.1s; }\n              .time-slot-trigger:hover { background-color: rgba(0, 123, 255, 0.1); }\n     /* Actual Activities on Calendar */\n              .calendar-event { position: absolute; left: 5px; right: 5px; background-color: #3788d8;\n              color: white; border-radius: 4px; padding: 4px; font-size: 12px; overflow: hidden;\n              cursor: pointer; border-left: 4px solid #2c6aa8; }\n     /* MODAL (Za dodavanje) */\n              .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n              background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;\n              z-index: 1000; }\n              .modal { background: white; padding: 20px; border-radius: 8px; width: 400px;\n              box-shadow: 0 4px 10px rgba(0,0,0,0.2); }\n              .form-group { margin-bottom: 15px; }\n              .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }\n              .form-group input, .form-group select { width: 100%; padding: 8px;\n              border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}\n\n              table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n              th { background-color: #f2f2f2; }\n              .btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }\&quot;]]\n    [:body\n     [:h1 \&quot;BeBetter\&quot;]\n     [:hr]\n     content]\n    ))\n(defn leaderboard-table [data]\n  [:div\n   [:h2 \&quot;Rank list \&quot;]\n   [:table\n    [:thead\n     [:tr\n      [:th \&quot;Rank\&quot;]\n      [:th \&quot;Username\&quot;]\n      [:th \&quot;XP\&quot;]\n      [:th \&quot;Delta\&quot;]]]\n    [:tbody\n     (for [user data]\n       [:tr\n        [:td (:rank user)]\n        [:td (:user/username user)]\n        [:td (:user/xp user)]\n        [:td (let [d (:delta user)]\n               (cond\n                 (pos? d) [:span {:style \&quot;color:green\&quot;} (str \&quot;▲ \&quot; d)]\n                 (neg? d) [:span {:style \&quot;color:red\&quot;} (str \&quot;▼ \&quot; (Math/abs d))]\n                 :else    [:span {:style \&quot;color:gray\&quot;} \&quot;-\&quot;]))]\n\n        ])]\n    ]]\n  )\n(defn home-page [request]\n\n  (let [leaderboard-data (api/get-leaderboard :weekly (LocalDate/now))]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (common-layout (leaderboard-table leaderboard-data))}))\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 6279, :ns &quot;project.core&quot;} {:command &quot;(start-server\n  )&quot;, :offset 16, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [hiccup.page :refer [html5]]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str])\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)))\n\n;; --- POMOĆNE FUNKCIJE ZA VREME ---\n\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date] (.plusDays date 1))\n(defn get-prev-day [date] (.minusDays date 1))\n\n(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)]\n    (+ (* hour 60) minute)))\n\n;; --- LAYOUT I STILOVI ---\n\n(defn common-layout [content current-page]\n  (html5\n    [:head\n     [:title \&quot;BeBetter Planner\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;\n        /* OSNOVNO */\n        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; display: flex; height: 100vh; overflow: hidden; }\n\n        /* SIDEBAR */\n        .sidebar { width: 250px; background: white; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }\n        .logo { font-size: 28px; font-weight: 900; margin-bottom: 40px; color: #000; letter-spacing: -1px; } /* Tvoj debeli logo */\n\n        .nav-link { display: flex; align-items: center; padding: 15px; color: #333; text-decoration: none; border-radius: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 500; transition: 0.2s; }\n        .nav-link:hover { background-color: #f0f0f0; }\n        .nav-link.active { font-weight: bold; background-color: #eefec3; } /* Malo boje za aktivni tab */\n        .nav-link span { margin-right: 15px; }\n\n        /* CONTENT */\n        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }\n\n        /* PLANNER HEADER (DATE SCROLL) */\n        .planner-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 20px; background: white; z-index: 10; }\n        .date-nav-btn { text-decoration: none; font-size: 24px; color: #555; padding: 5px 15px; border-radius: 50%; }\n        .date-nav-btn:hover { background-color: #eee; }\n        .current-date-title { font-size: 20px; font-weight: bold; min-width: 250px; text-align: center; }\n\n        /* CALENDAR GRID */\n        .calendar-body { display: flex; overflow-y: auto; height: 100%; position: relative; scroll-behavior: smooth; }\n        .time-labels { width: 60px; flex-shrink: 0; border-right: 1px solid #eee; background: #fafafa; }\n        .time-label { height: 60px; border-bottom: 1px solid #eee; font-size: 12px; color: #999; text-align: right; padding-right: 8px; padding-top: 5px; box-sizing: border-box; }\n\n        .day-column { flex-grow: 1; position: relative; background:\n            repeating-linear-gradient(to bottom, transparent 0px, transparent 59px, #f0f0f0 60px);\n            height: 1440px; /* 24h * 60px */ cursor: crosshair; }\n\n        /* AKTIVNOST NA KALENDARU */\n        .calendar-event {\n            position: absolute;\n            left: 5px; right: 10px;\n            background-color: #4CAF50;\n            color: white;\n            border-radius: 6px;\n            padding: 5px;\n            font-size: 13px;\n            overflow: hidden;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n            border-left: 5px solid #2E7D32;\n            z-index: 2;\n        }\n\n        /* SELEKCIJA (JS DYNAMIC) */\n        #selection-box {\n            position: absolute;\n            background: rgba(76, 175, 80, 0.3);\n            border: 2px dashed #4CAF50;\n            width: 95%;\n            left: 2.5%;\n            display: none;\n            pointer-events: none;\n            z-index: 1;\n        }\n\n        /* MODAL */\n        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }\n        .modal { background: white; padding: 25px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }\n        .form-group { margin-bottom: 15px; }\n        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }\n        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }\n        .btn { width: 100%; padding: 12px; background: #000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }\n        .btn-cancel { background: #ccc; margin-top: 10px; color: #333; }\n     \&quot;]]\n\n    [:body\n     ;; --- SIDEBAR ---\n     [:nav.sidebar\n      [:div.logo \&quot;BeBetter\&quot;]\n      [:a.nav-link {:href \&quot;/planner\&quot; :class (when (= current-page :planner) \&quot;active\&quot;)}\n       [:span \&quot;📅\&quot;] \&quot;Planer\&quot;]\n      [:a.nav-link {:href \&quot;/leaderboard\&quot; :class (when (= current-page :leaderboard) \&quot;active\&quot;)}\n       [:span \&quot;🏆\&quot;] \&quot;Rang Lista\&quot;]\n      [:a.nav-link {:href \&quot;/search\&quot;} [:span \&quot;🔍\&quot;] \&quot;Pretraga\&quot;]\n      [:a.nav-link {:href \&quot;/profile\&quot;} [:span \&quot;👤\&quot;] \&quot;Moj Profil\&quot;]]\n\n     ;; --- CONTENT ---\n     [:main.main-content\n      content\n      [:div#modal-container]]\n\n     ;; --- JAVASCRIPT ZA DRAG-AND-DROP ---\n     [:script \&quot;\n        document.addEventListener('DOMContentLoaded', function() {\n            const grid = document.querySelector('.day-column');\n            if(!grid) return;\n\n            let isDragging = false;\n            let startY = 0;\n            let currentY = 0;\n            const selection = document.createElement('div');\n            selection.id = 'selection-box';\n            grid.appendChild(selection);\n\n            grid.addEventListener('mousedown', function(e) {\n                if(e.target.classList.contains('calendar-event')) return; // Ne selektuj preko postojecih\n                isDragging = true;\n                const rect = grid.getBoundingClientRect();\n                startY = e.clientY - rect.top + grid.scrollTop;\n\n                // Snap to 15 mins (15px)\n                startY = Math.floor(startY / 15) * 15;\n\n                selection.style.top = startY + 'px';\n                selection.style.height = '0px';\n                selection.style.display = 'block';\n            });\n\n            grid.addEventListener('mousemove', function(e) {\n                if (!isDragging) return;\n                const rect = grid.getBoundingClientRect();\n                let y = e.clientY - rect.top + grid.scrollTop;\n\n                let height = y - startY;\n                if(height &lt; 15) height = 15; // Minimum 15 min\n\n                selection.style.height = height + 'px';\n            });\n\n            grid.addEventListener('mouseup', function(e) {\n                if (!isDragging) return;\n                isDragging = false;\n\n                // Izračunaj vreme na osnovu piksela (1px = 1min)\n                // Ali posto smo stavili 60px = 1h, onda je 1px = 1minuta.\n\n                const height = parseInt(selection.style.height);\n                const startMin = startY;\n                const endMin = startY + height;\n\n                // Konvertuj u HH:mm\n                const formatTime = (minutes) =&gt; {\n                    let h = Math.floor(minutes / 60);\n                    let m = Math.floor(minutes % 60);\n                    return (h &lt; 10 ? '0'+h : h) + ':' + (m &lt; 10 ? '0'+m : m);\n                };\n\n                const sTime = formatTime(startMin);\n                const eTime = formatTime(endMin);\n\n                // Sakrij selekciju\n                selection.style.display = 'none';\n\n                // Pozovi HTMX da otvori modal sa ovim podacima\n                // Treba nam i datum koji je trenutno izabran (uzimamo iz URL-a ili DOM-a)\n                const urlParams = new URLSearchParams(window.location.search);\n                const date = urlParams.get('date') || 'today';\n\n                htmx.ajax('GET', '/modal/add?date=' + date + '&amp;start=' + sTime + '&amp;end=' + eTime, '#modal-container');\n            });\n        });\n     \&quot;]]))\n\n;; --- MODAL KOMPONENTA ---\n\n(defn add-activity-modal [request]\n  (let [params (:params request)\n        date-str (:date params)\n        start-str (:start params) ;; \&quot;14:30\&quot;\n        end-str (:end params)]    ;; \&quot;16:00\&quot;\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (html5\n             [:div.modal-overlay {:_ \&quot;on click self.remove()\&quot;}\n              [:div.modal {:onclick \&quot;event.stopPropagation()\&quot;}\n               [:h3 \&quot;Nova Aktivnost: \&quot; date-str]\n               [:form {:hx-post \&quot;/activity\&quot;\n                       ;; Posle uspešnog upisa, osveži celu stranicu da se vidi nova aktivnost\n                       :onsubmit \&quot;setTimeout(()=&gt;window.location.reload(), 100)\&quot;}\n\n                ;; Skriveni podaci koje je korisnik \&quot;prevukao\&quot; mišem\n                [:input {:type \&quot;hidden\&quot; :name \&quot;date\&quot; :value date-str}]\n                [:input {:type \&quot;hidden\&quot; :name \&quot;username\&quot; :value \&quot;Micko\&quot;}] ;; TODO: Session\n\n                [:div.form-group\n                 [:label \&quot;Vreme\&quot;]\n                 [:div {:style \&quot;display:flex; gap:10px\&quot;}\n                  [:input {:type \&quot;time\&quot; :name \&quot;start\&quot; :value start-str :readonly true}]\n                  [:input {:type \&quot;time\&quot; :name \&quot;end\&quot; :value end-str :readonly true}]]]\n\n                [:div.form-group\n                 [:label \&quot;Tip Aktivnosti\&quot;]\n                 [:select {:name \&quot;activity-key\&quot;}\n                  [:option {:value \&quot;training\&quot;} \&quot;🏋️ Trening\&quot;]\n                  [:option {:value \&quot;study\&quot;} \&quot;📚 Učenje\&quot;]\n                  [:option {:value \&quot;coding\&quot;} \&quot;💻 Programiranje\&quot;]\n                  [:option {:value \&quot;work\&quot;} \&quot;💼 Posao\&quot;]\n                  [:option {:value \&quot;hobby\&quot;} \&quot;🎨 Hobi\&quot;]]]\n\n                [:div.form-group\n                 [:label \&quot;Intenzitet (1-5)\&quot;]\n                 [:input {:type \&quot;range\&quot; :min \&quot;1\&quot; :max \&quot;5\&quot; :value \&quot;3\&quot; :name \&quot;intensity\&quot;}]]\n\n                [:button.btn {:type \&quot;submit\&quot;} \&quot;Sačuvaj\&quot;]\n                [:button.btn.btn-cancel {:type \&quot;button\&quot; :onclick \&quot;document.querySelector('.modal-overlay').remove()\&quot;} \&quot;Otkaži\&quot;]]]])}))\n\n;; --- HANDLER ZA ČUVANJE ---\n\n(defn save-activity-handler [request]\n  (let [params (:params request)\n        username (:username params)\n        date-str (:date params)\n        start-time (:start params)\n        end-time (:end params)\n        activity-key (keyword (:activity-key params))\n        intensity (Integer/parseInt (:intensity params))\n\n        ;; Izračunaj trajanje\n        s (LocalTime/parse start-time)\n        e (LocalTime/parse end-time)\n        duration (.toMinutes (Duration/between s e))\n\n        ;; Povezivanje datuma i vremena da bi se dobio pravi Date objekat za bazu\n        ;; (Ako tvoja funkcija add-activity! prima java.util.Date)\n        local-date (parse-date date-str)\n        local-dt   (.atTime local-date s)\n        final-date (java.util.Date/from (.toInstant (.atZone local-dt (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    ;; Zovi tvoj API\n    ;; Ako tvoj API prima duration, super. Ako prima start/end, prilagodi.\n    ;; Ovde pretpostavljam da prima duration kao ranije.\n    (project.api/log-activity! username activity-key duration intensity)\n\n    {:status 200 :body \&quot;OK\&quot;}))\n\n;; --- PLANNER PAGE ---\n\n(defn planner-page [request]\n  (let [date-str (get-in request [:params :date])\n        current-date (parse-date date-str)\n        prev-date (format-date (get-prev-day current-date))\n        next-date (format-date (get-next-day current-date))\n\n        ;; Dohvati aktivnosti za TAJ dan\n        ;; (Ovde koristiš tvoju funkciju get-daily-report ili slično)\n        ;; Ovo je primer strukture koju treba da vratiš:\n        daily-data (project.api/get-daily-report \&quot;Micko\&quot; current-date)\n        activities (:activities daily-data)]\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (common-layout\n             [:div\n              ;; HEADER SA DATUMIMA (Skrol levo-desno)\n              [:div.planner-header\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; prev-date)} \&quot;◀\&quot;]\n               [:span.current-date-title (nice-date current-date)]\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; next-date)} \&quot;▶\&quot;]]\n\n              ;; TELO KALENDARA\n              [:div.calendar-body\n               ;; Sati\n               [:div.time-labels\n                (for [h (range 24)]\n                  [:div.time-label (str h \&quot;:00\&quot;)])]\n\n               ;; Grid za crtanje\n               [:div.day-column\n                ;; Renderuj postojeće aktivnosti\n                (for [act activities]\n                  (let [;; Tvoj report vraća :activity/start-time kao Date/Instant\n                        ;; Moramo izračunati minute od ponoći da bi znali 'top' poziciju\n                        inst (:activity/start-time act)\n                        start-min (instant-&gt;minutes-from-midnight inst)\n                        duration (:activity/duration act)\n\n                        top start-min ;; 1min = 1px (jednostavna matematika)\n                        height duration]\n\n                    [:div.calendar-event\n                     {:style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n                     [:strong (:activity/type act)]\n                     [:br]\n                     (str duration \&quot; min\&quot;)]))]]]\n             :planner)}))\n\n;; --- RUTER I START ---\n\n(def app\n  (ring/ring-handler\n    (ring/router\n      [\n       [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}]\n       [\&quot;/planner\&quot; {:get planner-page}]\n       [\&quot;/modal/add\&quot; {:get add-activity-modal}]\n       [\&quot;/activity\&quot; {:post save-activity-handler}]\n       [\&quot;/leaderboard\&quot; {:get (fn [_] {:status 200 :body \&quot;Ovde ide leaderboard\&quot;})}]\n       ]\n      {:data {:middleware [parameters/parameters-middleware]}})\n    (ring/create-default-handler)))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port 3000 :join? false}))\n    (println \&quot;Server na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when @server\n    (.stop @server)\n    (reset! server nil)\n    (println \&quot;Stop.\&quot;)))&quot;, :offset 14630, :ns &quot;web.server&quot;} {:command &quot;(def app\n  (ring/ring-handler\n    (ring/router\n      [\n       [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}]\n       [\&quot;/planner\&quot; {:get planner-page}]\n       [\&quot;/modal/add\&quot; {:get add-activity-modal}]\n       [\&quot;/activity\&quot; {:post save-activity-handler}]\n       [\&quot;/leaderboard\&quot; {:get (fn [_] {:status 200 :body \&quot;Ovde ide leaderboard\&quot;})}]\n       ]\n      {:data {:middleware [parameters/parameters-middleware]}})\n    (ring/create-default-handler)))&quot;, :offset 470, :ns &quot;web.server&quot;} {:command &quot;(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date] (.plusDays date 1))\n(defn get-prev-day [date] (.minusDays date 1))\n\n(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)]\n    (+ (* hour 60) minute)))\n\n;; --- LAYOUT I STILOVI ---\n\n(defn common-layout [content current-page]\n  (html5\n    [:head\n     [:title \&quot;BeBetter Planner\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;\n        /* OSNOVNO */\n        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; display: flex; height: 100vh; overflow: hidden; }\n\n        /* SIDEBAR */\n        .sidebar { width: 250px; background: white; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }\n        .logo { font-size: 28px; font-weight: 900; margin-bottom: 40px; color: #000; letter-spacing: -1px; } /* Tvoj debeli logo */\n\n        .nav-link { display: flex; align-items: center; padding: 15px; color: #333; text-decoration: none; border-radius: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 500; transition: 0.2s; }\n        .nav-link:hover { background-color: #f0f0f0; }\n        .nav-link.active { font-weight: bold; background-color: #eefec3; } /* Malo boje za aktivni tab */\n        .nav-link span { margin-right: 15px; }\n\n        /* CONTENT */\n        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }\n\n        /* PLANNER HEADER (DATE SCROLL) */\n        .planner-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 20px; background: white; z-index: 10; }\n        .date-nav-btn { text-decoration: none; font-size: 24px; color: #555; padding: 5px 15px; border-radius: 50%; }\n        .date-nav-btn:hover { background-color: #eee; }\n        .current-date-title { font-size: 20px; font-weight: bold; min-width: 250px; text-align: center; }\n\n        /* CALENDAR GRID */\n        .calendar-body { display: flex; overflow-y: auto; height: 100%; position: relative; scroll-behavior: smooth; }\n        .time-labels { width: 60px; flex-shrink: 0; border-right: 1px solid #eee; background: #fafafa; }\n        .time-label { height: 60px; border-bottom: 1px solid #eee; font-size: 12px; color: #999; text-align: right; padding-right: 8px; padding-top: 5px; box-sizing: border-box; }\n\n        .day-column { flex-grow: 1; position: relative; background:\n            repeating-linear-gradient(to bottom, transparent 0px, transparent 59px, #f0f0f0 60px);\n            height: 1440px; /* 24h * 60px */ cursor: crosshair; }\n\n        /* AKTIVNOST NA KALENDARU */\n        .calendar-event {\n            position: absolute;\n            left: 5px; right: 10px;\n            background-color: #4CAF50;\n            color: white;\n            border-radius: 6px;\n            padding: 5px;\n            font-size: 13px;\n            overflow: hidden;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n            border-left: 5px solid #2E7D32;\n            z-index: 2;\n        }\n\n        /* SELEKCIJA (JS DYNAMIC) */\n        #selection-box {\n            position: absolute;\n            background: rgba(76, 175, 80, 0.3);\n            border: 2px dashed #4CAF50;\n            width: 95%;\n            left: 2.5%;\n            display: none;\n            pointer-events: none;\n            z-index: 1;\n        }\n\n        /* MODAL */\n        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }\n        .modal { background: white; padding: 25px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }\n        .form-group { margin-bottom: 15px; }\n        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }\n        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }\n        .btn { width: 100%; padding: 12px; background: #000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }\n        .btn-cancel { background: #ccc; margin-top: 10px; color: #333; }\n     \&quot;]]\n\n    [:body\n     ;; --- SIDEBAR ---\n     [:nav.sidebar\n      [:div.logo \&quot;BeBetter\&quot;]\n      [:a.nav-link {:href \&quot;/planner\&quot; :class (when (= current-page :planner) \&quot;active\&quot;)}\n       [:span \&quot;📅\&quot;] \&quot;Planer\&quot;]\n      [:a.nav-link {:href \&quot;/leaderboard\&quot; :class (when (= current-page :leaderboard) \&quot;active\&quot;)}\n       [:span \&quot;🏆\&quot;] \&quot;Rang Lista\&quot;]\n      [:a.nav-link {:href \&quot;/search\&quot;} [:span \&quot;🔍\&quot;] \&quot;Pretraga\&quot;]\n      [:a.nav-link {:href \&quot;/profile\&quot;} [:span \&quot;👤\&quot;] \&quot;Moj Profil\&quot;]]\n\n     ;; --- CONTENT ---\n     [:main.main-content\n      content\n      [:div#modal-container]]\n\n     ;; --- JAVASCRIPT ZA DRAG-AND-DROP ---\n     [:script \&quot;\n        document.addEventListener('DOMContentLoaded', function() {\n            const grid = document.querySelector('.day-column');\n            if(!grid) return;\n\n            let isDragging = false;\n            let startY = 0;\n            let currentY = 0;\n            const selection = document.createElement('div');\n            selection.id = 'selection-box';\n            grid.appendChild(selection);\n\n            grid.addEventListener('mousedown', function(e) {\n                if(e.target.classList.contains('calendar-event')) return; // Ne selektuj preko postojecih\n                isDragging = true;\n                const rect = grid.getBoundingClientRect();\n                startY = e.clientY - rect.top + grid.scrollTop;\n\n                // Snap to 15 mins (15px)\n                startY = Math.floor(startY / 15) * 15;\n\n                selection.style.top = startY + 'px';\n                selection.style.height = '0px';\n                selection.style.display = 'block';\n            });\n\n            grid.addEventListener('mousemove', function(e) {\n                if (!isDragging) return;\n                const rect = grid.getBoundingClientRect();\n                let y = e.clientY - rect.top + grid.scrollTop;\n\n                let height = y - startY;\n                if(height &lt; 15) height = 15; // Minimum 15 min\n\n                selection.style.height = height + 'px';\n            });\n\n            grid.addEventListener('mouseup', function(e) {\n                if (!isDragging) return;\n                isDragging = false;\n\n                // Izračunaj vreme na osnovu piksela (1px = 1min)\n                // Ali posto smo stavili 60px = 1h, onda je 1px = 1minuta.\n\n                const height = parseInt(selection.style.height);\n                const startMin = startY;\n                const endMin = startY + height;\n\n                // Konvertuj u HH:mm\n                const formatTime = (minutes) =&gt; {\n                    let h = Math.floor(minutes / 60);\n                    let m = Math.floor(minutes % 60);\n                    return (h &lt; 10 ? '0'+h : h) + ':' + (m &lt; 10 ? '0'+m : m);\n                };\n\n                const sTime = formatTime(startMin);\n                const eTime = formatTime(endMin);\n\n                // Sakrij selekciju\n                selection.style.display = 'none';\n\n                // Pozovi HTMX da otvori modal sa ovim podacima\n                // Treba nam i datum koji je trenutno izabran (uzimamo iz URL-a ili DOM-a)\n                const urlParams = new URLSearchParams(window.location.search);\n                const date = urlParams.get('date') || 'today';\n\n                htmx.ajax('GET', '/modal/add?date=' + date + '&amp;start=' + sTime + '&amp;end=' + eTime, '#modal-container');\n            });\n        });\n     \&quot;]]))\n\n;; --- MODAL KOMPONENTA ---\n\n(defn add-activity-modal [request]\n  (let [params (:params request)\n        date-str (:date params)\n        start-str (:start params) ;; \&quot;14:30\&quot;\n        end-str (:end params)]    ;; \&quot;16:00\&quot;\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (html5\n             [:div.modal-overlay {:_ \&quot;on click self.remove()\&quot;}\n              [:div.modal {:onclick \&quot;event.stopPropagation()\&quot;}\n               [:h3 \&quot;Nova Aktivnost: \&quot; date-str]\n               [:form {:hx-post \&quot;/activity\&quot;\n                       ;; Posle uspešnog upisa, osveži celu stranicu da se vidi nova aktivnost\n                       :onsubmit \&quot;setTimeout(()=&gt;window.location.reload(), 100)\&quot;}\n\n                ;; Skriveni podaci koje je korisnik \&quot;prevukao\&quot; mišem\n                [:input {:type \&quot;hidden\&quot; :name \&quot;date\&quot; :value date-str}]\n                [:input {:type \&quot;hidden\&quot; :name \&quot;username\&quot; :value \&quot;Micko\&quot;}] ;; TODO: Session\n\n                [:div.form-group\n                 [:label \&quot;Vreme\&quot;]\n                 [:div {:style \&quot;display:flex; gap:10px\&quot;}\n                  [:input {:type \&quot;time\&quot; :name \&quot;start\&quot; :value start-str :readonly true}]\n                  [:input {:type \&quot;time\&quot; :name \&quot;end\&quot; :value end-str :readonly true}]]]\n\n                [:div.form-group\n                 [:label \&quot;Tip Aktivnosti\&quot;]\n                 [:select {:name \&quot;activity-key\&quot;}\n                  [:option {:value \&quot;training\&quot;} \&quot;🏋️ Trening\&quot;]\n                  [:option {:value \&quot;study\&quot;} \&quot;📚 Učenje\&quot;]\n                  [:option {:value \&quot;coding\&quot;} \&quot;💻 Programiranje\&quot;]\n                  [:option {:value \&quot;work\&quot;} \&quot;💼 Posao\&quot;]\n                  [:option {:value \&quot;hobby\&quot;} \&quot;🎨 Hobi\&quot;]]]\n\n                [:div.form-group\n                 [:label \&quot;Intenzitet (1-5)\&quot;]\n                 [:input {:type \&quot;range\&quot; :min \&quot;1\&quot; :max \&quot;5\&quot; :value \&quot;3\&quot; :name \&quot;intensity\&quot;}]]\n\n                [:button.btn {:type \&quot;submit\&quot;} \&quot;Sačuvaj\&quot;]\n                [:button.btn.btn-cancel {:type \&quot;button\&quot; :onclick \&quot;document.querySelector('.modal-overlay').remove()\&quot;} \&quot;Otkaži\&quot;]]]])}))\n\n;; --- HANDLER ZA ČUVANJE ---\n\n(defn save-activity-handler [request]\n  (let [params (:params request)\n        username (:username params)\n        date-str (:date params)\n        start-time (:start params)\n        end-time (:end params)\n        activity-key (keyword (:activity-key params))\n        intensity (Integer/parseInt (:intensity params))\n\n        ;; Izračunaj trajanje\n        s (LocalTime/parse start-time)\n        e (LocalTime/parse end-time)\n        duration (.toMinutes (Duration/between s e))\n\n        ;; Povezivanje datuma i vremena da bi se dobio pravi Date objekat za bazu\n        ;; (Ako tvoja funkcija add-activity! prima java.util.Date)\n        local-date (parse-date date-str)\n        local-dt   (.atTime local-date s)\n        final-date (java.util.Date/from (.toInstant (.atZone local-dt (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    ;; Zovi tvoj API\n    ;; Ako tvoj API prima duration, super. Ako prima start/end, prilagodi.\n    ;; Ovde pretpostavljam da prima duration kao ranije.\n    (project.api/log-activity! username activity-key duration intensity)\n\n    {:status 200 :body \&quot;OK\&quot;}))\n\n;; --- PLANNER PAGE ---\n\n(defn planner-page [request]\n  (let [date-str (get-in request [:params :date])\n        current-date (parse-date date-str)\n        prev-date (format-date (get-prev-day current-date))\n        next-date (format-date (get-next-day current-date))\n\n        ;; Dohvati aktivnosti za TAJ dan\n        ;; (Ovde koristiš tvoju funkciju get-daily-report ili slično)\n        ;; Ovo je primer strukture koju treba da vratiš:\n        daily-data (project.api/get-daily-report \&quot;Micko\&quot; current-date)\n        activities (:activities daily-data)]\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (common-layout\n             [:div\n              ;; HEADER SA DATUMIMA (Skrol levo-desno)\n              [:div.planner-header\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; prev-date)} \&quot;◀\&quot;]\n               [:span.current-date-title (nice-date current-date)]\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; next-date)} \&quot;▶\&quot;]]\n\n              ;; TELO KALENDARA\n              [:div.calendar-body\n               ;; Sati\n               [:div.time-labels\n                (for [h (range 24)]\n                  [:div.time-label (str h \&quot;:00\&quot;)])]\n\n               ;; Grid za crtanje\n               [:div.day-column\n                ;; Renderuj postojeće aktivnosti\n                (for [act activities]\n                  (let [;; Tvoj report vraća :activity/start-time kao Date/Instant\n                        ;; Moramo izračunati minute od ponoći da bi znali 'top' poziciju\n                        inst (:activity/start-time act)\n                        start-min (instant-&gt;minutes-from-midnight inst)\n                        duration (:activity/duration act)\n\n                        top start-min ;; 1min = 1px (jednostavna matematika)\n                        height duration]\n\n                    [:div.calendar-event\n                     {:style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n                     [:strong (:activity/type act)]\n                     [:br]\n                     (str duration \&quot; min\&quot;)]))]]]\n             :planner)}))\n\n;; --- RUTER I START ---\n\n(def app\n  (ring/ring-handler\n    (ring/router\n      [\n       [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}]\n       [\&quot;/planner\&quot; {:get planner-page}]\n       [\&quot;/modal/add\&quot; {:get add-activity-modal}]\n       [\&quot;/activity\&quot; {:post save-activity-handler}]\n       [\&quot;/leaderboard\&quot; {:get (fn [_] {:status 200 :body \&quot;Ovde ide leaderboard\&quot;})}]\n       ]\n      {:data {:middleware [parameters/parameters-middleware]}})\n    (ring/create-default-handler)))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port 3000 :join? false}))\n    (println \&quot;Server na http://localhost:3000\&quot;)))&quot;, :offset 14038, :ns &quot;web.server&quot;} {:command &quot;(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))&quot;, :offset 229, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [hiccup.page :refer [html5]]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str])\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)))\n\n(def port 3000)\n\n\n\n;; --- POMOĆNE FUNKCIJE ZA VREME ---\n\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date] (.plusDays date 1))\n(defn get-prev-day [date] (.minusDays date 1))\n\n(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)]\n    (+ (* hour 60) minute)))\n\n;; --- LAYOUT I STILOVI ---\n\n(defn common-layout [content current-page]\n  (html5\n    [:head\n     [:title \&quot;BeBetter Planner\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;\n        /* OSNOVNO */\n        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; display: flex; height: 100vh; overflow: hidden; }\n\n        /* SIDEBAR */\n        .sidebar { width: 250px; background: white; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }\n        .logo { font-size: 28px; font-weight: 900; margin-bottom: 40px; color: #000; letter-spacing: -1px; } /* Tvoj debeli logo */\n\n        .nav-link { display: flex; align-items: center; padding: 15px; color: #333; text-decoration: none; border-radius: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 500; transition: 0.2s; }\n        .nav-link:hover { background-color: #f0f0f0; }\n        .nav-link.active { font-weight: bold; background-color: #eefec3; } /* Malo boje za aktivni tab */\n        .nav-link span { margin-right: 15px; }\n\n        /* CONTENT */\n        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }\n\n        /* PLANNER HEADER (DATE SCROLL) */\n        .planner-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 20px; background: white; z-index: 10; }\n        .date-nav-btn { text-decoration: none; font-size: 24px; color: #555; padding: 5px 15px; border-radius: 50%; }\n        .date-nav-btn:hover { background-color: #eee; }\n        .current-date-title { font-size: 20px; font-weight: bold; min-width: 250px; text-align: center; }\n\n        /* CALENDAR GRID */\n        .calendar-body { display: flex; overflow-y: auto; height: 100%; position: relative; scroll-behavior: smooth; }\n        .time-labels { width: 60px; flex-shrink: 0; border-right: 1px solid #eee; background: #fafafa; }\n        .time-label { height: 60px; border-bottom: 1px solid #eee; font-size: 12px; color: #999; text-align: right; padding-right: 8px; padding-top: 5px; box-sizing: border-box; }\n\n        .day-column { flex-grow: 1; position: relative; background:\n            repeating-linear-gradient(to bottom, transparent 0px, transparent 59px, #f0f0f0 60px);\n            height: 1440px; /* 24h * 60px */ cursor: crosshair; }\n\n        /* AKTIVNOST NA KALENDARU */\n        .calendar-event {\n            position: absolute;\n            left: 5px; right: 10px;\n            background-color: #4CAF50;\n            color: white;\n            border-radius: 6px;\n            padding: 5px;\n            font-size: 13px;\n            overflow: hidden;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n            border-left: 5px solid #2E7D32;\n            z-index: 2;\n        }\n\n        /* SELEKCIJA (JS DYNAMIC) */\n        #selection-box {\n            position: absolute;\n            background: rgba(76, 175, 80, 0.3);\n            border: 2px dashed #4CAF50;\n            width: 95%;\n            left: 2.5%;\n            display: none;\n            pointer-events: none;\n            z-index: 1;\n        }\n\n        /* MODAL */\n        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }\n        .modal { background: white; padding: 25px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }\n        .form-group { margin-bottom: 15px; }\n        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }\n        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }\n        .btn { width: 100%; padding: 12px; background: #000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }\n        .btn-cancel { background: #ccc; margin-top: 10px; color: #333; }\n     \&quot;]]\n\n    [:body\n     ;; --- SIDEBAR ---\n     [:nav.sidebar\n      [:div.logo \&quot;BeBetter\&quot;]\n      [:a.nav-link {:href \&quot;/planner\&quot; :class (when (= current-page :planner) \&quot;active\&quot;)}\n       [:span \&quot;📅\&quot;] \&quot;Planer\&quot;]\n      [:a.nav-link {:href \&quot;/leaderboard\&quot; :class (when (= current-page :leaderboard) \&quot;active\&quot;)}\n       [:span \&quot;🏆\&quot;] \&quot;Rang Lista\&quot;]\n      [:a.nav-link {:href \&quot;/search\&quot;} [:span \&quot;🔍\&quot;] \&quot;Pretraga\&quot;]\n      [:a.nav-link {:href \&quot;/profile\&quot;} [:span \&quot;👤\&quot;] \&quot;Moj Profil\&quot;]]\n\n     ;; --- CONTENT ---\n     [:main.main-content\n      content\n      [:div#modal-container]]\n\n     ;; --- JAVASCRIPT ZA DRAG-AND-DROP ---\n     [:script \&quot;\n        document.addEventListener('DOMContentLoaded', function() {\n            const grid = document.querySelector('.day-column');\n            if(!grid) return;\n\n            let isDragging = false;\n            let startY = 0;\n            let currentY = 0;\n            const selection = document.createElement('div');\n            selection.id = 'selection-box';\n            grid.appendChild(selection);\n\n            grid.addEventListener('mousedown', function(e) {\n                if(e.target.classList.contains('calendar-event')) return; // Ne selektuj preko postojecih\n                isDragging = true;\n                const rect = grid.getBoundingClientRect();\n                startY = e.clientY - rect.top + grid.scrollTop;\n\n                // Snap to 15 mins (15px)\n                startY = Math.floor(startY / 15) * 15;\n\n                selection.style.top = startY + 'px';\n                selection.style.height = '0px';\n                selection.style.display = 'block';\n            });\n\n            grid.addEventListener('mousemove', function(e) {\n                if (!isDragging) return;\n                const rect = grid.getBoundingClientRect();\n                let y = e.clientY - rect.top + grid.scrollTop;\n\n                let height = y - startY;\n                if(height &lt; 15) height = 15; // Minimum 15 min\n\n                selection.style.height = height + 'px';\n            });\n\n            grid.addEventListener('mouseup', function(e) {\n                if (!isDragging) return;\n                isDragging = false;\n\n                // Izračunaj vreme na osnovu piksela (1px = 1min)\n                // Ali posto smo stavili 60px = 1h, onda je 1px = 1minuta.\n\n                const height = parseInt(selection.style.height);\n                const startMin = startY;\n                const endMin = startY + height;\n\n                // Konvertuj u HH:mm\n                const formatTime = (minutes) =&gt; {\n                    let h = Math.floor(minutes / 60);\n                    let m = Math.floor(minutes % 60);\n                    return (h &lt; 10 ? '0'+h : h) + ':' + (m &lt; 10 ? '0'+m : m);\n                };\n\n                const sTime = formatTime(startMin);\n                const eTime = formatTime(endMin);\n\n                // Sakrij selekciju\n                selection.style.display = 'none';\n\n                // Pozovi HTMX da otvori modal sa ovim podacima\n                // Treba nam i datum koji je trenutno izabran (uzimamo iz URL-a ili DOM-a)\n                const urlParams = new URLSearchParams(window.location.search);\n                const date = urlParams.get('date') || 'today';\n\n                htmx.ajax('GET', '/modal/add?date=' + date + '&amp;start=' + sTime + '&amp;end=' + eTime, '#modal-container');\n            });\n        });\n     \&quot;]]))\n\n;; --- MODAL KOMPONENTA ---\n\n(defn add-activity-modal [request]\n  (let [params (:params request)\n        date-str (:date params)\n        start-str (:start params) ;; \&quot;14:30\&quot;\n        end-str (:end params)]    ;; \&quot;16:00\&quot;\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (html5\n             [:div.modal-overlay {:_ \&quot;on click self.remove()\&quot;}\n              [:div.modal {:onclick \&quot;event.stopPropagation()\&quot;}\n               [:h3 \&quot;Nova Aktivnost: \&quot; date-str]\n               [:form {:hx-post \&quot;/activity\&quot;\n                       ;; Posle uspešnog upisa, osveži celu stranicu da se vidi nova aktivnost\n                       :onsubmit \&quot;setTimeout(()=&gt;window.location.reload(), 100)\&quot;}\n\n                ;; Skriveni podaci koje je korisnik \&quot;prevukao\&quot; mišem\n                [:input {:type \&quot;hidden\&quot; :name \&quot;date\&quot; :value date-str}]\n                [:input {:type \&quot;hidden\&quot; :name \&quot;username\&quot; :value \&quot;Micko\&quot;}] ;; TODO: Session\n\n                [:div.form-group\n                 [:label \&quot;Vreme\&quot;]\n                 [:div {:style \&quot;display:flex; gap:10px\&quot;}\n                  [:input {:type \&quot;time\&quot; :name \&quot;start\&quot; :value start-str :readonly true}]\n                  [:input {:type \&quot;time\&quot; :name \&quot;end\&quot; :value end-str :readonly true}]]]\n\n                [:div.form-group\n                 [:label \&quot;Tip Aktivnosti\&quot;]\n                 [:select {:name \&quot;activity-key\&quot;}\n                  [:option {:value \&quot;training\&quot;} \&quot;🏋️ Trening\&quot;]\n                  [:option {:value \&quot;study\&quot;} \&quot;📚 Učenje\&quot;]\n                  [:option {:value \&quot;coding\&quot;} \&quot;💻 Programiranje\&quot;]\n                  [:option {:value \&quot;work\&quot;} \&quot;💼 Posao\&quot;]\n                  [:option {:value \&quot;hobby\&quot;} \&quot;🎨 Hobi\&quot;]]]\n\n                [:div.form-group\n                 [:label \&quot;Intenzitet (1-5)\&quot;]\n                 [:input {:type \&quot;range\&quot; :min \&quot;1\&quot; :max \&quot;5\&quot; :value \&quot;3\&quot; :name \&quot;intensity\&quot;}]]\n\n                [:button.btn {:type \&quot;submit\&quot;} \&quot;Sačuvaj\&quot;]\n                [:button.btn.btn-cancel {:type \&quot;button\&quot; :onclick \&quot;document.querySelector('.modal-overlay').remove()\&quot;} \&quot;Otkaži\&quot;]]]])}))\n\n;; --- HANDLER ZA ČUVANJE ---\n\n(defn save-activity-handler [request]\n  (let [params (:params request)\n        username (:username params)\n        date-str (:date params)\n        start-time (:start params)\n        end-time (:end params)\n        activity-key (keyword (:activity-key params))\n        intensity (Integer/parseInt (:intensity params))\n\n        ;; Izračunaj trajanje\n        s (LocalTime/parse start-time)\n        e (LocalTime/parse end-time)\n        duration (.toMinutes (Duration/between s e))\n\n        ;; Povezivanje datuma i vremena da bi se dobio pravi Date objekat za bazu\n        ;; (Ako tvoja funkcija add-activity! prima java.util.Date)\n        local-date (parse-date date-str)\n        local-dt   (.atTime local-date s)\n        final-date (java.util.Date/from (.toInstant (.atZone local-dt (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    ;; Zovi tvoj API\n    ;; Ako tvoj API prima duration, super. Ako prima start/end, prilagodi.\n    ;; Ovde pretpostavljam da prima duration kao ranije.\n    (project.api/log-activity! username activity-key duration intensity)\n\n    {:status 200 :body \&quot;OK\&quot;}))\n\n;; --- PLANNER PAGE ---\n\n(defn planner-page [request]\n  (let [date-str (get-in request [:params :date])\n        current-date (parse-date date-str)\n        prev-date (format-date (get-prev-day current-date))\n        next-date (format-date (get-next-day current-date))\n\n        ;; Dohvati aktivnosti za TAJ dan\n        ;; (Ovde koristiš tvoju funkciju get-daily-report ili slično)\n        ;; Ovo je primer strukture koju treba da vratiš:\n        daily-data (project.api/get-daily-report \&quot;Micko\&quot; current-date)\n        activities (:activities daily-data)]\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (common-layout\n             [:div\n              ;; HEADER SA DATUMIMA (Skrol levo-desno)\n              [:div.planner-header\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; prev-date)} \&quot;◀\&quot;]\n               [:span.current-date-title (nice-date current-date)]\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; next-date)} \&quot;▶\&quot;]]\n\n              ;; TELO KALENDARA\n              [:div.calendar-body\n               ;; Sati\n               [:div.time-labels\n                (for [h (range 24)]\n                  [:div.time-label (str h \&quot;:00\&quot;)])]\n\n               ;; Grid za crtanje\n               [:div.day-column\n                ;; Renderuj postojeće aktivnosti\n                (for [act activities]\n                  (let [;; Tvoj report vraća :activity/start-time kao Date/Instant\n                        ;; Moramo izračunati minute od ponoći da bi znali 'top' poziciju\n                        inst (:activity/start-time act)\n                        start-min (instant-&gt;minutes-from-midnight inst)\n                        duration (:activity/duration act)\n\n                        top start-min ;; 1min = 1px (jednostavna matematika)\n                        height duration]\n\n                    [:div.calendar-event\n                     {:style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n                     [:strong (:activity/type act)]\n                     [:br]\n                     (str duration \&quot; min\&quot;)]))]]]\n             :planner)}))\n\n;; --- RUTER I START ---\n\n(def app\n  (ring/ring-handler\n    (ring/router\n      [\n       [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}]\n       [\&quot;/planner\&quot; {:get planner-page}]\n       [\&quot;/modal/add\&quot; {:get add-activity-modal}]\n       [\&quot;/activity\&quot; {:post save-activity-handler}]\n       [\&quot;/leaderboard\&quot; {:get (fn [_] {:status 200 :body \&quot;Ovde ide leaderboard\&quot;})}]\n       ]\n      {:data {:middleware [parameters/parameters-middleware]}})\n    (ring/create-default-handler)))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port 3000 :join? false}))\n    (println \&quot;Server na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when @server\n    (.stop @server)\n    (reset! server nil)\n    (println \&quot;Stop.\&quot;)))\n(defn leaderboard-table [data]\n  [:div\n   [:h2 \&quot;Rank list \&quot;]\n   [:table\n    [:thead\n     [:tr\n      [:th \&quot;Rank\&quot;]\n      [:th \&quot;Username\&quot;]\n      [:th \&quot;XP\&quot;]\n      [:th \&quot;Delta\&quot;]]]\n    [:tbody\n     (for [user data]\n       [:tr\n        [:td (:rank user)]\n        [:td (:user/username user)]\n        [:td (:user/xp user)]\n        [:td (let [d (:delta user)]\n               (cond\n                 (pos? d) [:span {:style \&quot;color:green\&quot;} (str \&quot;▲ \&quot; d)]\n                 (neg? d) [:span {:style \&quot;color:red\&quot;} (str \&quot;▼ \&quot; (Math/abs d))]\n                 :else    [:span {:style \&quot;color:gray\&quot;} \&quot;-\&quot;]))]\n\n        ])]\n    ]]\n  )\n#_(defn home-page [request]\n\n  (let [leaderboard-data (api/get-leaderboard :weekly (LocalDate/now))]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (common-layout (leaderboard-table leaderboard-data))}))\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n#_(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n#_(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 16608, :ns &quot;web.server&quot;} {:command &quot;(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello man\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))&quot;, :offset 233, :ns &quot;web.server&quot;} {:command &quot;(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 186, :ns &quot;web.server&quot;} {:command &quot;(stop-server)&quot;, :offset 12, :ns &quot;web.server&quot;} {:command &quot;(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date] (.plusDays date 1))\n(defn get-prev-day [date] (.minusDays date 1))\n\n(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)]\n    (+ (* hour 60) minute)))\n\n;; --- LAYOUT I STILOVI ---\n\n(defn common-layout [content current-page]\n  (html5\n    [:head\n     [:title \&quot;BeBetter Planner\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style \&quot;\n        /* OSNOVNO */\n        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; display: flex; height: 100vh; overflow: hidden; }\n\n        /* SIDEBAR */\n        .sidebar { width: 250px; background: white; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }\n        .logo { font-size: 28px; font-weight: 900; margin-bottom: 40px; color: #000; letter-spacing: -1px; } /* Tvoj debeli logo */\n\n        .nav-link { display: flex; align-items: center; padding: 15px; color: #333; text-decoration: none; border-radius: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 500; transition: 0.2s; }\n        .nav-link:hover { background-color: #f0f0f0; }\n        .nav-link.active { font-weight: bold; background-color: #eefec3; } /* Malo boje za aktivni tab */\n        .nav-link span { margin-right: 15px; }\n\n        /* CONTENT */\n        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }\n\n        /* PLANNER HEADER (DATE SCROLL) */\n        .planner-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 20px; background: white; z-index: 10; }\n        .date-nav-btn { text-decoration: none; font-size: 24px; color: #555; padding: 5px 15px; border-radius: 50%; }\n        .date-nav-btn:hover { background-color: #eee; }\n        .current-date-title { font-size: 20px; font-weight: bold; min-width: 250px; text-align: center; }\n\n        /* CALENDAR GRID */\n        .calendar-body { display: flex; overflow-y: auto; height: 100%; position: relative; scroll-behavior: smooth; }\n        .time-labels { width: 60px; flex-shrink: 0; border-right: 1px solid #eee; background: #fafafa; }\n        .time-label { height: 60px; border-bottom: 1px solid #eee; font-size: 12px; color: #999; text-align: right; padding-right: 8px; padding-top: 5px; box-sizing: border-box; }\n\n        .day-column { flex-grow: 1; position: relative; background:\n            repeating-linear-gradient(to bottom, transparent 0px, transparent 59px, #f0f0f0 60px);\n            height: 1440px; /* 24h * 60px */ cursor: crosshair; }\n\n        /* AKTIVNOST NA KALENDARU */\n        .calendar-event {\n            position: absolute;\n            left: 5px; right: 10px;\n            background-color: #4CAF50;\n            color: white;\n            border-radius: 6px;\n            padding: 5px;\n            font-size: 13px;\n            overflow: hidden;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n            border-left: 5px solid #2E7D32;\n            z-index: 2;\n        }\n\n        /* SELEKCIJA (JS DYNAMIC) */\n        #selection-box {\n            position: absolute;\n            background: rgba(76, 175, 80, 0.3);\n            border: 2px dashed #4CAF50;\n            width: 95%;\n            left: 2.5%;\n            display: none;\n            pointer-events: none;\n            z-index: 1;\n        }\n\n        /* MODAL */\n        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }\n        .modal { background: white; padding: 25px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }\n        .form-group { margin-bottom: 15px; }\n        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }\n        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }\n        .btn { width: 100%; padding: 12px; background: #000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }\n        .btn-cancel { background: #ccc; margin-top: 10px; color: #333; }\n     \&quot;]]\n\n    [:body\n     ;; --- SIDEBAR ---\n     [:nav.sidebar\n      [:div.logo \&quot;BeBetter\&quot;]\n      [:a.nav-link {:href \&quot;/planner\&quot; :class (when (= current-page :planner) \&quot;active\&quot;)}\n       [:span \&quot;📅\&quot;] \&quot;Planer\&quot;]\n      [:a.nav-link {:href \&quot;/leaderboard\&quot; :class (when (= current-page :leaderboard) \&quot;active\&quot;)}\n       [:span \&quot;🏆\&quot;] \&quot;Rang Lista\&quot;]\n      [:a.nav-link {:href \&quot;/search\&quot;} [:span \&quot;🔍\&quot;] \&quot;Pretraga\&quot;]\n      [:a.nav-link {:href \&quot;/profile\&quot;} [:span \&quot;👤\&quot;] \&quot;Moj Profil\&quot;]]\n\n     ;; --- CONTENT ---\n     [:main.main-content\n      content\n      [:div#modal-container]]\n\n     ;; --- JAVASCRIPT ZA DRAG-AND-DROP ---\n     [:script \&quot;\n        document.addEventListener('DOMContentLoaded', function() {\n            const grid = document.querySelector('.day-column');\n            if(!grid) return;\n\n            let isDragging = false;\n            let startY = 0;\n            let currentY = 0;\n            const selection = document.createElement('div');\n            selection.id = 'selection-box';\n            grid.appendChild(selection);\n\n            grid.addEventListener('mousedown', function(e) {\n                if(e.target.classList.contains('calendar-event')) return; // Ne selektuj preko postojecih\n                isDragging = true;\n                const rect = grid.getBoundingClientRect();\n                startY = e.clientY - rect.top + grid.scrollTop;\n\n                // Snap to 15 mins (15px)\n                startY = Math.floor(startY / 15) * 15;\n\n                selection.style.top = startY + 'px';\n                selection.style.height = '0px';\n                selection.style.display = 'block';\n            });\n\n            grid.addEventListener('mousemove', function(e) {\n                if (!isDragging) return;\n                const rect = grid.getBoundingClientRect();\n                let y = e.clientY - rect.top + grid.scrollTop;\n\n                let height = y - startY;\n                if(height &lt; 15) height = 15; // Minimum 15 min\n\n                selection.style.height = height + 'px';\n            });\n\n            grid.addEventListener('mouseup', function(e) {\n                if (!isDragging) return;\n                isDragging = false;\n\n                // Izračunaj vreme na osnovu piksela (1px = 1min)\n                // Ali posto smo stavili 60px = 1h, onda je 1px = 1minuta.\n\n                const height = parseInt(selection.style.height);\n                const startMin = startY;\n                const endMin = startY + height;\n\n                // Konvertuj u HH:mm\n                const formatTime = (minutes) =&gt; {\n                    let h = Math.floor(minutes / 60);\n                    let m = Math.floor(minutes % 60);\n                    return (h &lt; 10 ? '0'+h : h) + ':' + (m &lt; 10 ? '0'+m : m);\n                };\n\n                const sTime = formatTime(startMin);\n                const eTime = formatTime(endMin);\n\n                // Sakrij selekciju\n                selection.style.display = 'none';\n\n                // Pozovi HTMX da otvori modal sa ovim podacima\n                // Treba nam i datum koji je trenutno izabran (uzimamo iz URL-a ili DOM-a)\n                const urlParams = new URLSearchParams(window.location.search);\n                const date = urlParams.get('date') || 'today';\n\n                htmx.ajax('GET', '/modal/add?date=' + date + '&amp;start=' + sTime + '&amp;end=' + eTime, '#modal-container');\n            });\n        });\n     \&quot;]]))\n\n;; --- MODAL KOMPONENTA ---\n\n(defn add-activity-modal [request]\n  (let [params (:params request)\n        date-str (:date params)\n        start-str (:start params) ;; \&quot;14:30\&quot;\n        end-str (:end params)]    ;; \&quot;16:00\&quot;\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (html5\n             [:div.modal-overlay {:_ \&quot;on click self.remove()\&quot;}\n              [:div.modal {:onclick \&quot;event.stopPropagation()\&quot;}\n               [:h3 \&quot;Nova Aktivnost: \&quot; date-str]\n               [:form {:hx-post \&quot;/activity\&quot;\n                       ;; Posle uspešnog upisa, osveži celu stranicu da se vidi nova aktivnost\n                       :onsubmit \&quot;setTimeout(()=&gt;window.location.reload(), 100)\&quot;}\n\n                ;; Skriveni podaci koje je korisnik \&quot;prevukao\&quot; mišem\n                [:input {:type \&quot;hidden\&quot; :name \&quot;date\&quot; :value date-str}]\n                [:input {:type \&quot;hidden\&quot; :name \&quot;username\&quot; :value \&quot;Micko\&quot;}] ;; TODO: Session\n\n                [:div.form-group\n                 [:label \&quot;Vreme\&quot;]\n                 [:div {:style \&quot;display:flex; gap:10px\&quot;}\n                  [:input {:type \&quot;time\&quot; :name \&quot;start\&quot; :value start-str :readonly true}]\n                  [:input {:type \&quot;time\&quot; :name \&quot;end\&quot; :value end-str :readonly true}]]]\n\n                [:div.form-group\n                 [:label \&quot;Tip Aktivnosti\&quot;]\n                 [:select {:name \&quot;activity-key\&quot;}\n                  [:option {:value \&quot;training\&quot;} \&quot;🏋️ Trening\&quot;]\n                  [:option {:value \&quot;study\&quot;} \&quot;📚 Učenje\&quot;]\n                  [:option {:value \&quot;coding\&quot;} \&quot;💻 Programiranje\&quot;]\n                  [:option {:value \&quot;work\&quot;} \&quot;💼 Posao\&quot;]\n                  [:option {:value \&quot;hobby\&quot;} \&quot;🎨 Hobi\&quot;]]]\n\n                [:div.form-group\n                 [:label \&quot;Intenzitet (1-5)\&quot;]\n                 [:input {:type \&quot;range\&quot; :min \&quot;1\&quot; :max \&quot;5\&quot; :value \&quot;3\&quot; :name \&quot;intensity\&quot;}]]\n\n                [:button.btn {:type \&quot;submit\&quot;} \&quot;Sačuvaj\&quot;]\n                [:button.btn.btn-cancel {:type \&quot;button\&quot; :onclick \&quot;document.querySelector('.modal-overlay').remove()\&quot;} \&quot;Otkaži\&quot;]]]])}))\n\n;; --- HANDLER ZA ČUVANJE ---\n\n(defn save-activity-handler [request]\n  (let [params (:params request)\n        username (:username params)\n        date-str (:date params)\n        start-time (:start params)\n        end-time (:end params)\n        activity-key (keyword (:activity-key params))\n        intensity (Integer/parseInt (:intensity params))\n\n        ;; Izračunaj trajanje\n        s (LocalTime/parse start-time)\n        e (LocalTime/parse end-time)\n        duration (.toMinutes (Duration/between s e))\n\n        ;; Povezivanje datuma i vremena da bi se dobio pravi Date objekat za bazu\n        ;; (Ako tvoja funkcija add-activity! prima java.util.Date)\n        local-date (parse-date date-str)\n        local-dt   (.atTime local-date s)\n        final-date (java.util.Date/from (.toInstant (.atZone local-dt (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    ;; Zovi tvoj API\n    ;; Ako tvoj API prima duration, super. Ako prima start/end, prilagodi.\n    ;; Ovde pretpostavljam da prima duration kao ranije.\n    (project.api/log-activity! username activity-key duration intensity)\n\n    {:status 200 :body \&quot;OK\&quot;}))\n\n;; --- PLANNER PAGE ---\n\n(defn planner-page [request]\n  (let [date-str (get-in request [:params :date])\n        current-date (parse-date date-str)\n        prev-date (format-date (get-prev-day current-date))\n        next-date (format-date (get-next-day current-date))\n\n        ;; Dohvati aktivnosti za TAJ dan\n        ;; (Ovde koristiš tvoju funkciju get-daily-report ili slično)\n        ;; Ovo je primer strukture koju treba da vratiš:\n        daily-data (project.api/get-daily-report \&quot;Micko\&quot; current-date)\n        activities (:activities daily-data)]\n\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (common-layout\n             [:div\n              ;; HEADER SA DATUMIMA (Skrol levo-desno)\n              [:div.planner-header\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; prev-date)} \&quot;◀\&quot;]\n               [:span.current-date-title (nice-date current-date)]\n               [:a.date-nav-btn {:href (str \&quot;?date=\&quot; next-date)} \&quot;▶\&quot;]]\n\n              ;; TELO KALENDARA\n              [:div.calendar-body\n               ;; Sati\n               [:div.time-labels\n                (for [h (range 24)]\n                  [:div.time-label (str h \&quot;:00\&quot;)])]\n\n               ;; Grid za crtanje\n               [:div.day-column\n                ;; Renderuj postojeće aktivnosti\n                (for [act activities]\n                  (let [;; Tvoj report vraća :activity/start-time kao Date/Instant\n                        ;; Moramo izračunati minute od ponoći da bi znali 'top' poziciju\n                        inst (:activity/start-time act)\n                        start-min (instant-&gt;minutes-from-midnight inst)\n                        duration (:activity/duration act)\n\n                        top start-min ;; 1min = 1px (jednostavna matematika)\n                        height duration]\n\n                    [:div.calendar-event\n                     {:style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n                     [:strong (:activity/type act)]\n                     [:br]\n                     (str duration \&quot; min\&quot;)]))]]]\n             :planner)}))\n\n;; --- RUTER I START ---\n\n(def app\n  (ring/ring-handler\n    (ring/router\n      [\n       [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}]\n       [\&quot;/planner\&quot; {:get planner-page}]\n       [\&quot;/modal/add\&quot; {:get add-activity-modal}]\n       [\&quot;/activity\&quot; {:post save-activity-handler}]\n       [\&quot;/leaderboard\&quot; {:get (fn [_] {:status 200 :body \&quot;Ovde ide leaderboard\&quot;})}]\n       ]\n      {:data {:middleware [parameters/parameters-middleware]}})\n    (ring/create-default-handler)))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port 3000 :join? false}))\n    (println \&quot;Server na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when @server\n    (.stop @server)\n    (reset! server nil)\n    (println \&quot;Stop.\&quot;)))&quot;, :offset 14144, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n            )\n  (:import (java.time LocalDate)\n           (java.time.format DateTimeFormatter)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n   (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn home-page [request]\n\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:div \&quot;Hello World\&quot;]\n   })\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body (html5 [:div [:h2 {:style \&quot;color: blue\&quot;} \&quot;Server radi\&quot;]])})\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn start-server []\n  (reset! server (jetty/run-jetty (fn [req] {:status 200 :body \&quot;Hello\&quot; :headers {}})  ;; a really basic handler\n                   {:port 3000      ;; listen on port 3001\n                    :join? false})))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 2208, :ns &quot;web.server&quot;} {:command &quot;(defn home-page [request]\n\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:html\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:body\n     [:div \&quot;Nista se ne desava\&quot;]\n     [:button {:hx-post \&quot;/klik\&quot;\n               :hx-swap \&quot;innerHTML\&quot;\n               :hx-target \&quot;closest div\&quot;\n               }\n      \&quot;BUTTON\&quot;]]]})\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:p {:style \&quot;color: blue; font-weight: bold;\&quot;}\n    \&quot;click done\&quot;]\n   })&quot;, :offset 517, :ns &quot;web.server&quot;} {:command &quot;(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))&quot;, :offset 213, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [project.api :as api]\n            [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [hiccup.page :refer [html5]\n             ]\n            )\n  (:import (java.time LocalDate)\n           (java.time.format DateTimeFormatter)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n   (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn home-page [request]\n\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:html\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:body\n     [:div \&quot;Nista se ne desava\&quot;]\n     [:button {:hx-post \&quot;/klik\&quot;\n               :hx-swap \&quot;innerHTML\&quot;\n               :hx-target \&quot;closest div\&quot;\n               }\n      \&quot;BUTTON\&quot;]]]})\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:p {:style \&quot;color: blue; font-weight: bold;\&quot;}\n    \&quot;click done\&quot;]\n   })\n\n\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 2221, :ns &quot;project.core&quot;} {:command &quot;(start-server)&quot;, :offset 13, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [hiccup.page :refer [html5]]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str])\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)))&quot;, :offset 446, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [hiccup.page :refer [html5]]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str])\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n   (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn home-page [request]\n\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:html\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:body\n     [:div \&quot;Nista se ne desava\&quot;]\n     [:button {:hx-post \&quot;/klik\&quot;\n               :hx-swap \&quot;innerHTML\&quot;\n               :hx-target \&quot;closest div\&quot;\n               }\n      \&quot;BUTTON\&quot;]]]})\n\n(defn click-handler [request]\n  {:status 200\n   :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n   :body\n   [:p {:style \&quot;color: blue; font-weight: bold;\&quot;}\n    \&quot;click done\&quot;]\n   })\n\n\n\n(def app\n  (ring/ring-handler\n    (ring/router [\n                  [\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/klik\&quot; {:post click-handler}]\n                                   ])\n    (ring/create-default-handler)))\n\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.close s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.interrupt s)\n    (reset! server nil)))&quot;, :offset 2389, :ns &quot;web.server&quot;}], :remote []}}</component>
  <component name="RunManager" selected="Clojure REPL.REPL for ProjectV1">
    <configuration default="true" type="Babashka" factoryName="BabashkaLocalRepl" activateToolWindowBeforeRun="false">
      <setting name="displayName" value="" />
      <setting name="bbPath" value="" />
      <setting name="parameters" value="" />
      <option name="PARENT_ENVS" value="true" />
      <setting name="workingDir" value="" />
      <setting name="focusEditor" value="false" />
      <method v="2">
        <option name="Make" enabled="true" />
      </method>
    </configuration>
    <configuration name="REPL for ProjectV1" type="ClojureREPL" factoryName="Local" activateToolWindowBeforeRun="false">
      <option name="configVersion" value="1" />
      <option name="displayName" value="REPL for ProjectV1" />
      <option name="execution" value="LEININGEN" />
      <module name="ProjectV1" />
      <option name="options" />
      <option name="profiles" />
      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
      <method v="2" />
    </configuration>
    <configuration default="true" type="ClojureREPL" factoryName="Local" activateToolWindowBeforeRun="false">
      <option name="configVersion" value="1" />
      <option name="options" />
      <option name="profiles" />
      <method v="2" />
    </configuration>
    <configuration default="true" type="ClojureREPL" factoryName="Remote" activateToolWindowBeforeRun="false">
      <setting name="displayName" value="" />
      <setting name="host" value="" />
      <setting name="port" value="0" />
      <setting name="replType" value="SOCKET" />
      <setting name="configType" value="SPECIFY" />
      <setting name="replPortFileType" value="STANDARD" />
      <setting name="customPortFile" value="" />
      <setting name="fixLineNumbers" value="false" />
      <setting name="useHeartbeat" value="true" />
      <setting name="focusEditor" value="false" />
      <setting name="urlFile" value="" />
      <method v="2" />
    </configuration>
    <configuration name="Test project.api-test/delta-test" type="ClojureTestRunConfiguration" factoryName="clojure.test" temporary="true">
      <module name="ProjectV1" />
      <option name="selector" value="SINGLE_VAR" />
      <option name="varFqn" value="project.api-test/delta-test" />
      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
      <method v="2" />
    </configuration>
    <configuration name="Test project.api-test/leaderboard-rank-ties-test" type="ClojureTestRunConfiguration" factoryName="clojure.test" temporary="true">
      <module name="ProjectV1" />
      <option name="selector" value="SINGLE_VAR" />
      <option name="varFqn" value="project.api-test/leaderboard-rank-ties-test" />
      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
      <method v="2" />
    </configuration>
    <recent_temporary>
      <list>
        <item itemvalue="clojure.test.Test project.api-test/delta-test" />
        <item itemvalue="clojure.test.Test project.api-test/leaderboard-rank-ties-test" />
      </list>
    </recent_temporary>
  </component>
  <component name="SharedIndexes">
    <attachedChunks>
      <set>
        <option value="bundled-jdk-9823dce3aa75-fbdcb00ec9e3-intellij.indexing.shared.core-IU-251.25410.129" />
        <option value="bundled-js-predefined-d6986cc7102b-6a121458b545-JavaScript-IU-251.25410.129" />
      </set>
    </attachedChunks>
  </component>
  <component name="TaskManager">
    <task active="true" id="Default" summary="Default task">
      <changelist id="4d338447-6f3a-43e8-ab8c-95e214f36644" name="Changes" comment="" />
      <created>1767121985479</created>
      <option name="number" value="Default" />
      <option name="presentableId" value="Default" />
      <updated>1767121985479</updated>
      <workItem from="1767121986415" duration="3674000" />
      <workItem from="1767181139032" duration="1494000" />
      <workItem from="1767351215899" duration="6476000" />
      <workItem from="1767379148928" duration="2673000" />
      <workItem from="1767381868455" duration="67000" />
      <workItem from="1767472762290" duration="1088000" />
      <workItem from="1767537145030" duration="11000" />
      <workItem from="1767625268145" duration="5102000" />
      <workItem from="1767694847080" duration="18149000" />
      <workItem from="1767804228503" duration="9080000" />
      <workItem from="1767892649731" duration="8974000" />
      <workItem from="1767906416609" duration="6067000" />
      <workItem from="1767958972899" duration="595000" />
      <workItem from="1768070963735" duration="14388000" />
      <workItem from="1768129866250" duration="9988000" />
      <workItem from="1768149678456" duration="13189000" />
      <workItem from="1768171748332" duration="36000" />
      <workItem from="1768403682096" duration="4369000" />
      <workItem from="1768474526888" duration="8177000" />
      <workItem from="1768491610839" duration="3377000" />
      <workItem from="1768587661011" duration="10613000" />
      <workItem from="1768638813832" duration="14723000" />
      <workItem from="1768662775460" duration="5330000" />
      <workItem from="1768736915225" duration="291000" />
      <workItem from="1768771507620" duration="5414000" />
      <workItem from="1768808685053" duration="10422000" />
      <workItem from="1768828344403" duration="6339000" />
      <workItem from="1768841963659" duration="9097000" />
      <workItem from="1768919011338" duration="96000" />
      <workItem from="1769022282280" duration="7836000" />
      <workItem from="1769075977686" duration="8791000" />
      <workItem from="1769089486580" duration="5158000" />
      <workItem from="1769124897316" duration="72000" />
      <workItem from="1769184242641" duration="3047000" />
      <workItem from="1769250460539" duration="3000" />
      <workItem from="1769333055758" duration="3673000" />
      <workItem from="1769361640551" duration="10655000" />
      <workItem from="1769419857978" duration="8893000" />
    </task>
    <task id="LOCAL-00001" summary="Ucitan je Datomic, sad vezbam koriscenje kroz dokumentaciju">
      <option name="closed" value="true" />
      <created>1767125847824</created>
      <option name="number" value="00001" />
      <option name="presentableId" value="LOCAL-00001" />
      <option name="project" value="LOCAL" />
      <updated>1767125847824</updated>
    </task>
    <task id="LOCAL-00002" summary="Dodate neke default funkcije koje rade sa bazom u datomicu">
      <option name="closed" value="true" />
      <created>1767367199446</created>
      <option name="number" value="00002" />
      <option name="presentableId" value="LOCAL-00002" />
      <option name="project" value="LOCAL" />
      <updated>1767367199446</updated>
    </task>
    <task id="LOCAL-00003" summary="Uradjene kreiraj korisnika i dodaj xp u bazi">
      <option name="closed" value="true" />
      <created>1767381886292</created>
      <option name="number" value="00003" />
      <option name="presentableId" value="LOCAL-00003" />
      <option name="project" value="LOCAL" />
      <updated>1767381886292</updated>
    </task>
    <task id="LOCAL-00004" summary="Uradjene kreiraj korisnika i dodaj xp u bazi 2">
      <option name="closed" value="true" />
      <created>1767483540530</created>
      <option name="number" value="00004" />
      <option name="presentableId" value="LOCAL-00004" />
      <option name="project" value="LOCAL" />
      <updated>1767483540530</updated>
    </task>
    <task id="LOCAL-00005" summary="Provezbana funkcija add-xp">
      <option name="closed" value="true" />
      <created>1767634382925</created>
      <option name="number" value="00005" />
      <option name="presentableId" value="LOCAL-00005" />
      <option name="project" value="LOCAL" />
      <updated>1767634382925</updated>
    </task>
    <task id="LOCAL-00006" summary="transakciona funkcija koja dodaje xp useru, kreirana sema aktivnosti/event koje user izvrsava da bi dobio xp, &#10;kreirana sema tipa aktivnosti koja ima main tip aktivnosti.&#10;odvajam kod u dva paketa db i main paket, &#10;i db.clj u dva fajla schema.clj, seed.clj gde cu imati back ako mi se nesto zezne kao na primer da ubacim dva worka...">
      <option name="closed" value="true" />
      <created>1767734960862</created>
      <option name="number" value="00006" />
      <option name="presentableId" value="LOCAL-00006" />
      <option name="project" value="LOCAL" />
      <updated>1767734960862</updated>
    </task>
    <task id="LOCAL-00007" summary="transakciona funkcija koja dodaje xp useru, kreirana sema aktivnosti/event koje user izvrsava da bi dobio xp, &#10;kreirana sema tipa aktivnosti koja ima main tip aktivnosti.&#10;odvajam kod u dva paketa db i main paket, &#10;i db.clj u dva fajla schema.clj, seed.clj gde cu imati back ako mi se nesto zezne kao na primer da ubacim dva worka...">
      <option name="closed" value="true" />
      <created>1767734966394</created>
      <option name="number" value="00007" />
      <option name="presentableId" value="LOCAL-00007" />
      <option name="project" value="LOCAL" />
      <updated>1767734966394</updated>
    </task>
    <task id="LOCAL-00008" summary="Uh, datomic je malo naporan iskreno, ali zanimljiv jer je sve kao u clojuru. Odvojio sam scheme i seed, pohvatao sam fazon sa transakcijama, i kako se sta pise">
      <option name="closed" value="true" />
      <created>1767742945250</created>
      <option name="number" value="00008" />
      <option name="presentableId" value="LOCAL-00008" />
      <option name="project" value="LOCAL" />
      <updated>1767742945250</updated>
    </task>
    <task id="LOCAL-00009" summary="Kreirana funkcija activity/add, sustina app, na osnovu parametara se izracuna xp za odredjenu aktivnost">
      <option name="closed" value="true" />
      <created>1767812289892</created>
      <option name="number" value="00009" />
      <option name="presentableId" value="LOCAL-00009" />
      <option name="project" value="LOCAL" />
      <updated>1767812289893</updated>
    </task>
    <task id="LOCAL-00010" summary="Fixed add-activity-tx,&#10;user-activities -&gt; query for finding all activities of one user">
      <option name="closed" value="true" />
      <created>1767902122657</created>
      <option name="number" value="00010" />
      <option name="presentableId" value="LOCAL-00010" />
      <option name="project" value="LOCAL" />
      <updated>1767902122657</updated>
    </task>
    <task id="LOCAL-00011" summary="Daily activities by user - list of every activity done in one day.&#10;Daily-xp - user can be put in leaderboard to compete and compare daily activities with other people.">
      <option name="closed" value="true" />
      <created>1767915212637</created>
      <option name="number" value="00011" />
      <option name="presentableId" value="LOCAL-00011" />
      <option name="project" value="LOCAL" />
      <updated>1767915212637</updated>
    </task>
    <task id="LOCAL-00012" summary="Daily, Weekly and Monthly activities and xp per user">
      <option name="closed" value="true" />
      <created>1768083937606</created>
      <option name="number" value="00012" />
      <option name="presentableId" value="LOCAL-00012" />
      <option name="project" value="LOCAL" />
      <updated>1768083937606</updated>
    </task>
    <task id="LOCAL-00013" summary="Daily, Weekly and Monthly activities and xp per user">
      <option name="closed" value="true" />
      <created>1768085174478</created>
      <option name="number" value="00013" />
      <option name="presentableId" value="LOCAL-00013" />
      <option name="project" value="LOCAL" />
      <updated>1768085174478</updated>
    </task>
    <task id="LOCAL-00014" summary="Fixing old code, erasing and moving unnecessary and outdated functions. &#10;Setting up better architecture, more readable">
      <option name="closed" value="true" />
      <created>1768162612523</created>
      <option name="number" value="00014" />
      <option name="presentableId" value="LOCAL-00014" />
      <option name="project" value="LOCAL" />
      <updated>1768162612523</updated>
    </task>
    <task id="LOCAL-00015" summary="Testing of malli validation">
      <option name="closed" value="true" />
      <created>1768165269540</created>
      <option name="number" value="00015" />
      <option name="presentableId" value="LOCAL-00015" />
      <option name="project" value="LOCAL" />
      <updated>1768165269540</updated>
    </task>
    <task id="LOCAL-00016" summary="Malli validation, validate! function">
      <option name="closed" value="true" />
      <created>1768167032069</created>
      <option name="number" value="00016" />
      <option name="presentableId" value="LOCAL-00016" />
      <option name="project" value="LOCAL" />
      <updated>1768167032069</updated>
    </task>
    <task id="LOCAL-00017" summary="Validation of transaction function add-activity and create user">
      <option name="closed" value="true" />
      <created>1768169307460</created>
      <option name="number" value="00017" />
      <option name="presentableId" value="LOCAL-00017" />
      <option name="project" value="LOCAL" />
      <updated>1768169307460</updated>
    </task>
    <task id="LOCAL-00018" summary="Leaderboard for one day, week and month">
      <option name="closed" value="true" />
      <created>1768495590013</created>
      <option name="number" value="00018" />
      <option name="presentableId" value="LOCAL-00018" />
      <option name="project" value="LOCAL" />
      <updated>1768495590013</updated>
    </task>
    <task id="LOCAL-00019" summary="Leaderboard finito">
      <option name="closed" value="true" />
      <created>1768592793347</created>
      <option name="number" value="00019" />
      <option name="presentableId" value="LOCAL-00019" />
      <option name="project" value="LOCAL" />
      <updated>1768592793347</updated>
    </task>
    <task id="LOCAL-00020" summary="Leaderboard finito 2, merged daily, weekly, monthly leaderboard function in one function, all time leaderboard is still by itself">
      <option name="closed" value="true" />
      <created>1768600694449</created>
      <option name="number" value="00020" />
      <option name="presentableId" value="LOCAL-00020" />
      <option name="project" value="LOCAL" />
      <updated>1768600694449</updated>
    </task>
    <task id="LOCAL-00021" summary="Leaderboard finito 3, i merged even all-time in default leaderboard fn, so now code is clearer and less messy. Deleted unnecessary fucntion i no longer use. Added 3 tests for 2 for adding activity and 1 for leaderboard.">
      <option name="closed" value="true" />
      <created>1768661297153</created>
      <option name="number" value="00021" />
      <option name="presentableId" value="LOCAL-00021" />
      <option name="project" value="LOCAL" />
      <updated>1768661297153</updated>
    </task>
    <task id="LOCAL-00022" summary="API preparing for frontend, did some validation">
      <option name="closed" value="true" />
      <created>1768779315145</created>
      <option name="number" value="00022" />
      <option name="presentableId" value="LOCAL-00022" />
      <option name="project" value="LOCAL" />
      <updated>1768779315145</updated>
    </task>
    <task id="LOCAL-00023" summary="Leaderboard with rank and ties in xp">
      <option name="closed" value="true" />
      <created>1768833163143</created>
      <option name="number" value="00023" />
      <option name="presentableId" value="LOCAL-00023" />
      <option name="project" value="LOCAL" />
      <updated>1768833163143</updated>
    </task>
    <task id="LOCAL-00024" summary="Leaderboard delta, calculate changes in rank">
      <option name="closed" value="true" />
      <created>1768855602635</created>
      <option name="number" value="00024" />
      <option name="presentableId" value="LOCAL-00024" />
      <option name="project" value="LOCAL" />
      <updated>1768855602635</updated>
    </task>
    <task id="LOCAL-00025" summary="Leaderboard delta still">
      <option name="closed" value="true" />
      <created>1768859643777</created>
      <option name="number" value="00025" />
      <option name="presentableId" value="LOCAL-00025" />
      <option name="project" value="LOCAL" />
      <updated>1768859643777</updated>
    </task>
    <task id="LOCAL-00026" summary="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;I failed today, it needs fix tomorrow.">
      <option name="closed" value="true" />
      <created>1769039313571</created>
      <option name="number" value="00026" />
      <option name="presentableId" value="LOCAL-00026" />
      <option name="project" value="LOCAL" />
      <updated>1769039313571</updated>
    </task>
    <task id="LOCAL-00027" summary="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;Fixed, problem was in test data">
      <option name="closed" value="true" />
      <created>1769078211847</created>
      <option name="number" value="00027" />
      <option name="presentableId" value="LOCAL-00027" />
      <option name="project" value="LOCAL" />
      <updated>1769078211847</updated>
    </task>
    <task id="LOCAL-00028" summary="Change to clojure.test, done 2 tests">
      <option name="closed" value="true" />
      <created>1769124957289</created>
      <option name="number" value="00028" />
      <option name="presentableId" value="LOCAL-00028" />
      <option name="project" value="LOCAL" />
      <updated>1769124957289</updated>
    </task>
    <task id="LOCAL-00029" summary="Front end using htmx with hiccup.Using ring for web server and metosin reitit for routes/ with hiccup. &#10;Server is up, and most basic leaderboard is shown.">
      <option name="closed" value="true" />
      <created>1769377318034</created>
      <option name="number" value="00029" />
      <option name="presentableId" value="LOCAL-00029" />
      <option name="project" value="LOCAL" />
      <updated>1769377318034</updated>
    </task>
    <option name="localTasksCounter" value="30" />
    <servers />
  </component>
  <component name="TypeScriptGeneratedFilesManager">
    <option name="version" value="3" />
  </component>
  <component name="Vcs.Log.Tabs.Properties">
    <option name="TAB_STATES">
      <map>
        <entry key="MAIN">
          <value>
            <State />
          </value>
        </entry>
      </map>
    </option>
  </component>
  <component name="VcsManagerConfiguration">
    <MESSAGE value="Uradjene kreiraj korisnika i dodaj xp u bazi 2" />
    <MESSAGE value="Provezbana funkcija add-xp" />
    <MESSAGE value="transakciona funkcija koja dodaje xp useru, kreirana sema aktivnosti/event koje user izvrsava da bi dobio xp, &#10;kreirana sema tipa aktivnosti koja ima main tip aktivnosti" />
    <MESSAGE value="transakciona funkcija koja dodaje xp useru, kreirana sema aktivnosti/event koje user izvrsava da bi dobio xp, &#10;kreirana sema tipa aktivnosti koja ima main tip aktivnosti.&#10;odvajam kod u dva paketa db i main paket, &#10;i db.clj u dva fajla schema.clj, seed.clj gde cu imati back ako mi se nesto zezne kao na primer da ubacim dva worka..." />
    <MESSAGE value="Uh, datomic je malo naporan iskreno, ali zanimljiv jer je sve kao u clojuru. Odvojio sam scheme i seed, pohvatao sam fazon sa transakcijama, i kako se sta pise" />
    <MESSAGE value="Kreirana funkcija activity/add, sustina app, na osnovu parametara se izracuna xp za odredjenu aktivnost" />
    <MESSAGE value="Fixed add-activity-tx,&#10;user-activities -&gt; query for finding all activities of one user" />
    <MESSAGE value="Daily activities by user - list of every activity done in one day.&#10;Daily-xp - user can be put in leaderboard to compete and compare daily activities with other people." />
    <MESSAGE value="Daily, Weekly and Monthly activities and xp per user" />
    <MESSAGE value="Fixing old code, erasing and moving unnecessary and outdated functions. &#10;Setting up better architecture, more readable" />
    <MESSAGE value="Testing of malli validation" />
    <MESSAGE value="Malli validation, validate! function" />
    <MESSAGE value="Validation of transaction function add-activity and create user" />
    <MESSAGE value="Leaderboard for one day, week and month" />
    <MESSAGE value="Leaderboard finito" />
    <MESSAGE value="Leaderboard finito 2, merged daily, weekly, monthly leaderboard function in one function, all time leaderboard is still by itself" />
    <MESSAGE value="Leaderboard finito 3, i merged even all-time in default leaderboard fn, so now code is clearer and less messy. Deleted unnecessary fucntion i no longer use. Added 3 tests for 2 for adding activity and 1 for leaderboard." />
    <MESSAGE value="API preparing for frontend, did some validation" />
    <MESSAGE value="Leaderboard with rank and ties in xp" />
    <MESSAGE value="Leaderboard delta, calculate changes in rank" />
    <MESSAGE value="Leaderboard delta still" />
    <MESSAGE value="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;I failed today, it needs fix tomorrow." />
    <MESSAGE value="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;Fixed, problem was in test data" />
    <MESSAGE value="Change to clojure.test, done 2 tests" />
    <MESSAGE value="Front end using htmx with hiccup.Using ring for web server and metosin reitit for routes/ with hiccup. &#10;Server is up, and most basic leaderboard is shown." />
    <option name="LAST_COMMIT_MESSAGE" value="Front end using htmx with hiccup.Using ring for web server and metosin reitit for routes/ with hiccup. &#10;Server is up, and most basic leaderboard is shown." />
  </component>
</project>