<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="AutoImportSettings">
    <option name="autoReloadType" value="SELECTIVE" />
  </component>
  <component name="ChangeListManager">
    <list default="true" id="4d338447-6f3a-43e8-ab8c-95e214f36644" name="Changes" comment="Time table now shows">
      <change beforePath="$PROJECT_DIR$/.idea/workspace.xml" beforeDir="false" afterPath="$PROJECT_DIR$/.idea/workspace.xml" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/.nrepl-port" beforeDir="false" afterPath="$PROJECT_DIR$/.nrepl-port" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/src/project/db.clj" beforeDir="false" afterPath="$PROJECT_DIR$/src/project/db.clj" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/src/project/time.clj" beforeDir="false" afterPath="$PROJECT_DIR$/src/project/time.clj" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/src/project/web.clj" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/src/project/xp.clj" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/src/web/server.clj" beforeDir="false" afterPath="$PROJECT_DIR$/src/web/server.clj" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/target/classes/META-INF/maven/ProjectV1/ProjectV1/pom.properties" beforeDir="false" afterPath="$PROJECT_DIR$/target/classes/META-INF/maven/ProjectV1/ProjectV1/pom.properties" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/target/repl-port" beforeDir="false" afterPath="$PROJECT_DIR$/target/repl-port" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/test/project/api_test.clj" beforeDir="false" afterPath="$PROJECT_DIR$/test/project/api_test.clj" afterDir="false" />
    </list>
    <option name="SHOW_DIALOG" value="false" />
    <option name="HIGHLIGHT_CONFLICTS" value="true" />
    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
    <option name="LAST_RESOLUTION" value="IGNORE" />
  </component>
  <component name="FileTemplateManagerImpl">
    <option name="RECENT_TEMPLATES">
      <list>
        <option value="Clojure Test Namespace" />
        <option value="Clojure Namespace" />
      </list>
    </option>
  </component>
  <component name="Git.Settings">
    <option name="RECENT_GIT_ROOT_PATH" value="$PROJECT_DIR$" />
  </component>
  <component name="GitHubPullRequestSearchHistory">{
  &quot;lastFilter&quot;: {
    &quot;state&quot;: &quot;OPEN&quot;,
    &quot;assignee&quot;: &quot;micko112&quot;
  }
}</component>
  <component name="GithubPullRequestsUISettings">{
  &quot;selectedUrlAndAccountId&quot;: {
    &quot;url&quot;: &quot;https://github.com/micko112/ClojureProject.git&quot;,
    &quot;accountId&quot;: &quot;3764571a-842a-40c7-838d-20632f3769b4&quot;
  }
}</component>
  <component name="HighlightingSettingsPerFile">
    <setting file="file://$PROJECT_DIR$/src/project/db.clj" root0="FORCE_HIGHLIGHTING" />
  </component>
  <component name="ProjectColorInfo">{
  &quot;associatedIndex&quot;: 5
}</component>
  <component name="ProjectId" id="37ZsZpPnuy4tgd50LQGXH7cfGlR" />
  <component name="ProjectViewState">
    <option name="hideEmptyMiddlePackages" value="true" />
    <option name="showLibraryContents" value="true" />
  </component>
  <component name="PropertiesComponent">{
  &quot;keyToString&quot;: {
    &quot;Clojure REPL.REPL for ProjectV1.executor&quot;: &quot;Run&quot;,
    &quot;ModuleVcsDetector.initialDetectionPerformed&quot;: &quot;true&quot;,
    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,
    &quot;RunOnceActivity.git.unshallow&quot;: &quot;true&quot;,
    &quot;SHARE_PROJECT_CONFIGURATION_FILES&quot;: &quot;true&quot;,
    &quot;clojure.test.Test project.api-test/delta-test.executor&quot;: &quot;Run&quot;,
    &quot;clojure.test.Test project.api-test/leaderboard-rank-ties-test.executor&quot;: &quot;Run&quot;,
    &quot;cursive.last.file.extension.C\\:/xampp/htdocs/Clojure/Clojure for Brave and True/ProjectV1/src&quot;: &quot;clj&quot;,
    &quot;cursive.last.file.extension.C\\:/xampp/htdocs/Clojure/Clojure for Brave and True/ProjectV1/test&quot;: &quot;clj&quot;,
    &quot;git-widget-placeholder&quot;: &quot;main&quot;,
    &quot;last_opened_file_path&quot;: &quot;C:/xampp/htdocs/Clojure/Clojure for Brave and True/ProjectV1/project.clj&quot;,
    &quot;node.js.detected.package.eslint&quot;: &quot;true&quot;,
    &quot;node.js.detected.package.tslint&quot;: &quot;true&quot;,
    &quot;node.js.selected.package.eslint&quot;: &quot;(autodetect)&quot;,
    &quot;node.js.selected.package.tslint&quot;: &quot;(autodetect)&quot;,
    &quot;nodejs_package_manager_path&quot;: &quot;npm&quot;,
    &quot;settings.editor.selected.configurable&quot;: &quot;editor.preferences.gutterIcons&quot;,
    &quot;vue.rearranger.settings.migration&quot;: &quot;true&quot;
  },
  &quot;keyToStringList&quot;: {
    &quot;GitStage.ChangesTree.GroupingKeys&quot;: [
      &quot;directory&quot;,
      &quot;module&quot;,
      &quot;repository&quot;
    ]
  }
}</component>
  <component name="RecentsManager">
    <key name="MoveFile.RECENT_KEYS">
      <recent name="C:\xampp\htdocs\Clojure\Clojure for Brave and True\ProjectV1\src\playground" />
    </key>
  </component>
  <component name="ReplState" timestamp="1771007261016">{:repl-history {:ide [], :local [{:command &quot;(ns project.system\n  (:require [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed-db]))\n\n(def db-uri \&quot;datomic:dev://localhost:4334/bebetter\&quot;)\n\n(defonce conn (d/connect db-uri))\n\n(defn reset-db! [all-tx-functions]\n  (println \&quot;Brisem bazu...\&quot;)\n  (d/delete-database db-uri)\n  (println \&quot;Kreiram bazu...\&quot;)\n  (d/create-database db-uri)\n  (let [new-conn (d/connect db-uri)]\n    (println \&quot;Ubacujem semu...\&quot;)\n    @(d/transact new-conn schema/all-schemas)\n\n    (println \&quot;Ubacujem seed podatke...\&quot;)\n    @(d/transact new-conn seed-db/all-seed-data)\n\n    (println \&quot;Ubacujem funkcije...\&quot;)\n    @(d/transact new-conn all-tx-functions)\n\n    (println \&quot;Gotovo!\&quot;)\n    ;; Vracamo novu konekciju da mozes da azuriras svoj 'def' ako treba\n    new-conn))&quot;, :offset 776, :ns &quot;project.db&quot;} {:command &quot;(ns project.system\n  (:require [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed-db]))\n\n(def db-uri \&quot;datomic:dev://localhost:4334/bebetter\&quot;)\n\n(defonce conn (d/connect db-uri))\n\n(defn reset-db! [all-tx-functions]\n  (d/delete-database db-uri)\n  (d/create-database db-uri)\n  (let [new-conn (d/connect db-uri)]\n    @(d/transact new-conn schema/all-schemas)\n    @(d/transact new-conn seed-db/all-seed-data)\n    @(d/transact new-conn all-tx-functions)\n    new-conn))&quot;, :offset 507, :ns &quot;project.system&quot;} {:command &quot;@(d/transact s/conn activity-schema)&quot;, :offset 36, :ns &quot;database.schema&quot;} {:command &quot;(ns database.schema\n  (:require [datomic.api :as d]\n            [project.system :as s]))\n\n(def user-schema [{:db/ident       :user/username\n                   :db/valueType   :db.type/string\n                   :db/cardinality :db.cardinality/one\n                   :db/unique      :db.unique/identity\n                   :db/doc         \&quot;Username\&quot;}\n                  {:db/ident       :user/xp\n                   :db/valueType   :db.type/long\n                   :db/cardinality :db.cardinality/one\n                   :db/doc         \&quot;Experience of user\&quot;}])\n;@(d/transact conn user-shema)\n(def activity-schema [{:db/ident :activity/user\n                       :db/valueType :db.type/ref\n                       :db/cardinality :db.cardinality/one\n                       :db/index true\n                       :db/doc \&quot;User who performed activity\&quot;}\n                      {:db/ident :activity/type\n                       :db/valueType :db.type/ref\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Main type of activity (training, work, studying etc.)\&quot;}\n                      {:db/ident :activity/subtype\n                       :db/valueType :db.type/keyword\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Optional type of activity (training, work, studying etc.)\&quot;}\n                      {:db/ident :activity/duration\n                       :db/valueType :db.type/long\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Duration of activity in minutes.\&quot;}\n                      {:db/ident :activity/intensity\n                       :db/valueType :db.type/long\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Intensity of activity on scale 1-5\&quot;}\n\n                      {:db/ident :activity/start-time\n                       :db/valueType :db.type/instant\n                       :db/cardinality :db.cardinality/one\n                       :db/index true\n                       :db/doc \&quot;When activity happened\&quot;}])\n@(d/transact s/conn activity-schema)\n\n(def activity-type-schema [{:db/ident :activity-type/key\n                            :db/valueType :db.type/keyword\n                            :db/cardinality :db.cardinality/one\n                            :db/unique      :db.unique/identity\n                            :db/doc \&quot;Key word type of activity\&quot;}\n                           {:db/ident :activity-type/name\n                            :db/valueType :db.type/string\n                            :db/cardinality :db.cardinality/one\n                            :db/doc \&quot;Name of activity type\&quot;}\n                           {:db/ident :activity-type/xp-per-minute\n                            :db/valueType :db.type/long\n                            :db/cardinality :db.cardinality/one\n                            :db/doc \&quot;Xp per minute\&quot;}])\n;@(d/transact conn activity-type-schema)\n(def all-schemas (concat user-schema activity-schema activity-type-schema))&quot;, :offset 3016, :ns &quot;project.system&quot;} {:command &quot;(d/transact s/conn user-shema)&quot;, :offset 30, :ns &quot;database.schema&quot;} {:command &quot;(ns database.schema\n  (:require [datomic.api :as d]\n            [project.system :as s]))\n\n(def user-schema [{:db/ident       :user/username\n                   :db/valueType   :db.type/string\n                   :db/cardinality :db.cardinality/one\n                   :db/unique      :db.unique/identity\n                   :db/doc         \&quot;Username\&quot;}\n                  {:db/ident       :user/xp\n                   :db/valueType   :db.type/long\n                   :db/cardinality :db.cardinality/one\n                   :db/doc         \&quot;Experience of user\&quot;}])\n@(d/transact s/conn user-shema)\n(def activity-schema [{:db/ident :activity/user\n                       :db/valueType :db.type/ref\n                       :db/cardinality :db.cardinality/one\n                       :db/index true\n                       :db/doc \&quot;User who performed activity\&quot;}\n                      {:db/ident :activity/type\n                       :db/valueType :db.type/ref\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Main type of activity (training, work, studying etc.)\&quot;}\n                      {:db/ident :activity/subtype\n                       :db/valueType :db.type/keyword\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Optional type of activity (training, work, studying etc.)\&quot;}\n                      {:db/ident :activity/duration\n                       :db/valueType :db.type/long\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Duration of activity in minutes.\&quot;}\n                      {:db/ident :activity/intensity\n                       :db/valueType :db.type/long\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Intensity of activity on scale 1-5\&quot;}\n\n                      {:db/ident :activity/start-time\n                       :db/valueType :db.type/instant\n                       :db/cardinality :db.cardinality/one\n                       :db/index true\n                       :db/doc \&quot;When activity happened\&quot;}])\n@(d/transact s/conn activity-schema)\n\n(def activity-type-schema [{:db/ident :activity-type/key\n                            :db/valueType :db.type/keyword\n                            :db/cardinality :db.cardinality/one\n                            :db/unique      :db.unique/identity\n                            :db/doc \&quot;Key word type of activity\&quot;}\n                           {:db/ident :activity-type/name\n                            :db/valueType :db.type/string\n                            :db/cardinality :db.cardinality/one\n                            :db/doc \&quot;Name of activity type\&quot;}\n                           {:db/ident :activity-type/xp-per-minute\n                            :db/valueType :db.type/long\n                            :db/cardinality :db.cardinality/one\n                            :db/doc \&quot;Xp per minute\&quot;}])\n@(d/transact s/conn activity-type-schema)\n(def all-schemas (concat user-schema activity-schema activity-type-schema))&quot;, :offset 3018, :ns &quot;database.schema&quot;} {:command &quot;(s/reset-db! get-all-tx-functions)&quot;, :offset 33, :ns &quot;project.db&quot;} {:command &quot;@(d/transact s/conn user-shema)&quot;, :offset 31, :ns &quot;database.schema&quot;} {:command &quot;(ns database.schema\n  (:require [datomic.api :as d]\n            [project.system :as s]))&quot;, :offset 88, :ns &quot;project.core&quot;} {:command &quot;(ns database.schema\n  (:require [datomic.api :as d]\n            [project.system :as s]\n            [project.connection :as conn]))&quot;, :offset 130, :ns &quot;project.core&quot;} {:command &quot;(ns database.schema\n  (:require [datomic.api :as d]\n            \n            [project.connection :as conn]))&quot;, :offset 108, :ns &quot;project.core&quot;} {:command &quot;@(d/transact conn/conn user-shema)&quot;, :offset 34, :ns &quot;database.schema&quot;} {:command &quot;(def user-schema [{:db/ident       :user/username\n                   :db/valueType   :db.type/string\n                   :db/cardinality :db.cardinality/one\n                   :db/unique      :db.unique/identity\n                   :db/doc         \&quot;Username\&quot;}\n                  {:db/ident       :user/xp\n                   :db/valueType   :db.type/long\n                   :db/cardinality :db.cardinality/one\n                   :db/doc         \&quot;Experience of user\&quot;}])&quot;, :offset 464, :ns &quot;database.schema&quot;} {:command &quot;@(d/transact conn/conn user-schema)&quot;, :offset 35, :ns &quot;database.schema&quot;} {:command &quot;(defn report-daily-in-period [db username date]\n  ;total xp u danu\n  (let [{:keys [start-day end-day]} ((get period-interval :daily) date)\n        rows (get-activities-in-interval db username start-day end-day)\n        activities-xp (map (fn [[start-time a-type dur int xp-per-min]]\n                             {:activity/time (.toLocalTime (t/instant-&gt;local start-time))\n                              :activity/type a-type\n                              :activity/duration dur\n                              :activity/intensity int\n                              :activity/xp (* dur int xp-per-min)}) rows)\n        total-xp (calculate-xp-from-rows rows)]\n\n    {:date date\n     :username username\n     :activities activities-xp\n     :total-xp total-xp}))&quot;, :offset 752, :ns &quot;project.db&quot;} {:command &quot;(defn xp-per-user [db username period date]\n  ; slucaj kad je samo all\n  (if (= period :all)\n    (:user/xp (get-user-by-name db username))\n    ;---------------------\n    (let [{:keys [start-day end-day]} ((get period-interval period) date)\n          rows (get-activities-in-interval db username start-day end-day)]\n      (calculate-xp-from-rows rows))))&quot;, :offset 353, :ns &quot;project.db&quot;} {:command &quot;(defn usernames-xp [db] (vec (d/q '[:find ?username ?xp\n                                    :where [?u :user/username ?username]\n                                    [?u :user/xp ?xp]] db)))&quot;, :offset 189, :ns &quot;project.db&quot;} {:command &quot;(def add-activity-tx\n  {:db/ident :activity/add\n   :db/fn (d/function\n           '{:lang \&quot;clojure\&quot;\n             :params [db username activity-type-key duration intensity start-time]\n             :code (let [user-e\n                         (d/q '[:find ?e .\n                                :in $ ?username\n                                :where [?e :user/username ?username]]\n                              db username)\n                         [act-type-e xp-per-min]\n                         (first (d/q '[:find ?e ?xp-per-minute\n                                       :in $ ?type\n                                       :where [?e :activity-type/key ?type]\n                                       [?e :activity-type/xp-per-minute ?xp-per-minute]] db activity-type-key))\n                         gained-xp (* duration xp-per-min intensity)\n\n                         current-xp (or (:user/xp (d/entity db user-e)) 0)\n\n                         new-xp (+ current-xp gained-xp)\n                         activity-id (d/tempid :db.part/user)]\n                     [{:db/id activity-id\n                       :activity/user user-e\n                       :activity/type act-type-e\n                       :activity/duration duration\n                       :activity/intensity intensity\n                       :activity/start-time start-time}\n                      [:db/add user-e :user/xp new-xp]])})})\n\n(def get-all-tx-functions [add-xp-tx add-activity-tx])&quot;, :offset 1447, :ns &quot;project.db&quot;} {:command &quot;(defn add-xp [conn db username xp-to-add]\n  (let [[e current-xp]\n        (first (d/q '[:find ?e ?xp\n                      :in $ ?username\n                      :where [?e :user/username ?username]\n                      [?e :user/xp ?xp]]\n                    db username))\n        new-xp (+ current-xp xp-to-add)]\n    @(d/transact conn [[:db/add e :user/xp new-xp]])))\n\n(def add-xp-tx {:db/ident :user/add-xp\n                :db/fn (d/function\n                        '{:lang \&quot;clojure\&quot;\n                          :params [db username xp]\n                          :code (let [[e current-xp]\n                                      (first (d/q '[:find ?e ?xp\n                                                    :in $ ?username\n                                                    :where [?e :user/username ?username]\n                                                    [?e :user/xp ?xp]] db username))]\n                                  [[:db/add e :user/xp (+ current-xp xp)]])})})&quot;, :offset 976, :ns &quot;project.db&quot;} {:command &quot;(defn calculate-xp-from-rows [rows]\n  (reduce (fn [total-xp [_ _ dur int xp-per-min]]\n            (+ total-xp (* dur int xp-per-min)))\n          0\n          rows))\n\n(def period-interval\n  {:daily t/day-interval\n   :weekly t/week-interval\n   :monthly t/month-interval\n   :all     nil})&quot;, :offset 284, :ns &quot;project.db&quot;} {:command &quot;(defn get-user-activities [db username]\n  (d/q '[:find ?a-start-time ?a-type ?a-duration ?a-intensity ?xp-per-min\n         :in $ ?username\n         :where  [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?a-type]\n         [?a :activity/intensity ?a-intensity]\n         [?a :activity/duration ?a-duration]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [?a :activity/start-time ?a-start-time]] db username))\n\n(defn get-activities-in-interval\n  [db username start-day end-day]\n  (d/q '[:find ?start-time ?type-name ?dur ?int ?xp-per-min\n         :in $ ?username ?start ?end\n         :where\n         [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/start-time ?start-time]\n         [?a :activity/duration ?dur]\n         [?a :activity/intensity ?int]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?type-name]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [(&gt;= ?start-time ?start)]\n         [(&lt; ?start-time ?end)]]\n       db username start-day end-day))&quot;, :offset 1117, :ns &quot;project.db&quot;} {:command &quot;(defn user-ids [db] (d/q '[:find ?e .\n                           :where [?e :user/username]] db))\n\n(defn get-all-users [db] (map first (d/q '[:find (pull ?e [*])\n                                           :where [?e :user/username]] db)))\n\n(defn get-user-by-name [db username]\n  (let [result (d/pull db \&quot;[*]\&quot; [:user/username username])]\n    (if (:db/id result) result (throw (ex-info \&quot;User not found\&quot; {:user/username username})))))&quot;, :offset 431, :ns &quot;project.db&quot;} {:command &quot;(defn create-user! [conn name]\n  (v/validate! v/CreateUserInput {:username name})\n  @(d/transact conn [{:user/username name\n                      :user/xp 0}]))\n\n(defn add-activity! [conn username activity-key duration intensity start-time]\n  (v/validate! v/AddActivityInput {:username username\n                                   :activity-type activity-key\n                                   :duration duration\n                                   :intensity intensity\n                                   :start-time start-time})\n  @(d/transact conn [[:activity/add username activity-key duration intensity start-time]]))&quot;, :offset 619, :ns &quot;project.db&quot;} {:command &quot;(ns project.system\n  (:require [datomic.api :as d]\n            [database.schema :as schema]\n            [database.seed :as seed-db]))\n\n(def db-uri \&quot;datomic:dev://localhost:4334/bebetter\&quot;)\n\n(defonce conn (d/connect db-uri))\n\n(defn reset-db! [all-tx-functions]\n  (d/delete-database db-uri)\n  (d/create-database db-uri)\n  (let [new-conn (d/connect db-uri)]\n    @(d/transact new-conn schema/all-schemas)\n    @(d/transact new-conn seed-db/all-seed-data)\n    @(d/transact new-conn all-tx-functions)\n    (alter-var-root #'conn (constantly new-conn))\n    new-conn))&quot;, :offset 557, :ns &quot;project.db&quot;} {:command &quot;(def all-schemas (concat user-schema activity-schema activity-type-schema))&quot;, :offset 75, :ns &quot;database.schema&quot;} {:command &quot;(ns database.schema\n  (:require [datomic.api :as d]\n\n            [project.connection :as conn]))\n\n(def user-schema [{:db/ident       :user/username\n                   :db/valueType   :db.type/string\n                   :db/cardinality :db.cardinality/one\n                   :db/unique      :db.unique/identity\n                   :db/doc         \&quot;Username\&quot;}\n                  {:db/ident       :user/xp\n                   :db/valueType   :db.type/long\n                   :db/cardinality :db.cardinality/one\n                   :db/doc         \&quot;Experience of user\&quot;}])\n\n(def activity-schema [{:db/ident :activity/user\n                       :db/valueType :db.type/ref\n                       :db/cardinality :db.cardinality/one\n                       :db/index true\n                       :db/doc \&quot;User who performed activity\&quot;}\n                      {:db/ident :activity/type\n                       :db/valueType :db.type/ref\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Main type of activity (training, work, studying etc.)\&quot;}\n                      {:db/ident :activity/subtype\n                       :db/valueType :db.type/keyword\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Optional type of activity (training, work, studying etc.)\&quot;}\n                      {:db/ident :activity/duration\n                       :db/valueType :db.type/long\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Duration of activity in minutes.\&quot;}\n                      {:db/ident :activity/intensity\n                       :db/valueType :db.type/long\n                       :db/cardinality :db.cardinality/one\n                       :db/doc \&quot;Intensity of activity on scale 1-5\&quot;}\n\n                      {:db/ident :activity/start-time\n                       :db/valueType :db.type/instant\n                       :db/cardinality :db.cardinality/one\n                       :db/index true\n                       :db/doc \&quot;When activity happened\&quot;}])\n\n(def activity-type-schema [{:db/ident :activity-type/key\n                            :db/valueType :db.type/keyword\n                            :db/cardinality :db.cardinality/one\n                            :db/unique      :db.unique/identity\n                            :db/doc \&quot;Key word type of activity\&quot;}\n                           {:db/ident :activity-type/name\n                            :db/valueType :db.type/string\n                            :db/cardinality :db.cardinality/one\n                            :db/doc \&quot;Name of activity type\&quot;}\n                           {:db/ident :activity-type/xp-per-minute\n                            :db/valueType :db.type/long\n                            :db/cardinality :db.cardinality/one\n                            :db/doc \&quot;Xp per minute\&quot;}])\n\n(def all-schemas (concat user-schema activity-schema activity-type-schema))&quot;, :offset 2917, :ns &quot;project.system&quot;} {:command &quot;(ns project.db\n  (:require [datomic.api :as d]\n            [clojure.string :as str]\n            [project.time :as t]\n            [project.validation :as v]\n            [project.system :as s]\n            [project.connection :as conn])\n  (:import (java.time LocalDate)))&quot;, :offset 268, :ns &quot;database.schema&quot;} {:command &quot;(get-all-users (d/db conn/conn))&quot;, :offset 30, :ns &quot;project.db&quot;} {:command &quot;(ns project.api\n  (:require [project.system :refer [conn]]\n            [project.db :as db]\n            [project.leaderboard :as lb]\n            [datomic.api :as d]\n            [project.time :as t]\n            [project.validation :as v])\n  (:import (java.time LocalDate)))\n\n(defn log-activity! [username a-key duration intensity start-time]\n  (db/add-activity! conn username a-key duration intensity start-time))\n\n(defn register-user! [username]\n  (v/validate! v/Username username)\n  (db/create-user! conn username))\n\n(defn get-user-profile [username]\n  (v/validate! v/Username username)\n  (db/get-user-by-name (d/db conn) username))\n\n(defn get-leaderboard\n  \&quot;Leaderboard prima :daily, :weekly, :monthly, :all\&quot;\n  [period date]\n  (v/validate! v/Period period)\n  (lb/leaderboard (d/db conn) period date))\n\n(defn get-daily-report [username date]\n  (v/validate! v/Report-input {:username username})\n  (db/report-daily-in-period (d/db conn) username date))\n\n; HOCU DA DODAM FN KOJA RADI REPORT ALI PO DANIMA, STAVIM PERIOD I STAVI MI PO DANIMA\n; STA JE KORISNIK RADIO, AKTIVNOSTI I DAILY-XP I NA KRAJU UKUPNO XP\n\n; vraca mapu: VREME (odnosno dan kad je aktivnost), A-NAME, DURATION, INTENSITY, XP-TOTAL-FOR-DAY\n; (xp-per-user vraca total xp za period sto je super jer moze da vrati daily xp)\n\n&quot;, :offset 1287, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (name (:activity/type db-activity))\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (* 60 hour)\n        height (* duration 60)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-wrapper\n    [:div.calendar-scroll\n     [:div#slots-layer\n      (for [hour (range 24)]\n       [:div.hour-row\n        [:div.hour-label (str hour \&quot;:00\&quot;)]\n        [:div.hour-slot\n         {:hx-get \&quot;/slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;\n\n          }]])]\n     [:div#calendar-form-layer {:style \&quot;position:absolute;\n          top:0;\n          left:0;\n          right:0;\n          height:1440px;\n          z-index:20;\n          pointer-events: none\&quot;}\n      (for [a activities]\n        (activity-&gt;block a))]\n     ]\n    ]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-form-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                              (for [d days]\n                                [:div.day-column\n                                 {:class (when (= d day) \&quot;selected\&quot;)\n                                  :hx-post \&quot;/select-day\&quot;\n                                  :hx-vals (generate-string {:day d})\n                                  :hx-target \&quot;#calendar-view\&quot;\n                                  :hx-swap \&quot;outerHTML\&quot;}\n                                 d])])))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params ]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact sys/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :start-time start-time}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16594, :ns &quot;project.api&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* OSNOVNI RESET */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; background: white; border: 1px solid #e0e0e0; transition: all 0.2s; }\n         .day-column:hover { background-color: #eef2f6; }\n         .day-column.selected { background-color: #2c3e50; color: white; border-color: #2c3e50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n\n         /* KALENDAR KONTEJNER */\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         \n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n\n         .day-grid { flex-grow: 1; position: relative; }\n\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA */\n         .slot-form-container { position: absolute; top: 0; left: 0; right: 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: 1px solid #ddd; z-index: 100; }\n         .slot-form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }\n         .slot-form select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }\n         .slot-form button { padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }\n\n         /* AKTIVNOST */\n         .activity-block { \n             position: absolute; left: 5px; right: 10px; \n             background-color: #e3f2fd; border-left: 4px solid #2196f3; \n             color: #1565c0; padding: 5px 10px; border-radius: 4px; \n             font-size: 13px; font-weight: 500; \n             z-index: 20; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n             overflow: hidden;\n         }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (name (:activity/type db-activity))\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (* 60 hour)\n        height (* duration 60)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-wrapper\n    [:div.calendar-scroll\n     [:div#slots-layer\n      (for [hour (range 24)]\n       [:div.hour-row\n        [:div.hour-label (str hour \&quot;:00\&quot;)]\n        [:div.hour-slot\n         {:hx-get \&quot;/slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;\n\n          }]])]\n     [:div#calendar-form-layer {:style \&quot;position:absolute;\n          top:0;\n          left:0;\n          right:0;\n          height:1440px;\n          z-index:20;\n          pointer-events: none\&quot;}\n      (for [a activities]\n        (activity-&gt;block a))]\n     ]\n    ]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-form-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                              (for [d days]\n                                [:div.day-column\n                                 {:class (when (= d day) \&quot;selected\&quot;)\n                                  :hx-post \&quot;/select-day\&quot;\n                                  :hx-vals (generate-string {:day d})\n                                  :hx-target \&quot;#calendar-view\&quot;\n                                  :hx-swap \&quot;outerHTML\&quot;}\n                                 d])])))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params ]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact sys/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :start-time start-time}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15156, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer [generate-string]]\n            [project.api :as api]\n            [project.system :as sys]\n            [datomic.api :as d]\n            [clojure.string :as str])\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID Date)))\n\n(def port 3000)\n\n;; --- HELPERS ZA VREME ---\n\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n;; --- KONVERZIJA DB -&gt; FRONTEND ---\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (str (:db/id db-activity))\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n;; --- LAYOUT I STILOVI ---\n\n(defn common-layout [&amp; content]\n  (str\n    (html5\n      [:head\n       [:title \&quot;BeBetter Planner\&quot;]\n       [:meta {:charset \&quot;UTF-8\&quot;}]\n       [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n       [:link {:rel \&quot;stylesheet\&quot; :href \&quot;https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&amp;display=swap\&quot;}]\n       [:style \&quot;\n          /* OSNOVNI RESET */\n          * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n          body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n          /* SIDEBAR */\n          .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n          .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n          .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n          .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n\n          /* MAIN CONTENT */\n          .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n          h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n          /* DAY SELECTOR */\n          #days-nav { display: flex; gap: 10px; margin-bottom: 20px; }\n          .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; background: white; border: 1px solid #e0e0e0; transition: all 0.2s; }\n          .day-column:hover { background-color: #eef2f6; }\n          .day-column.selected { background-color: #2c3e50; color: white; border-color: #2c3e50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n\n          /* KALENDAR KONTEJNER */\n          .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n          .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n          \n          .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n          .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n\n          .day-grid { flex-grow: 1; position: relative; }\n\n          .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n          .hour-slot:hover { background-color: #fcfcfc; }\n\n          /* FORMA */\n          .slot-form-container { position: absolute; top: 0; left: 0; right: 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: 1px solid #ddd; z-index: 100; }\n          .slot-form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }\n          .slot-form select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }\n          .slot-form button { padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }\n\n          /* AKTIVNOST */\n          .activity-block { \n              position: absolute; left: 5px; right: 10px; \n              background-color: #e3f2fd; border-left: 4px solid #2196f3; \n              color: #1565c0; padding: 5px 10px; border-radius: 4px; \n              font-size: 13px; font-weight: 500; \n              z-index: 20; pointer-events: auto;\n              display: flex; align-items: center; justify-content: space-between;\n              overflow: hidden;\n          }\n       \&quot;]]\n      [:body\n       [:div.sidebar\n        [:div.logo \&quot;BeBetter\&quot;]\n        [:ul.sidebar-menu\n         [:li [:a.nav-link {:href \&quot;/planner\&quot;} \&quot;üìÖ Planer\&quot;]]\n         [:li [:a.nav-link {:href \&quot;/leaderboard\&quot;} \&quot;üèÜ Rang Lista\&quot;]]]]\n       [:main.main-content\n        content]])))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n;; --- KOMPONENTE ---\n\n(defn day-column [selected-day-str]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (if (= d \&quot;Mon\&quot;) \&quot;selected\&quot; \&quot;\&quot;) ;; TODO: Logika za selekciju dana\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn slot-form [hour]\n  [:div.slot-form-container {:onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:htmx:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :disabled true :selected true} \&quot;Aktivnost\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Trening\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Uƒçenje\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Posao\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :disabled true :selected true} \&quot;Intenzitet\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Lako\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Srednje\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;Te≈°ko\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Saƒçuvaj\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background:#eee; color:#333;\&quot;} \&quot;X\&quot;]]])\n\n(defn calendar-view [day activities]\n  [:div#calendar-view\n   [:h3 {:style \&quot;margin: 0 0 15px 0; color: #333;\&quot;} (str \&quot;Raspored: \&quot; (or day \&quot;Danas\&quot;))]\n\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ;; LEVA KOLONA\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.time-label (str hour \&quot;:00\&quot;)])]\n\n     ;; DESNA KOLONA\n     [:div.day-grid\n      ;; Slotovi\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;/slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      ;; Aktivnosti\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n;; --- HANDLERI ---\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status 200 :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;} :body (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params) (format-date (LocalDate/now)))\n\n        local-date (parse-date date-str)\n        time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    ;; Upis u bazu\n    @(d/transact sys/conn [[:activity/add username title duration intensity start-time]])\n\n    ;; Vracanje HTML-a (fake ID za sad, refresh ce povuci pravi)\n    (let [new-act-view {:id \&quot;temp\&quot; :title (name title) :intensity intensity :duration duration :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body (str (h/html (activity-&gt;block new-act-view)))})))\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (common-layout\n             [:div\n              [:h2 \&quot;Planer\&quot;]\n              (day-column today-str)\n              (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        ;; TODO: Ovde treba konverzija \&quot;Mon\&quot; -&gt; \&quot;2026-01-XX\&quot; da bi radilo sa bazom\n        ;; Za sad koristimo danasnji datum kao placeholder\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n;; --- APP START ---\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router\n        [\n         [\&quot;/\&quot; {:get (fn [_] {:status 302 :headers {\&quot;Location\&quot; \&quot;/planner\&quot;} :body \&quot;\&quot;})}]\n         [\&quot;/planner\&quot; {:get home-page}]\n         [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n         [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n         [\&quot;/select-day\&quot; {:post select-day-handler}]\n         [\&quot;/leaderboard\&quot; {:get (fn [_] {:status 200 :body \&quot;Leaderboard uskoro...\&quot;})}]\n         [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n         ]\n        {:data {:middleware [parameters/parameters-middleware\n                             wrap-keyword-params]}})\n      (ring/create-default-handler))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;Server na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server]\n    (.stop s)\n    (reset! server nil)\n    (println \&quot;Stop.\&quot;)))&quot;, :offset 11749, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (name (:activity/type db-activity))\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (* 60 hour)\n        height (* duration 60)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-wrapper\n    [:div.calendar-scroll\n     [:div#slots-layer\n      (for [hour (range 24)]\n       [:div.hour-row\n        [:div.hour-label (str hour \&quot;:00\&quot;)]\n        [:div.hour-slot\n         {:hx-get \&quot;/slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;\n\n          }]])]\n     [:div#calendar-form-layer {:style \&quot;position:absolute;\n          top:0;\n          left:0;\n          right:0;\n          height:1440px;\n          z-index:20;\n          pointer-events: none\&quot;}\n      (for [a activities]\n        (activity-&gt;block a))]\n     ]\n    ]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-form-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                              (for [d days]\n                                [:div.day-column\n                                 {:class (when (= d day) \&quot;selected\&quot;)\n                                  :hx-post \&quot;/select-day\&quot;\n                                  :hx-vals (generate-string {:day d})\n                                  :hx-target \&quot;#calendar-view\&quot;\n                                  :hx-swap \&quot;outerHTML\&quot;}\n                                 d])])))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params ]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact sys/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :start-time start-time}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16606, :ns &quot;web.server&quot;} {:command &quot;(add-activity! s/conn \&quot;Micko\&quot; :training 60 3 (LocalDate/now))&quot;, :offset 59, :ns &quot;project.db&quot;} {:command &quot;(add-activity! s/conn \&quot;Micko\&quot; :training 60 3 (new java.util.Date))&quot;, :offset 64, :ns &quot;project.db&quot;} {:command &quot;(get-all-users (d/db s/conn))&quot;, :offset 27, :ns &quot;project.db&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (name (:activity/type db-activity))\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (* 60 hour)\n        height (* duration 60)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-wrapper\n    [:div.calendar-scroll\n     [:div#slots-layer\n      (for [hour (range 24)]\n       [:div.hour-row\n        [:div.hour-label (str hour \&quot;:00\&quot;)]\n        [:div.hour-slot\n         {:hx-get \&quot;/slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;\n\n          }]])]\n     [:div#calendar-form-layer {:style \&quot;position:absolute;\n          top:0;\n          left:0;\n          right:0;\n          height:1440px;\n          z-index:20;\n          pointer-events: none\&quot;}\n      (for [a activities]\n        (activity-&gt;block a))]\n     ]\n    ]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-form-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                              (for [d days]\n                                [:div.day-column\n                                 {:class (when (= d day) \&quot;selected\&quot;)\n                                  :hx-post \&quot;/select-day\&quot;\n                                  :hx-vals (generate-string {:day d})\n                                  :hx-target \&quot;#calendar-view\&quot;\n                                  :hx-swap \&quot;outerHTML\&quot;}\n                                 d])])))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params ]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact sys/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16594, :ns &quot;project.db&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as sys]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ 1 (* 60 hour))\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-form-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                              (for [d days]\n                                [:div.day-column\n                                 {:class (when (= d day) \&quot;selected\&quot;)\n                                  :hx-post \&quot;/select-day\&quot;\n                                  :hx-vals (generate-string {:day d})\n                                  :hx-target \&quot;#calendar-view\&quot;\n                                  :hx-swap \&quot;outerHTML\&quot;}\n                                 d])])))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params ]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact sys/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16984, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ 1 (* 60 hour))\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                              (for [d days]\n                                [:div.day-column\n                                 {:class (when (= d day) \&quot;selected\&quot;)\n                                  :hx-post \&quot;/select-day\&quot;\n                                  :hx-vals (generate-string {:day d})\n                                  :hx-target \&quot;#calendar-view\&quot;\n                                  :hx-swap \&quot;outerHTML\&quot;}\n                                 d])])))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n        \n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16983, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn insant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n    (.getHour zdt)))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ 1 (* 60 hour))\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16552, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ 1 (* 60 hour))\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16575, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         /* KALENDAR GRID */\n         .calendar-wrapper { position: relative; background: white; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n         .calendar-scroll { height: 70vh; overflow-y: auto; position: relative; } /* Skroluje samo kalendar */\n\n         .hour-row { height: 60px; border-bottom: 1px solid #f0f0f0; position: relative; display: flex; align-items: center; z-index: 1; }\n         .hour-label { width: 60px; text-align: right; padding-right: 15px; color: #999; font-size: 12px; font-weight: 500; user-select: none;}\n         .hour-slot { flex: 1; height: 100%; cursor: pointer; transition: background 0.1s; position: relative; border-left: 1px solid #f0f0f0; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16074, :ns &quot;project.db&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }                    \n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }          \n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }          \n         .day-grid { flex-grow: 1; position: relative; }          \n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }          \n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16052, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n          .slot-form-container { position: absolute; top: 0; left: 0; right: 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: 1px solid #ddd; z-index: 100; }\\n          .slot-form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }\\n          .slot-form select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }\\n          .slot-form button { padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {\n             position: absolute; left: 125px; right: 10px;\n             background: #e3f2fd; border-left: 4px solid #2196f3;\n             color: #1565c0; padding: 8px 12px; border-radius: 4px;\n             font-size: 13px; font-weight: 500;\n             box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n             cursor: pointer; transition: transform 0.1s;\n             z-index: 30; pointer-events: auto;\n             display: flex; align-items: center; justify-content: space-between;\n         }\n         .activity-block:hover { transform: scale(1.01); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n         .activity-actions button { background: none; border: none; cursor: pointer; color: #d32f2f; font-size: 12px; font-weight: bold; }\n\n          .activity-actions {}\n          .activity-actions button {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;\n          transition: all 0.2s ease; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;}\n          .activity-actions button:first-child {background: #ff4757; color: white;}\n          .activity-actions button:first-child:hover {background: #ff3838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);}\n\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15686, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block { \\n              position: absolute; left: 5px; right: 10px; \\n              background-color: #e3f2fd; border-left: 4px solid #2196f3; \\n              color: #1565c0; padding: 5px 10px; border-radius: 4px; \\n              font-size: 13px; font-weight: 500; \\n              z-index: 20; pointer-events: auto;\\n              display: flex; align-items: center; justify-content: space-between;\\n              overflow: hidden;\\n          }\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;\n         :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15194, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n       #days-nav { display: flex; gap: 10px; margin-bottom: 20px; }          .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; background: white; border: 1px solid #e0e0e0; transition: all 0.2s; }\\          .day-column:hover { background-color: #eef2f6; }          .day-column.selected { background-color: #2c3e50; color: white; border-color: #2c3e50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 14893, :ns &quot;web.server&quot;} {:command &quot;(ns project.db\n  (:require [datomic.api :as d]\n            [clojure.string :as str]\n            [project.time :as t]\n            [project.validation :as v]\n            [project.system :as s]\n            [project.connection :as conn])\n  (:import (java.time LocalDate)))\n\n(defn create-user! [conn name]\n  (v/validate! v/CreateUserInput {:username name})\n  @(d/transact conn [{:user/username name\n                      :user/xp 0}]))\n\n(defn add-activity! [conn username activity-key duration intensity start-time]\n  (v/validate! v/AddActivityInput {:username username\n                                   :activity-type activity-key\n                                   :duration duration\n                                   :intensity intensity\n                                   :start-time start-time})\n  @(d/transact conn [[:activity/add username activity-key duration intensity start-time]]))\n\n(defn user-ids [db] (d/q '[:find ?e .\n                           :where [?e :user/username]] db))\n\n(defn get-all-users [db] (map first (d/q '[:find (pull ?e [*])\n                                           :where [?e :user/username]] db)))\n\n(defn get-user-by-name [db username]\n  (let [result (d/pull db \&quot;[*]\&quot; [:user/username username])]\n    (if (:db/id result) result (throw (ex-info \&quot;User not found\&quot; {:user/username username})))))\n\n(defn get-user-activities [db username]\n  (d/q '[:find ?a-start-time ?a-type ?a-duration ?a-intensity ?xp-per-min\n         :in $ ?username\n         :where  [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?a-type]\n         [?a :activity/intensity ?a-intensity]\n         [?a :activity/duration ?a-duration]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [?a :activity/start-time ?a-start-time]] db username))\n\n(defn get-activities-in-interval\n  [db username start-day end-day]\n  (d/q '[:find ?start-time ?type-name ?dur ?int ?xp-per-min\n         :in $ ?username ?start ?end\n         :where\n         [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/start-time ?start-time]\n         [?a :activity/duration ?dur]\n         [?a :activity/intensity ?int]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?type-name]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [(&gt;= ?start-time ?start)]\n         [(&lt; ?start-time ?end)]]\n       db username start-day end-day))\n\n(defn calculate-xp-from-rows [rows]\n  (reduce (fn [total-xp [_ _ dur int xp-per-min]]\n            (+ total-xp (* dur int xp-per-min)))\n          0\n          rows))\n\n(def period-interval\n  {:daily t/day-interval\n   :weekly t/week-interval\n   :monthly t/month-interval\n   :all     nil})\n\n(defn add-xp [conn db username xp-to-add]\n  (let [[e current-xp]\n        (first (d/q '[:find ?e ?xp\n                      :in $ ?username\n                      :where [?e :user/username ?username]\n                      [?e :user/xp ?xp]]\n                    db username))\n        new-xp (+ current-xp xp-to-add)]\n    @(d/transact conn [[:db/add e :user/xp new-xp]])))\n\n(def add-xp-tx {:db/ident :user/add-xp\n                :db/fn (d/function\n                        '{:lang \&quot;clojure\&quot;\n                          :params [db username xp]\n                          :code (let [[e current-xp]\n                                      (first (d/q '[:find ?e ?xp\n                                                    :in $ ?username\n                                                    :where [?e :user/username ?username]\n                                                    [?e :user/xp ?xp]] db username))]\n                                  [[:db/add e :user/xp (+ current-xp xp)]])})})\n\n(def add-activity-tx\n  {:db/ident :activity/add\n   :db/fn (d/function\n           '{:lang \&quot;clojure\&quot;\n             :params [db username activity-type-key duration intensity start-time]\n             :code (let [user-e\n                         (d/q '[:find ?e .\n                                :in $ ?username\n                                :where [?e :user/username ?username]]\n                              db username)\n                         [act-type-e xp-per-min]\n                         (first (d/q '[:find ?e ?xp-per-minute\n                                       :in $ ?type\n                                       :where [?e :activity-type/key ?type]\n                                       [?e :activity-type/xp-per-minute ?xp-per-minute]] db activity-type-key))\n                         gained-xp (* duration xp-per-min intensity)\n\n                         current-xp (or (:user/xp (d/entity db user-e)) 0)\n\n                         new-xp (+ current-xp gained-xp)\n                         activity-id (d/tempid :db.part/user)]\n                     [{:db/id activity-id\n                       :activity/user user-e\n                       :activity/type act-type-e\n                       :activity/duration duration\n                       :activity/intensity intensity\n                       :activity/start-time start-time}\n                      [:db/add user-e :user/xp new-xp]])})})\n\n(def get-all-tx-functions [add-xp-tx add-activity-tx])\n\n(defn usernames-xp [db] (vec (d/q '[:find ?username ?xp\n                                    :where [?u :user/username ?username]\n                                    [?u :user/xp ?xp]] db)))\n\n(defn xp-per-user [db username period date]\n  ; slucaj kad je samo all\n  (if (= period :all)\n    (:user/xp (get-user-by-name db username))\n    ;---------------------\n    (let [{:keys [start-day end-day]} ((get period-interval period) date)\n          rows (get-activities-in-interval db username start-day end-day)]\n      (calculate-xp-from-rows rows))))\n\n(defn report-daily-in-period [db username date]\n  ;total xp u danu\n  (let [{:keys [start-day end-day]} ((get period-interval :daily) date)\n        rows (get-activities-in-interval db username start-day end-day)\n        activities-xp (map (fn [[start-time a-type dur int xp-per-min]]\n                             {:activity/time (.toLocalTime (t/instant-&gt;local start-time))\n                              :activity/type a-type\n                              :activity/duration dur\n                              :activity/intensity int\n                              :activity/xp (* dur int xp-per-min)}) rows)\n        total-xp (calculate-xp-from-rows rows)]\n\n    {:date date\n     :username username\n     :activities activities-xp\n     :total-xp total-xp}))\n\n;(defn get-all-users)\n&quot;, :offset 6478, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- (* duration 60) 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;1\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;2\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;4\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15006, :ns &quot;project.db&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n    [:div.activity-block\n     {:id (str \&quot;act-\&quot; id)\n      :style (str \&quot;top: \&quot; top \&quot;px; height: \&quot; height \&quot;px;\&quot;)}\n     [:span (str title \&quot; [\&quot; intensity \&quot;]\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15043, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15546, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;h\&quot;)]\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id}) ;; Ovde treba pravi ID iz baze\n               :hx-target (str \&quot;#act-\&quot; id) ;; Ovo samo sklanja iz DOM-a, treba i iz baze\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15164, :ns &quot;web.server&quot;} {:command &quot;(get-user-activities (d/db s/conn) \&quot;Micko\&quot;)&quot;, :offset 33, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot/form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15622, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:60px;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15622, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15619, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { height: 60px; width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15633, :ns &quot;web.server&quot;} {:command &quot;(project.db/get-user-activities (d/db s/conn) \&quot;Micko\&quot;)&quot;, :offset 1, :ns &quot;web.server&quot;} {:command &quot;(project.leaderboard/leaderboard (d/db s/conn) :all (LocalDate/now))&quot;, :offset 66, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15777, :ns &quot;project.core&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                #_(str (h/html (day-column day))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15779, :ns &quot;web.server&quot;} {:command &quot;(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column today-str))))}))&quot;, :offset 355, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (str (h/html (calendar-view day activities)))\n                (str (h/html (day-column today-str))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 15783, :ns &quot;project.core&quot;} {:command &quot;(defn select-day-handler [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;text-align: center; min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))&quot;, :offset 621, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn day-column [selected-day]\n  [:div {:id \&quot;days-nav\&quot;}\n   (for [d days]\n     [:div.day-column\n      {:class (when (= d selected-day) \&quot;selected\&quot;)\n       :hx-post \&quot;/select-day\&quot;\n       :hx-vals (generate-string {:day d})\n       :hx-target \&quot;#calendar-view\&quot;\n       :hx-swap \&quot;outerHTML\&quot;}\n      d])])\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;text-align: center; min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16422, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;text-align: center; min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16549, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16495, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           }]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16440, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;text-align: center; min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16570, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16550, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: black; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;day-nav\&quot;\n           :style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16550, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: black; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.days-nav {:style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16534, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: black; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.days-nav {:style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.days-nav\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16532, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: black; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.#days-nav {:style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;min-width: 50px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16535, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: black; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.days-nav {:style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        \n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16509, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.#days-nav {:style \&quot;display: flex; flex-direction: row; gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        \n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16510, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.#days-nav {:style \&quot;display: flex;  gap: 1rem; margin-bottom: 20px;\&quot;}]\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;flex-direction: row;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})\n\n  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16519, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div.#days-nav {:style \&quot;display: flex;  gap: 1rem; margin-bottom: 20px;\&quot;}\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;flex-direction: row;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])]))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16517, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;flex-direction: row;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])]))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             (str (h/html (calendar-view day activities)))\n             (str (h/html [:div {:id \&quot;days-nav\&quot;\n                                 :hx-swap-oob \&quot;true\&quot;}\n                           (h/html (day-column day))])))})  )\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16532, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-get \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;flex-direction: row;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div (subs date-str 8 10)]])]))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             ;; 1. Novi kalendar\n             (h/html (calendar-view day activities))\n\n             ;; 2. Novi dugmiƒái (OOB swap)\n             ;; PAZI: day-column sada vraƒáa div#days-nav. \n             ;; Dodajemo hx-swap-oob=\&quot;true\&quot; direktno na njega.\n             (let [dc (day-column day)]\n               (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16668, :ns &quot;web.server&quot;} {:command &quot;(ns web.server\n  (:require [ring.adapter.jetty :as jetty]\n            [reitit.ring :as ring]\n            [reitit.ring.middleware.parameters :as parameters]\n            [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n            [hiccup.page :refer [html5]]\n            [hiccup2.core :as h]\n            [project.api :as api]\n            [datomic.api :as d]\n            [project.system :as s]\n            [clojure.string :as str]\n            [ring.middleware.session :refer [wrap-session]]\n            [cheshire.core :refer :all]\n            )\n  (:import (java.time LocalDate LocalTime Duration ZoneId)\n           (java.time.format DateTimeFormatter)\n           (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n  (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n        hour (.getHour zdt)\n        minute (.getMinute zdt)\n        (+ (* hour 60) minute)]))\n\n(defn common-layout [&amp; content]\n  (html5\n    [:head\n     [:title \&quot;BeBetter\&quot;]\n     [:meta {:charset \&quot;UTF-8\&quot;}]\n     [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n     [:style\n      \&quot;\n         /* RESET &amp; BASE */\n         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n         body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n         /* SIDEBAR */\n         .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n         .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n         .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n         .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n         .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n         /* MAIN CONTENT */\n         .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n         h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n         /* DAY SELECTOR */\n         #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n         .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n         .day-column:hover { background-color: #f8f9fa; color: #333; }\n         .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n         .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n         .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n         .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n         .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n         .day-grid { flex-grow: 1; position: relative; }\n         .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n         .hour-slot:hover { background-color: #fcfcfc; }\n\n         /* FORMA U SLOTU */\n         .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n         box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n         top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n         isolation: isolate; transform: translateZ(0); }\n         .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n         .slot-form-row { display: flex; gap: 8px; width: 100%; }\n         .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n         .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n         .slot-form button:hover { background: #34495e; }\n\n         /* AKTIVNOST BLOK */\n         .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n         @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n      \&quot;]]\n\n    [:body\n     [:div.sidebar\n      [:div.logo-wrapper\n       [:div.logo \&quot;BeBetter\&quot;]]\n      [:ul.sidebar-menu\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;\\uD83C\\uDFE0\&quot;] [:span \&quot;Feed\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;‚ö°\&quot;] [:span \&quot;Aktivnost\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üèÜ\&quot;] [:span \&quot;Rang Lista\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üîç\&quot;] [:span \&quot;Pretraga\&quot;]]]\n       [:li [:a.nav-link {:href \&quot;#\&quot;} [:span \&quot;üë§\&quot;] [:span \&quot;Moj Profil\&quot;]]]]]\n     [:main.main-content\n      content]]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n    (for [{:keys [name date-str]} week-days]\n      [:div.day-column\n       {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n        :hx-post \&quot;/select-day\&quot;\n        :hx-vals (generate-string {:day date-str})\n        :hx-target \&quot;#calendar-view\&quot;\n        :hx-swap \&quot;outerHTML\&quot;\n        :style \&quot;text-align: center; min-width: 60px;\&quot;\n        }\n       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n       [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;\n                  )}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n     ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n     ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}\n         ])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n        (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n    }\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true }\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n       [:div\n        [:h2 \&quot;Calendar\&quot;]\n        (day-column today-str)\n        (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             ;; 1. Novi kalendar\n             (h/html (calendar-view day activities))\n\n             ;; 2. Novi dugmiƒái (OOB swap)\n             ;; PAZI: day-column sada vraƒáa div#days-nav.\n             ;; Dodajemo hx-swap-oob=\&quot;true\&quot; direktno na njega.\n             (let [dc (day-column day)]\n               (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))\n     }))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (str\n       (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))})\n  )\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]) )}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}\n    )\n  )\n\n(def app\n  (wrap-session\n    (ring/ring-handler\n      (ring/router [[\&quot;/\&quot; {:get home-page}]\n                    [\&quot;/select-day\&quot; {:post select-day-handler}]\n                    [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                    [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                    [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                    [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                    [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                    [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                    ]\n                   {:data {:middleware [parameters/parameters-middleware\n                                        wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16732, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all]\n              )\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n  (def port 3000)\n  (defn parse-date [date-str]\n    (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n      (LocalDate/now)\n      (try (LocalDate/parse date-str)\n           (catch Exception _ (LocalDate/now)))))\n\n  (defn format-date [date]\n    (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n  (defn nice-date [date]\n    (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n  (defn get-next-day [date]\n    (.plusDays date 1))\n  (defn get-previous-day [date]\n    (.minusDays date 1))\n\n  #_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n  \n  (defn common-layout [&amp; content]\n    (html5\n      [:head\n       [:title \&quot;BeBetter\&quot;]\n       [:meta {:charset \&quot;UTF-8\&quot;}]\n       [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n       [:style\n        \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n      [:body\n       (sidebar)\n       [:main.main-content\n        content]]))\n\n  \n\n  (def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n  (defn get-current-week-days []\n    (let [today (LocalDate/now)\n          monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n      (for [i (range 7)]\n        (let [d (.plusDays monday i)]\n          {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n           :date-str (format-date d)\n           :is-today (.isEqual d today)}))))\n\n  (defn day-column [selected-day-str]\n    (let [week-days (get-current-week-days)]\n      [:div {:id \&quot;days-nav\&quot;\n             :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n      (for [{:keys [name date-str]} week-days]\n        [:div.day-column\n         {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n          :hx-post \&quot;/select-day\&quot;\n          :hx-vals (generate-string {:day date-str})\n          :hx-target \&quot;#calendar-view\&quot;\n          :hx-swap \&quot;outerHTML\&quot;\n          :style \&quot;text-align: center; min-width: 60px;\&quot;\n          }\n         [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n         [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n  (defn get-hour-from-instant [inst]\n    (if inst\n      (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n        (.getHour zdt))\n      0))\n\n  (defn db-activity-&gt;view-model [db-activity]\n    {:id (:db/id db-activity)\n     :title (if (:activity/type db-activity)\n              (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n     :intensity (:activity/intensity db-activity)\n     :duration (:activity/duration db-activity)\n     :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n  (defn get-activities-for-date [username date-str]\n    (let [date (parse-date date-str)\n          report (project.api/get-daily-report username date)\n          db-activities (:activities report)]\n      (map db-activity-&gt;view-model db-activities)))\n  ;------\n  (defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n    (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n          height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n      [:div.activity-block\n       {:id (str \&quot;activity-\&quot; id)\n        :hx-get \&quot;/activity-edit\&quot;\n        :hx-target (str \&quot;#activity-\&quot; id)\n        :hx-swap \&quot;innerHTML\&quot;\n        :hx-vals (generate-string {:id id})\n        :style (str \&quot;position:absolute;\&quot;\n                    \&quot;top:\&quot; top \&quot;px;\&quot;\n                    \&quot;left:0;\&quot;\n                    \&quot;right:0;\&quot;\n                    \&quot;height:\&quot; height \&quot;px;\&quot;\n                    \&quot;background:#2c3e50;\&quot;\n                    \&quot;color:white;\&quot;\n                    \&quot;border-radius:6px;\&quot;\n                    \&quot;padding:6px;\&quot;\n                    \&quot;pointer-events: auto;\&quot;\n                    )}\n       [:div.activity-content\n        (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n       [:button {:hx-delete \&quot;/activity\&quot;\n                 :hx-vals (generate-string {:id id})\n                 :hx-target (str \&quot;#act-\&quot; id)\n                 :hx-swap \&quot;outerHTML\&quot;\n                 :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n        \&quot;‚úï\&quot;]]))\n\n\n\n  (defn calendar-view [day activities]\n    [:div#calendar-view.calendar\n     [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n     [:div.calendar-scroll\n      [:div.calendar-grid\n       ; leva kolona za vreme\n       [:div.time-labels\n        (for [hour (range 24)]\n          [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n       [:div.day-grid\n        (for [hour (range 24)]\n          [:div.hour-slot\n           {:hx-get \&quot;slot-form\&quot;\n            :hx-vals (generate-string {:hour hour})\n            :hx-target \&quot;this\&quot;\n            :hx-swap \&quot;innerHTML\&quot;\n            :hx-trigger \&quot;click once\&quot;}\n           ])\n\n        [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n         (for [a activities]\n          (activity-&gt;block a))]]]]])\n\n  (defn slot-form [hour]\n    [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                                :onclick \&quot;event.stopPropagation()\&quot;}\n     [:form.slot-form\n      {:hx-post \&quot;/add-activity\&quot;\n       :hx-target \&quot;#calendar-layer\&quot;\n       :hx-swap \&quot;beforeend\&quot;\n       :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n       :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n       :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;\n      }\n\n      [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n      [:select {:name \&quot;title\&quot; :required true }\n       [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n       [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n       [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n       [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n      [:select {:name \&quot;intensity\&quot; :required true }\n       [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n       [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n       [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n       [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n      [:select {:name \&quot;duration\&quot;}\n       [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n       [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n       [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n       [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n       [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n      [:button {:type \&quot;submit\&quot; } \&quot;Save\&quot;]\n      [:button {:type \&quot;button\&quot;\n                :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n                :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n  (defn activity-edit-view [id]\n    [:div.activity-edit\n     {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n     [:span \&quot;Edit mode\&quot;]\n     [:div.activity-actions\n      [:button {:hx-delete \&quot;/activity\&quot;\n                :hx-vals (generate-string {:id id})\n                :hx-target (str \&quot;#activity-\&quot; id)\n                :hx-swap \&quot;delete\&quot;}]\n      \&quot;Delete\&quot;]\n     [:button\n      {:hx-get \&quot;/activity-view\&quot;\n       :hx-vals (generate-string {:id id})\n       :hx-target \&quot;closest .activity-block\&quot;\n       :hx-swap \&quot;innerHTML\&quot;}\n      \&quot;Cancel\&quot;]])\n\n  (defn home-page [request]\n    (let [today-str (format-date (LocalDate/now))\n          activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (common-layout\n         [:div\n          [:h2 \&quot;Calendar\&quot;]\n          (day-column today-str)\n          (calendar-view today-str activities)])}))\n\n  (defn select-day-handler [{:keys [params]}]\n    (let [day (:day params)\n          activities (get-activities-for-date \&quot;Micko\&quot; day)]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body (str\n               ;; 1. Novi kalendar\n               (h/html (calendar-view day activities))\n\n               ;; 2. Novi dugmiƒái (OOB swap)\n               ;; PAZI: day-column sada vraƒáa div#days-nav.\n               ;; Dodajemo hx-swap-oob=\&quot;true\&quot; direktno na njega.\n               (let [dc (day-column day)]\n                 (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n  (defn slot-form-handler [{:keys [params]}]\n    (let [hour (:hour params)]\n      {:status  200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body    (str (h/html (slot-form hour)))\n       }))\n\n  (defn add-activity-handler [{:keys [params]}]\n    (println \&quot;UPISUJEM U BAZU: \&quot; params)\n    (let [username \&quot;Micko\&quot;\n          title (keyword (:title params))\n          intensity (Integer/parseInt (:intensity params))\n          duration (Integer/parseInt (:duration params))\n          hour (Integer/parseInt (:hour params))\n          date-str (or (:date params (format-date (LocalDate/now))))\n\n          local-date (parse-date date-str)\n          local-time (LocalTime/of hour 0)\n          start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n\n      @(d/transact s/conn\n                   [[:activity/add username title duration intensity start-time]])\n\n      (let [new-activity-view {:id \&quot;temp-id\&quot;\n                               :title (name title)\n                               :intensity intensity\n                               :duration duration\n                               :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n         (h/html (activity-&gt;block new-activity-view)))})))\n\n  (defn activity-edit-handler [{:keys [params]}]\n    (let [id (:id params)]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body (str (h/html (activity-edit-view id)))})\n    )\n\n  (defn activity-view-handler [{:keys [params session]}]\n    (let [id (:id params)\n          day (:select-day session)\n          activity (first (filter #(= (:id %) id)\n                                  (get-in session [:activities day])))]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                                 :hx-vals (generate-string {:id id})\n                                 :hx-target (str \&quot;#activity-\&quot; id)\n                                 :hx-swap \&quot;innerHTML\&quot;\n                                 :style \&quot;height:100%; cursor:pointer;\&quot;}\n                           (str (:title activity) \&quot;  \&quot;\n                                (:intensity activity) \&quot;  \&quot;\n                                (:duration activity) \&quot;h\&quot;)]) )}))\n\n  (defn activity-delete-handler [{:keys [params session]}]\n    (let [id (:id params)\n          day (:select-day session)]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :session (update-in session [:activities day]\n                           (fn [acts]\n                             (vec (remove #(= (:id %) id) acts))))\n       :body \&quot;\&quot;}\n      )\n    )\n\n  (def app\n    (wrap-session\n      (ring/ring-handler\n        (ring/router [[\&quot;/\&quot; {:get home-page}]\n                      [\&quot;/select-day\&quot; {:post select-day-handler}]\n                      [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                      [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                      [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                      [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                      [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                      [\&quot;/activity-view\&quot; {:get activity-view-handler}]\n                      ]\n                     {:data {:middleware [parameters/parameters-middleware\n                                          wrap-keyword-params]}}))))\n\n  (defonce server (atom nil))\n\n  (defn start-server []\n    (when-not @server\n      (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n      (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n  (defn stop-server []\n    (when-some [s @server] ;; check if there is an object in the atom\n      (.stop s)\n      (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16959, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (get-hour-from-instant (:activity/start-time db-activity))})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n  ;------\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)    ;; Sat * 60px = Pozicija\n        height (- duration 3)]   ;; Trajanje (u minutima) = Visina u px. ODUZMI 3px za marginu/border.\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16090, :ns &quot;project.core&quot;} {:command &quot;(start-server)&quot;, :offset 13, :ns &quot;web.server&quot;} {:command &quot;(api/get-daily-report \&quot;Micko\&quot; (LocalDate/now))&quot;, :offset 46, :ns &quot;web.server&quot;} {:command &quot;(db/get-all-users (d/db s/conn))&quot;, :offset 32, :ns &quot;web.server&quot;} {:command &quot;(defn get-user-activities [db username]\n  (sort-by first (d/q '[:find ?a-start-time ?a-type ?a-duration ?a-intensity ?xp-per-min\n         :in $ ?username\n         :where  [?u :user/username ?username]\n         [?a :activity/user ?u]\n         [?a :activity/type ?t]\n         [?t :activity-type/name ?a-type]\n         [?a :activity/intensity ?a-intensity]\n         [?a :activity/duration ?a-duration]\n         [?t :activity-type/xp-per-minute ?xp-per-min]\n         [?a :activity/start-time ?a-start-time]] db username)))&quot;, :offset 518, :ns &quot;project.db&quot;} {:command &quot;(db/get-user-activities (d/db s/conn) \&quot;Micko\&quot;)&quot;, :offset 44, :ns &quot;web.server&quot;} {:command &quot;(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})&quot;, :offset 488, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.#scroll-container.calendar-scroll\n    [:script \&quot;document.getElementById('scroll-container').scrollTop=360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16225, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.#scroll-container.calendar-scroll\n    [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16227, :ns &quot;web.server&quot;} {:command &quot;(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.#scroll-container.calendar-scroll\n    ; [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])&quot;, :offset 819, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.#scroll-container.calendar-scroll\n    ; [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16229, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div.calendar-scroll\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16132, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16149, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16226, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                     (let [week-days (get-current-week-days)]\n                       (for [{:keys [name date-str]} week-days]\n                         [:div.day-column\n                          {:class (when (= date-str day) \&quot;selected\&quot;) ;; Ovde koristimo 'day' iz params\n                           :hx-post \&quot;/select-day\&quot;\n                           :hx-vals (generate-string {:day date-str})\n                           :hx-target \&quot;#calendar-view\&quot;\n                           :hx-swap \&quot;outerHTML\&quot;\n                           :style \&quot;text-align: center; min-width: 60px;\&quot;}\n                          [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n                          [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]]))]))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16943, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     ;; BITNO: Spajamo HTML stringove BEZ da ih ponovo eskejpujemo\n     :body (str\n             (h/html (calendar-view day activities)) ;; Glavni deo (Calendar)\n\n             ;; OOB Swap deo (Navigacija)\n             (h/html [:div {:id \&quot;days-nav\&quot; :hx-swap-oob \&quot;true\&quot;}\n                      (let [week-days (get-current-week-days)]\n                        (for [{:keys [name date-str]} week-days]\n                          [:div.day-column\n                           {:class (when (= date-str day) \&quot;selected\&quot;) ;; Ovde koristimo 'day' iz params\n                            :hx-post \&quot;/select-day\&quot;\n                            :hx-vals (generate-string {:day date-str})\n                            :hx-target \&quot;#calendar-view\&quot;\n                            :hx-swap \&quot;outerHTML\&quot;\n                            :style \&quot;text-align: center; min-width: 60px;\&quot;}\n                           [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n                           [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]]))]))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 17091, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:script \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n             ;; 1. Kalendar\n             (h/html (calendar-view day activities))\n\n             ;; 2. Dugmiƒái sa OOB (MORAMO KORISTITI h/raw DA NE ESKEJPUJE)\n             (let [week-days (get-current-week-days)\n                   ;; Renderujemo ceo div za dugmiƒáe kao HTML string\n                   days-nav-html (h/html\n                                   [:div {:id \&quot;days-nav\&quot;\n                                          :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;\n                                          :hx-swap-oob \&quot;true\&quot;} ;; OOB SWAP!\n                                    (for [{:keys [name date-str]} week-days]\n                                      [:div.day-column\n                                       {:class (when (= date-str day) \&quot;selected\&quot;)\n                                        :hx-post \&quot;/select-day\&quot;\n                                        :hx-vals (generate-string {:day date-str})\n                                        :hx-target \&quot;#calendar-view\&quot;\n                                        :hx-swap \&quot;outerHTML\&quot;\n                                        :style \&quot;text-align: center; min-width: 60px;\&quot;}\n                                       [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n                                       [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])])]\n               ;; Vraƒáamo RAW string (neeskejpoan)\n               (str days-nav-html)))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 17500, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:script (h/raw \&quot;document.getElementById('scroll-container').scrollTop = 330;\&quot;)]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16234, :ns &quot;web.server&quot;} {:command &quot;  (ns web.server\n    (:require [ring.adapter.jetty :as jetty]\n              [reitit.ring :as ring]\n              [reitit.ring.middleware.parameters :as parameters]\n              [ring.middleware.keyword-params :refer [wrap-keyword-params]]\n              [hiccup.page :refer [html5]]\n              [hiccup2.core :as h]\n              [project.api :as api]\n              [datomic.api :as d]\n              [project.system :as s]\n              [clojure.string :as str]\n              [ring.middleware.session :refer [wrap-session]]\n              [cheshire.core :refer :all])\n    (:import (java.time LocalDate LocalTime Duration ZoneId)\n             (java.time.format DateTimeFormatter)\n             (java.util UUID)))\n\n(def port 3000)\n(defn parse-date [date-str]\n  (if (or (empty? date-str) (= \&quot;today\&quot; date-str))\n    (LocalDate/now)\n    (try (LocalDate/parse date-str)\n         (catch Exception _ (LocalDate/now)))))\n\n(defn format-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;yyyy-MM-dd\&quot;)))\n\n(defn nice-date [date]\n  (.format date (DateTimeFormatter/ofPattern \&quot;EEEE, dd. MMMM yyyy.\&quot;)))\n\n(defn get-next-day [date]\n  (.plusDays date 1))\n(defn get-previous-day [date]\n  (.minusDays date 1))\n\n#_(defn instant-&gt;minutes-from-midnight [inst]\n    (let [zdt (.atZone (.toInsant inst) (project.time/zone))\n          hour (.getHour zdt)\n          minute (.getMinute zdt)\n          (+ (* hour 60) minute)]))\n\n(defn sidebar []\n  [:div.sidebar\n   [:div.logo-wrapper\n    [:span \&quot;BeBetter\&quot;]]\n   [:ul.sidebar-menu\n    [:a.nav-link\n     [:li [:span \&quot;Activity\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Feed\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Leaderboard\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;Search\&quot;]]]\n    [:a.nav-link\n     [:li [:span \&quot;My Profile\&quot;]]]]])\n\n(defn common-layout [&amp; content]\n  (html5\n   [:head\n    [:title \&quot;BeBetter\&quot;]\n    [:meta {:charset \&quot;UTF-8\&quot;}]\n    [:script {:src \&quot;https://unpkg.com/htmx.org@1.9.10\&quot;}]\n    [:style\n     \&quot;\n           /* RESET &amp; BASE */\n           * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }\n           body { background-color: #f8f9fa; color: #333; display: flex; height: 100vh; overflow: hidden; }\n\n           /* SIDEBAR */\n           .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 50; }\n           .logo { font-size: 24px; font-weight: 800; color: #2c3e50; margin-bottom: 40px; padding-left: 10px; }\n           .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #555; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s; }\n           .nav-link:hover { background-color: #f0f4f8; color: #2c3e50; }\n           .nav-link span { margin-right: 12px; font-size: 1.1em; }\n\n           /* MAIN CONTENT */\n           .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }\n           h2 { font-size: 28px; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }\n\n           /* DAY SELECTOR */\n           #days-nav { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; width: fit-content; }\n           .day-column { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #777; transition: all 0.2s; border: 1px solid transparent; }\n           .day-column:hover { background-color: #f8f9fa; color: #333; }\n           .day-column.selected { background-color: #2c3e50; color: white; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }\n\n           .calendar-scroll { height: 75vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: white; position: relative; }\n           .calendar-grid { display: flex; min-height: 1440px; position: relative; }\n           .time-labels { width: 60px; border-right: 1px solid #f0f0f0; background: #fafafa; flex-shrink: 0; }\n           .hour-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .time-label { height: 60px; border-bottom: 1px solid #eee; text-align: right; padding-right: 10px; color: #999; font-size: 12px; padding-top: 5px; }\n           .day-grid { flex-grow: 1; position: relative; }\n           .hour-slot { height: 60px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; z-index: 1; }\n           .hour-slot:hover { background-color: #fcfcfc; }\n\n           /* FORMA U SLOTU */\n           .slot-form-container { padding: 10px; background: white; border-radius: 6px; z-index: 10000;\n           box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0; position: absolute;\n           top: 5px; left: 5px; width: 600px; animation: fadeIn 0.2s; pointer-events: auto;\n           isolation: isolate; transform: translateZ(0); }\n           .slot-form { display: flex; gap: 8px; flex-wrap: wrap; }\n           .slot-form-row { display: flex; gap: 8px; width: 100%; }\n           .slot-form select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; flex: 1; font-size: 13px; }\n           .slot-form button { padding: 8px 15px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }\n           .slot-form button:hover { background: #34495e; }\n\n           /* AKTIVNOST BLOK */\n           .activity-block {position: absolute; left: 5px; right: 10px; background-color: #e3f2fd; border-left: 4px solid #2196f3; color: #1565c0; padding: 5px 10px; border-radius: 4px; font-size: 13px; font-weight: 500; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; overflow: hidden;}\n           @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }\n        \&quot;]]\n\n   [:body\n    (sidebar)\n    [:main.main-content\n     content]]))\n\n(def days [\&quot;Mon\&quot; \&quot;Tue\&quot; \&quot;Wed\&quot; \&quot;Thu\&quot; \&quot;Fri\&quot; \&quot;Sat\&quot; \&quot;Sun\&quot;])\n\n(defn get-current-week-days []\n  (let [today (LocalDate/now)\n        monday (.with today (java.time.temporal.TemporalAdjusters/previousOrSame java.time.DayOfWeek/MONDAY))]\n    (for [i (range 7)]\n      (let [d (.plusDays monday i)]\n        {:name (.format d (DateTimeFormatter/ofPattern \&quot;EEE\&quot;))\n         :date-str (format-date d)\n         :is-today (.isEqual d today)}))))\n\n(defn day-column [selected-day-str]\n  (let [week-days (get-current-week-days)]\n    [:div {:id \&quot;days-nav\&quot;\n           :style \&quot;display: flex; gap: 10px; margin-bottom: 20px;\&quot;}\n     (for [{:keys [name date-str]} week-days]\n       [:div.day-column\n        {:class (when (= date-str selected-day-str) \&quot;selected\&quot;)\n         :hx-post \&quot;/select-day\&quot;\n         :hx-vals (generate-string {:day date-str})\n         :hx-target \&quot;#calendar-view\&quot;\n         :hx-swap \&quot;outerHTML\&quot;\n         :style \&quot;text-align: center; min-width: 60px;\&quot;}\n        [:div {:style \&quot;font-size: 0.8em; color: #888;\&quot;} name]\n        [:div {:style \&quot;font-weight: bold; font-size: 1.2em;\&quot;} (subs date-str 8 10)]])]))\n  ; DOBRO\n(defn get-hour-from-instant [inst]\n  (if inst\n    (let [zdt (.atZone (.toInstant inst) (ZoneId/of \&quot;Europe/Belgrade\&quot;))]\n      (.getHour zdt))\n    0))\n\n(defn db-activity-&gt;view-model [db-activity]\n  {:id (:db/id db-activity)\n   :title (if (:activity/type db-activity)\n            (name (:activity/type db-activity)) \&quot;unknown\&quot;)\n   :intensity (:activity/intensity db-activity)\n   :duration (:activity/duration db-activity)\n   :hour (cond (:activity/time db-activity ) (.getHour (:activity/time db-activity))\n               (:activity/start-time db-activity)  (get-hour-from-instant (:activity/start-time db-activity))\n               :else 0)})\n\n(defn get-activities-for-date [username date-str]\n  (let [date (parse-date date-str)\n        report (project.api/get-daily-report username date)\n        db-activities (:activities report)]\n    (map db-activity-&gt;view-model db-activities)))\n\n(defn activity-&gt;block [{:keys [id title intensity duration hour]}]\n  (let [top (+ (* hour 60) 1)\n        height (- duration 3)]\n\n    [:div.activity-block\n     {:id (str \&quot;activity-\&quot; id)\n      :hx-get \&quot;/activity-edit\&quot;\n      :hx-target (str \&quot;#activity-\&quot; id)\n      :hx-swap \&quot;innerHTML\&quot;\n      :hx-vals (generate-string {:id id})\n      :style (str \&quot;position:absolute;\&quot;\n                  \&quot;top:\&quot; top \&quot;px;\&quot;\n                  \&quot;left:0;\&quot;\n                  \&quot;right:0;\&quot;\n                  \&quot;height:\&quot; height \&quot;px;\&quot;\n                  \&quot;background:#2c3e50;\&quot;\n                  \&quot;color:white;\&quot;\n                  \&quot;border-radius:6px;\&quot;\n                  \&quot;padding:6px;\&quot;\n                  \&quot;pointer-events: auto;\&quot;)}\n     [:div.activity-content\n      (str title \&quot;  \&quot; intensity \&quot;  \&quot; duration \&quot;min\&quot;)] ;; Promenio sam \&quot;h\&quot; u \&quot;min\&quot; jer prikazujes minute\n     [:button {:hx-delete \&quot;/activity\&quot;\n               :hx-vals (generate-string {:id id})\n               :hx-target (str \&quot;#act-\&quot; id)\n               :hx-swap \&quot;outerHTML\&quot;\n               :style \&quot;background:none; border:none; cursor:pointer; color:red;\&quot;}\n      \&quot;‚úï\&quot;]]))\n\n(defn calendar-view [day activities]\n  [:div#calendar-view.calendar\n   [:h3 (str \&quot;Day: \&quot; (or day \&quot;Monday\&quot;))]\n   [:div#scroll-container.calendar-scroll\n    [:script (h/raw \&quot;document.getElementById('scroll-container').scrollTop = 360;\&quot;)]\n    [:div.calendar-grid\n       ; leva kolona za vreme\n     [:div.time-labels\n      (for [hour (range 24)]\n        [:div.hour-label (str hour \&quot;:00\&quot;)])]\n       ;desna kolona\n     [:div.day-grid\n      (for [hour (range 24)]\n        [:div.hour-slot\n         {:hx-get \&quot;slot-form\&quot;\n          :hx-vals (generate-string {:hour hour})\n          :hx-target \&quot;this\&quot;\n          :hx-swap \&quot;innerHTML\&quot;\n          :hx-trigger \&quot;click once\&quot;}])\n\n      [:div#calendar-layer {:style \&quot;position: absolute; inset: 0; pointer-events: none; z-index: 10;\&quot;}\n       (for [a activities]\n         (activity-&gt;block a))]]]]])\n\n(defn slot-form [hour]\n  [:div.slot-form-container  {:style \&quot;position:absolute; top:5px; left:5px; z-index:1000;\&quot;\n                              :onclick \&quot;event.stopPropagation()\&quot;}\n   [:form.slot-form\n    {:hx-post \&quot;/add-activity\&quot;\n     :hx-target \&quot;#calendar-layer\&quot;\n     :hx-swap \&quot;beforeend\&quot;\n     :hx-on:after-request \&quot;this.closest('.slot-form-container').remove()\&quot;\n     :onsubmit \&quot;this.querySelector('button[type=submit]').disabled = true;\&quot;\n     :style \&quot;display: flex; gap: 10px; align-items: center;\&quot;}\n\n    [:input {:type \&quot;hidden\&quot; :name \&quot;hour\&quot; :value hour}]\n\n    [:select {:name \&quot;title\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Activity\&quot;]\n     [:option {:value \&quot;training\&quot;} \&quot;Training\&quot;]\n     [:option {:value \&quot;study\&quot;} \&quot;Study\&quot;]\n     [:option {:value \&quot;work\&quot;} \&quot;Work\&quot;]]\n\n    [:select {:name \&quot;intensity\&quot; :required true}\n     [:option {:value \&quot;\&quot; :selected true :disabled true :hidden true} \&quot;Choose Intensity\&quot;]\n     [:option {:value \&quot;1\&quot;} \&quot;Low\&quot;]\n     [:option {:value \&quot;3\&quot;} \&quot;Mid\&quot;]\n     [:option {:value \&quot;5\&quot;} \&quot;High\&quot;]]\n\n    [:select {:name \&quot;duration\&quot;}\n     [:option {:value \&quot;30\&quot;} \&quot;30min\&quot;]\n     [:option {:value \&quot;60\&quot;} \&quot;1h\&quot;]\n     [:option {:value \&quot;120\&quot;} \&quot;2h\&quot;]\n     [:option {:value \&quot;180\&quot;} \&quot;3h\&quot;]\n     [:option {:value \&quot;240\&quot;} \&quot;4h\&quot;]]\n\n    [:button {:type \&quot;submit\&quot;} \&quot;Save\&quot;]\n    [:button {:type \&quot;button\&quot;\n              :onclick \&quot;this.closest('.slot-form-container').remove()\&quot;\n              :style \&quot;background: #ccc; color: black;\&quot;} \&quot;X\&quot;]]])\n\n(defn activity-edit-view [id]\n  [:div.activity-edit\n   {:style \&quot;background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px;\&quot;}\n   [:span \&quot;Edit mode\&quot;]\n   [:div.activity-actions\n    [:button {:hx-delete \&quot;/activity\&quot;\n              :hx-vals (generate-string {:id id})\n              :hx-target (str \&quot;#activity-\&quot; id)\n              :hx-swap \&quot;delete\&quot;}]\n    \&quot;Delete\&quot;]\n   [:button\n    {:hx-get \&quot;/activity-view\&quot;\n     :hx-vals (generate-string {:id id})\n     :hx-target \&quot;closest .activity-block\&quot;\n     :hx-swap \&quot;innerHTML\&quot;}\n    \&quot;Cancel\&quot;]])\n\n(defn home-page [request]\n  (let [today-str (format-date (LocalDate/now))\n        activities (get-activities-for-date \&quot;Micko\&quot; today-str)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body\n     (common-layout\n      [:div\n       [:h2 \&quot;Calendar\&quot;]\n       (day-column today-str)\n       (calendar-view today-str activities)])}))\n\n(defn select-day-handler [{:keys [params]}]\n  (let [day (:day params)\n        activities (get-activities-for-date \&quot;Micko\&quot; day)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str\n            (h/html (calendar-view day activities))\n            (let [dc (day-column day)]\n              (h/html (assoc-in dc [1 :hx-swap-oob] \&quot;true\&quot;))))}))\n\n(defn slot-form-handler [{:keys [params]}]\n  (let [hour (:hour params)]\n    {:status  200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body    (str (h/html (slot-form hour)))}))\n\n(defn add-activity-handler [{:keys [params]}]\n  (println \&quot;UPISUJEM U BAZU: \&quot; params)\n  (let [username \&quot;Micko\&quot;\n        title (keyword (:title params))\n        intensity (Integer/parseInt (:intensity params))\n        duration (Integer/parseInt (:duration params))\n        hour (Integer/parseInt (:hour params))\n        date-str (or (:date params (format-date (LocalDate/now))))\n\n        local-date (parse-date date-str)\n        local-time (LocalTime/of hour 0)\n        start-time (java.util.Date/from (.toInstant (.atZone (.atTime local-date local-time) (ZoneId/of \&quot;Europe/Belgrade\&quot;))))]\n\n    @(d/transact s/conn\n                 [[:activity/add username title duration intensity start-time]])\n\n    (let [new-activity-view {:id \&quot;temp-id\&quot;\n                             :title (name title)\n                             :intensity intensity\n                             :duration duration\n                             :hour hour}]\n      {:status 200\n       :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n       :body\n       (str\n        (h/html (activity-&gt;block new-activity-view)))})))\n\n(defn activity-edit-handler [{:keys [params]}]\n  (let [id (:id params)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html (activity-edit-view id)))}))\n\n(defn activity-view-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)\n        activity (first (filter #(= (:id %) id)\n                                (get-in session [:activities day])))]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :body (str (h/html [:div {:hx-get \&quot;/activity-edit\&quot;\n                               :hx-vals (generate-string {:id id})\n                               :hx-target (str \&quot;#activity-\&quot; id)\n                               :hx-swap \&quot;innerHTML\&quot;\n                               :style \&quot;height:100%; cursor:pointer;\&quot;}\n                         (str (:title activity) \&quot;  \&quot;\n                              (:intensity activity) \&quot;  \&quot;\n                              (:duration activity) \&quot;h\&quot;)]))}))\n\n(defn activity-delete-handler [{:keys [params session]}]\n  (let [id (:id params)\n        day (:select-day session)]\n    {:status 200\n     :headers {\&quot;Content-Type\&quot; \&quot;text/html\&quot;}\n     :session (update-in session [:activities day]\n                         (fn [acts]\n                           (vec (remove #(= (:id %) id) acts))))\n     :body \&quot;\&quot;}))\n\n(def app\n  (wrap-session\n   (ring/ring-handler\n    (ring/router [[\&quot;/\&quot; {:get home-page}]\n                  [\&quot;/select-day\&quot; {:post select-day-handler}]\n                  [\&quot;/slot-form\&quot; {:get slot-form-handler}]\n                  [\&quot;/add-activity\&quot; {:post add-activity-handler}]\n                  [\&quot;/activity-edit\&quot; {:get activity-edit-handler}]\n                  [\&quot;/activity\&quot; {:delete activity-delete-handler}]\n                  [\&quot;/favicon.ico\&quot; {:get (fn [_] {:status 204 :body \&quot;\&quot;})}]\n                  [\&quot;/activity-view\&quot; {:get activity-view-handler}]]\n                 {:data {:middleware [parameters/parameters-middleware\n                                      wrap-keyword-params]}}))))\n\n(defonce server (atom nil))\n\n(defn start-server []\n  (when-not @server\n    (reset! server (jetty/run-jetty #'app {:port port :join? false}))\n    (println \&quot;server pokrenut na http://localhost:3000\&quot;)))\n\n(defn stop-server []\n  (when-some [s @server] ;; check if there is an object in the atom\n    (.stop s)\n    (reset! server nil)))     ; https://ericnormand.me/guide/clojure-web-tutorial\n&quot;, :offset 16234, :ns &quot;web.server&quot;}], :remote []}}</component>
  <component name="RunManager" selected="Clojure REPL.REPL for ProjectV1">
    <configuration default="true" type="Babashka" factoryName="BabashkaLocalRepl" activateToolWindowBeforeRun="false">
      <setting name="displayName" value="" />
      <setting name="bbPath" value="" />
      <setting name="parameters" value="" />
      <option name="PARENT_ENVS" value="true" />
      <setting name="workingDir" value="" />
      <setting name="focusEditor" value="false" />
      <method v="2">
        <option name="Make" enabled="true" />
      </method>
    </configuration>
    <configuration name="REPL for ProjectV1" type="ClojureREPL" factoryName="Local" activateToolWindowBeforeRun="false">
      <option name="configVersion" value="1" />
      <option name="displayName" value="REPL for ProjectV1" />
      <option name="execution" value="LEININGEN" />
      <module name="ProjectV1" />
      <option name="options" />
      <option name="profiles" />
      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
      <method v="2" />
    </configuration>
    <configuration default="true" type="ClojureREPL" factoryName="Local" activateToolWindowBeforeRun="false">
      <option name="configVersion" value="1" />
      <option name="options" />
      <option name="profiles" />
      <method v="2" />
    </configuration>
    <configuration default="true" type="ClojureREPL" factoryName="Remote" activateToolWindowBeforeRun="false">
      <setting name="displayName" value="" />
      <setting name="host" value="" />
      <setting name="port" value="0" />
      <setting name="replType" value="SOCKET" />
      <setting name="configType" value="SPECIFY" />
      <setting name="replPortFileType" value="STANDARD" />
      <setting name="customPortFile" value="" />
      <setting name="fixLineNumbers" value="false" />
      <setting name="useHeartbeat" value="true" />
      <setting name="focusEditor" value="false" />
      <setting name="urlFile" value="" />
      <method v="2" />
    </configuration>
    <configuration name="Test project.api-test/delta-test" type="ClojureTestRunConfiguration" factoryName="clojure.test" temporary="true">
      <module name="ProjectV1" />
      <option name="selector" value="SINGLE_VAR" />
      <option name="varFqn" value="project.api-test/delta-test" />
      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
      <method v="2" />
    </configuration>
    <configuration name="Test project.api-test/leaderboard-rank-ties-test" type="ClojureTestRunConfiguration" factoryName="clojure.test" temporary="true">
      <module name="ProjectV1" />
      <option name="selector" value="SINGLE_VAR" />
      <option name="varFqn" value="project.api-test/leaderboard-rank-ties-test" />
      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
      <method v="2" />
    </configuration>
    <recent_temporary>
      <list>
        <item itemvalue="clojure.test.Test project.api-test/delta-test" />
        <item itemvalue="clojure.test.Test project.api-test/leaderboard-rank-ties-test" />
      </list>
    </recent_temporary>
  </component>
  <component name="SharedIndexes">
    <attachedChunks>
      <set>
        <option value="bundled-jdk-9823dce3aa75-fbdcb00ec9e3-intellij.indexing.shared.core-IU-251.25410.129" />
        <option value="bundled-js-predefined-d6986cc7102b-6a121458b545-JavaScript-IU-251.25410.129" />
      </set>
    </attachedChunks>
  </component>
  <component name="TaskManager">
    <task active="true" id="Default" summary="Default task">
      <changelist id="4d338447-6f3a-43e8-ab8c-95e214f36644" name="Changes" comment="" />
      <created>1767121985479</created>
      <option name="number" value="Default" />
      <option name="presentableId" value="Default" />
      <updated>1767121985479</updated>
      <workItem from="1767121986415" duration="3674000" />
      <workItem from="1767181139032" duration="1494000" />
      <workItem from="1767351215899" duration="6476000" />
      <workItem from="1767379148928" duration="2673000" />
      <workItem from="1767381868455" duration="67000" />
      <workItem from="1767472762290" duration="1088000" />
      <workItem from="1767537145030" duration="11000" />
      <workItem from="1767625268145" duration="5102000" />
      <workItem from="1767694847080" duration="18149000" />
      <workItem from="1767804228503" duration="9080000" />
      <workItem from="1767892649731" duration="8974000" />
      <workItem from="1767906416609" duration="6067000" />
      <workItem from="1767958972899" duration="595000" />
      <workItem from="1768070963735" duration="14388000" />
      <workItem from="1768129866250" duration="9988000" />
      <workItem from="1768149678456" duration="13189000" />
      <workItem from="1768171748332" duration="36000" />
      <workItem from="1768403682096" duration="4369000" />
      <workItem from="1768474526888" duration="8177000" />
      <workItem from="1768491610839" duration="3377000" />
      <workItem from="1768587661011" duration="10613000" />
      <workItem from="1768638813832" duration="14723000" />
      <workItem from="1768662775460" duration="5330000" />
      <workItem from="1768736915225" duration="291000" />
      <workItem from="1768771507620" duration="5414000" />
      <workItem from="1768808685053" duration="10422000" />
      <workItem from="1768828344403" duration="6339000" />
      <workItem from="1768841963659" duration="9097000" />
      <workItem from="1768919011338" duration="96000" />
      <workItem from="1769022282280" duration="7836000" />
      <workItem from="1769075977686" duration="8791000" />
      <workItem from="1769089486580" duration="5158000" />
      <workItem from="1769124897316" duration="72000" />
      <workItem from="1769184242641" duration="3047000" />
      <workItem from="1769250460539" duration="3000" />
      <workItem from="1769333055758" duration="3673000" />
      <workItem from="1769361640551" duration="10655000" />
      <workItem from="1769419857978" duration="11966000" />
      <workItem from="1769452940043" duration="2856000" />
      <workItem from="1769540791944" duration="4000" />
      <workItem from="1769548779354" duration="4444000" />
      <workItem from="1769589827861" duration="3658000" />
      <workItem from="1769618988716" duration="2355000" />
      <workItem from="1769677511044" duration="15282000" />
      <workItem from="1769697916247" duration="11000" />
      <workItem from="1769710839254" duration="4017000" />
      <workItem from="1769806496931" duration="2000" />
      <workItem from="1769808410217" duration="692000" />
      <workItem from="1769851791837" duration="8364000" />
      <workItem from="1769867711662" duration="3820000" />
      <workItem from="1769886709383" duration="12294000" />
      <workItem from="1770036313639" duration="3000" />
      <workItem from="1770051578848" duration="14782000" />
      <workItem from="1770112147511" duration="2076000" />
      <workItem from="1770118757880" duration="3473000" />
      <workItem from="1770974731162" duration="7670000" />
      <workItem from="1771016751918" duration="2951000" />
      <workItem from="1771062323627" duration="2829000" />
      <workItem from="1771238193549" duration="2632000" />
      <workItem from="1771281594047" duration="601000" />
      <workItem from="1771344980248" duration="2716000" />
      <workItem from="1771494699437" duration="2306000" />
      <workItem from="1771497073767" duration="495000" />
      <workItem from="1771502553739" duration="611000" />
    </task>
    <task id="LOCAL-00001" summary="Ucitan je Datomic, sad vezbam koriscenje kroz dokumentaciju">
      <option name="closed" value="true" />
      <created>1767125847824</created>
      <option name="number" value="00001" />
      <option name="presentableId" value="LOCAL-00001" />
      <option name="project" value="LOCAL" />
      <updated>1767125847824</updated>
    </task>
    <task id="LOCAL-00002" summary="Dodate neke default funkcije koje rade sa bazom u datomicu">
      <option name="closed" value="true" />
      <created>1767367199446</created>
      <option name="number" value="00002" />
      <option name="presentableId" value="LOCAL-00002" />
      <option name="project" value="LOCAL" />
      <updated>1767367199446</updated>
    </task>
    <task id="LOCAL-00003" summary="Uradjene kreiraj korisnika i dodaj xp u bazi">
      <option name="closed" value="true" />
      <created>1767381886292</created>
      <option name="number" value="00003" />
      <option name="presentableId" value="LOCAL-00003" />
      <option name="project" value="LOCAL" />
      <updated>1767381886292</updated>
    </task>
    <task id="LOCAL-00004" summary="Uradjene kreiraj korisnika i dodaj xp u bazi 2">
      <option name="closed" value="true" />
      <created>1767483540530</created>
      <option name="number" value="00004" />
      <option name="presentableId" value="LOCAL-00004" />
      <option name="project" value="LOCAL" />
      <updated>1767483540530</updated>
    </task>
    <task id="LOCAL-00005" summary="Provezbana funkcija add-xp">
      <option name="closed" value="true" />
      <created>1767634382925</created>
      <option name="number" value="00005" />
      <option name="presentableId" value="LOCAL-00005" />
      <option name="project" value="LOCAL" />
      <updated>1767634382925</updated>
    </task>
    <task id="LOCAL-00006" summary="transakciona funkcija koja dodaje xp useru, kreirana sema aktivnosti/event koje user izvrsava da bi dobio xp, &#10;kreirana sema tipa aktivnosti koja ima main tip aktivnosti.&#10;odvajam kod u dva paketa db i main paket, &#10;i db.clj u dva fajla schema.clj, seed.clj gde cu imati back ako mi se nesto zezne kao na primer da ubacim dva worka...">
      <option name="closed" value="true" />
      <created>1767734960862</created>
      <option name="number" value="00006" />
      <option name="presentableId" value="LOCAL-00006" />
      <option name="project" value="LOCAL" />
      <updated>1767734960862</updated>
    </task>
    <task id="LOCAL-00007" summary="transakciona funkcija koja dodaje xp useru, kreirana sema aktivnosti/event koje user izvrsava da bi dobio xp, &#10;kreirana sema tipa aktivnosti koja ima main tip aktivnosti.&#10;odvajam kod u dva paketa db i main paket, &#10;i db.clj u dva fajla schema.clj, seed.clj gde cu imati back ako mi se nesto zezne kao na primer da ubacim dva worka...">
      <option name="closed" value="true" />
      <created>1767734966394</created>
      <option name="number" value="00007" />
      <option name="presentableId" value="LOCAL-00007" />
      <option name="project" value="LOCAL" />
      <updated>1767734966394</updated>
    </task>
    <task id="LOCAL-00008" summary="Uh, datomic je malo naporan iskreno, ali zanimljiv jer je sve kao u clojuru. Odvojio sam scheme i seed, pohvatao sam fazon sa transakcijama, i kako se sta pise">
      <option name="closed" value="true" />
      <created>1767742945250</created>
      <option name="number" value="00008" />
      <option name="presentableId" value="LOCAL-00008" />
      <option name="project" value="LOCAL" />
      <updated>1767742945250</updated>
    </task>
    <task id="LOCAL-00009" summary="Kreirana funkcija activity/add, sustina app, na osnovu parametara se izracuna xp za odredjenu aktivnost">
      <option name="closed" value="true" />
      <created>1767812289892</created>
      <option name="number" value="00009" />
      <option name="presentableId" value="LOCAL-00009" />
      <option name="project" value="LOCAL" />
      <updated>1767812289893</updated>
    </task>
    <task id="LOCAL-00010" summary="Fixed add-activity-tx,&#10;user-activities -&gt; query for finding all activities of one user">
      <option name="closed" value="true" />
      <created>1767902122657</created>
      <option name="number" value="00010" />
      <option name="presentableId" value="LOCAL-00010" />
      <option name="project" value="LOCAL" />
      <updated>1767902122657</updated>
    </task>
    <task id="LOCAL-00011" summary="Daily activities by user - list of every activity done in one day.&#10;Daily-xp - user can be put in leaderboard to compete and compare daily activities with other people.">
      <option name="closed" value="true" />
      <created>1767915212637</created>
      <option name="number" value="00011" />
      <option name="presentableId" value="LOCAL-00011" />
      <option name="project" value="LOCAL" />
      <updated>1767915212637</updated>
    </task>
    <task id="LOCAL-00012" summary="Daily, Weekly and Monthly activities and xp per user">
      <option name="closed" value="true" />
      <created>1768083937606</created>
      <option name="number" value="00012" />
      <option name="presentableId" value="LOCAL-00012" />
      <option name="project" value="LOCAL" />
      <updated>1768083937606</updated>
    </task>
    <task id="LOCAL-00013" summary="Daily, Weekly and Monthly activities and xp per user">
      <option name="closed" value="true" />
      <created>1768085174478</created>
      <option name="number" value="00013" />
      <option name="presentableId" value="LOCAL-00013" />
      <option name="project" value="LOCAL" />
      <updated>1768085174478</updated>
    </task>
    <task id="LOCAL-00014" summary="Fixing old code, erasing and moving unnecessary and outdated functions. &#10;Setting up better architecture, more readable">
      <option name="closed" value="true" />
      <created>1768162612523</created>
      <option name="number" value="00014" />
      <option name="presentableId" value="LOCAL-00014" />
      <option name="project" value="LOCAL" />
      <updated>1768162612523</updated>
    </task>
    <task id="LOCAL-00015" summary="Testing of malli validation">
      <option name="closed" value="true" />
      <created>1768165269540</created>
      <option name="number" value="00015" />
      <option name="presentableId" value="LOCAL-00015" />
      <option name="project" value="LOCAL" />
      <updated>1768165269540</updated>
    </task>
    <task id="LOCAL-00016" summary="Malli validation, validate! function">
      <option name="closed" value="true" />
      <created>1768167032069</created>
      <option name="number" value="00016" />
      <option name="presentableId" value="LOCAL-00016" />
      <option name="project" value="LOCAL" />
      <updated>1768167032069</updated>
    </task>
    <task id="LOCAL-00017" summary="Validation of transaction function add-activity and create user">
      <option name="closed" value="true" />
      <created>1768169307460</created>
      <option name="number" value="00017" />
      <option name="presentableId" value="LOCAL-00017" />
      <option name="project" value="LOCAL" />
      <updated>1768169307460</updated>
    </task>
    <task id="LOCAL-00018" summary="Leaderboard for one day, week and month">
      <option name="closed" value="true" />
      <created>1768495590013</created>
      <option name="number" value="00018" />
      <option name="presentableId" value="LOCAL-00018" />
      <option name="project" value="LOCAL" />
      <updated>1768495590013</updated>
    </task>
    <task id="LOCAL-00019" summary="Leaderboard finito">
      <option name="closed" value="true" />
      <created>1768592793347</created>
      <option name="number" value="00019" />
      <option name="presentableId" value="LOCAL-00019" />
      <option name="project" value="LOCAL" />
      <updated>1768592793347</updated>
    </task>
    <task id="LOCAL-00020" summary="Leaderboard finito 2, merged daily, weekly, monthly leaderboard function in one function, all time leaderboard is still by itself">
      <option name="closed" value="true" />
      <created>1768600694449</created>
      <option name="number" value="00020" />
      <option name="presentableId" value="LOCAL-00020" />
      <option name="project" value="LOCAL" />
      <updated>1768600694449</updated>
    </task>
    <task id="LOCAL-00021" summary="Leaderboard finito 3, i merged even all-time in default leaderboard fn, so now code is clearer and less messy. Deleted unnecessary fucntion i no longer use. Added 3 tests for 2 for adding activity and 1 for leaderboard.">
      <option name="closed" value="true" />
      <created>1768661297153</created>
      <option name="number" value="00021" />
      <option name="presentableId" value="LOCAL-00021" />
      <option name="project" value="LOCAL" />
      <updated>1768661297153</updated>
    </task>
    <task id="LOCAL-00022" summary="API preparing for frontend, did some validation">
      <option name="closed" value="true" />
      <created>1768779315145</created>
      <option name="number" value="00022" />
      <option name="presentableId" value="LOCAL-00022" />
      <option name="project" value="LOCAL" />
      <updated>1768779315145</updated>
    </task>
    <task id="LOCAL-00023" summary="Leaderboard with rank and ties in xp">
      <option name="closed" value="true" />
      <created>1768833163143</created>
      <option name="number" value="00023" />
      <option name="presentableId" value="LOCAL-00023" />
      <option name="project" value="LOCAL" />
      <updated>1768833163143</updated>
    </task>
    <task id="LOCAL-00024" summary="Leaderboard delta, calculate changes in rank">
      <option name="closed" value="true" />
      <created>1768855602635</created>
      <option name="number" value="00024" />
      <option name="presentableId" value="LOCAL-00024" />
      <option name="project" value="LOCAL" />
      <updated>1768855602635</updated>
    </task>
    <task id="LOCAL-00025" summary="Leaderboard delta still">
      <option name="closed" value="true" />
      <created>1768859643777</created>
      <option name="number" value="00025" />
      <option name="presentableId" value="LOCAL-00025" />
      <option name="project" value="LOCAL" />
      <updated>1768859643777</updated>
    </task>
    <task id="LOCAL-00026" summary="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;I failed today, it needs fix tomorrow.">
      <option name="closed" value="true" />
      <created>1769039313571</created>
      <option name="number" value="00026" />
      <option name="presentableId" value="LOCAL-00026" />
      <option name="project" value="LOCAL" />
      <updated>1769039313571</updated>
    </task>
    <task id="LOCAL-00027" summary="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;Fixed, problem was in test data">
      <option name="closed" value="true" />
      <created>1769078211847</created>
      <option name="number" value="00027" />
      <option name="presentableId" value="LOCAL-00027" />
      <option name="project" value="LOCAL" />
      <updated>1769078211847</updated>
    </task>
    <task id="LOCAL-00028" summary="Change to clojure.test, done 2 tests">
      <option name="closed" value="true" />
      <created>1769124957289</created>
      <option name="number" value="00028" />
      <option name="presentableId" value="LOCAL-00028" />
      <option name="project" value="LOCAL" />
      <updated>1769124957289</updated>
    </task>
    <task id="LOCAL-00029" summary="Front end using htmx with hiccup.Using ring for web server and metosin reitit for routes/ with hiccup. &#10;Server is up, and most basic leaderboard is shown.">
      <option name="closed" value="true" />
      <created>1769377318034</created>
      <option name="number" value="00029" />
      <option name="presentableId" value="LOCAL-00029" />
      <option name="project" value="LOCAL" />
      <updated>1769377318034</updated>
    </task>
    <task id="LOCAL-00030" summary="Practicing htmx basics">
      <option name="closed" value="true" />
      <created>1769433573151</created>
      <option name="number" value="00030" />
      <option name="presentableId" value="LOCAL-00030" />
      <option name="project" value="LOCAL" />
      <updated>1769433573151</updated>
    </task>
    <task id="LOCAL-00031" summary="Practicing htmx basics 2">
      <option name="closed" value="true" />
      <created>1769467170509</created>
      <option name="number" value="00031" />
      <option name="presentableId" value="LOCAL-00031" />
      <option name="project" value="LOCAL" />
      <updated>1769467170509</updated>
    </task>
    <task id="LOCAL-00032" summary="Day picker and 24h planner">
      <option name="closed" value="true" />
      <created>1769555708729</created>
      <option name="number" value="00032" />
      <option name="presentableId" value="LOCAL-00032" />
      <option name="project" value="LOCAL" />
      <updated>1769555708729</updated>
    </task>
    <task id="LOCAL-00033" summary="Formated code, instagram sidebar">
      <option name="closed" value="true" />
      <created>1769642325281</created>
      <option name="number" value="00033" />
      <option name="presentableId" value="LOCAL-00033" />
      <option name="project" value="LOCAL" />
      <updated>1769642325281</updated>
    </task>
    <task id="LOCAL-00034" summary="Select time, it does not fully work, will fix">
      <option name="closed" value="true" />
      <created>1769687989801</created>
      <option name="number" value="00034" />
      <option name="presentableId" value="LOCAL-00034" />
      <option name="project" value="LOCAL" />
      <updated>1769687989801</updated>
    </task>
    <task id="LOCAL-00035" summary="User can choose activity, intensity, duration and remove activity">
      <option name="closed" value="true" />
      <created>1769697572550</created>
      <option name="number" value="00035" />
      <option name="presentableId" value="LOCAL-00035" />
      <option name="project" value="LOCAL" />
      <updated>1769697572550</updated>
    </task>
    <task id="LOCAL-00036" summary="Front, form is under hour-row, cant fix it">
      <option name="closed" value="true" />
      <created>1769867454023</created>
      <option name="number" value="00036" />
      <option name="presentableId" value="LOCAL-00036" />
      <option name="project" value="LOCAL" />
      <updated>1769867454023</updated>
    </task>
    <task id="LOCAL-00037" summary="Front, can add activity on front, cant delete it, it looks okay">
      <option name="closed" value="true" />
      <created>1769871551290</created>
      <option name="number" value="00037" />
      <option name="presentableId" value="LOCAL-00037" />
      <option name="project" value="LOCAL" />
      <updated>1769871551290</updated>
    </task>
    <task id="LOCAL-00038" summary="Tried to do calendar tutorial, but its far too boring to translate html in hiccup, because hiccup is stupid for writing html.&#10;Getting back to old front. When im ready to upgrade app to next level, i will use modern calendar, right now i dont need it.">
      <option name="closed" value="true" />
      <created>1770058353469</created>
      <option name="number" value="00038" />
      <option name="presentableId" value="LOCAL-00038" />
      <option name="project" value="LOCAL" />
      <updated>1770058353469</updated>
    </task>
    <task id="LOCAL-00039" summary="Adding to base works, user can add activity from front, delete and edit dont work">
      <option name="closed" value="true" />
      <created>1770071190711</created>
      <option name="number" value="00039" />
      <option name="presentableId" value="LOCAL-00039" />
      <option name="project" value="LOCAL" />
      <updated>1770071190711</updated>
    </task>
    <task id="LOCAL-00040" summary="User can see old activities, but problem is every activity is on same time, need to fix">
      <option name="closed" value="true" />
      <created>1770124034751</created>
      <option name="number" value="00040" />
      <option name="presentableId" value="LOCAL-00040" />
      <option name="project" value="LOCAL" />
      <updated>1770124034751</updated>
    </task>
    <option name="localTasksCounter" value="41" />
    <servers />
  </component>
  <component name="TypeScriptGeneratedFilesManager">
    <option name="version" value="3" />
  </component>
  <component name="Vcs.Log.Tabs.Properties">
    <option name="TAB_STATES">
      <map>
        <entry key="MAIN">
          <value>
            <State />
          </value>
        </entry>
      </map>
    </option>
  </component>
  <component name="VcsManagerConfiguration">
    <MESSAGE value="Malli validation, validate! function" />
    <MESSAGE value="Validation of transaction function add-activity and create user" />
    <MESSAGE value="Leaderboard for one day, week and month" />
    <MESSAGE value="Leaderboard finito" />
    <MESSAGE value="Leaderboard finito 2, merged daily, weekly, monthly leaderboard function in one function, all time leaderboard is still by itself" />
    <MESSAGE value="Leaderboard finito 3, i merged even all-time in default leaderboard fn, so now code is clearer and less messy. Deleted unnecessary fucntion i no longer use. Added 3 tests for 2 for adding activity and 1 for leaderboard." />
    <MESSAGE value="API preparing for frontend, did some validation" />
    <MESSAGE value="Leaderboard with rank and ties in xp" />
    <MESSAGE value="Leaderboard delta, calculate changes in rank" />
    <MESSAGE value="Leaderboard delta still" />
    <MESSAGE value="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;I failed today, it needs fix tomorrow." />
    <MESSAGE value="Leaderboard delta test, edge case -&gt; when new user is added, how he evaluate,&#10;Fixed, problem was in test data" />
    <MESSAGE value="Change to clojure.test, done 2 tests" />
    <MESSAGE value="Front end using htmx with hiccup.Using ring for web server and metosin reitit for routes/ with hiccup. &#10;Server is up, and most basic leaderboard is shown." />
    <MESSAGE value="Practicing htmx basics" />
    <MESSAGE value="Practicing htmx basics 2" />
    <MESSAGE value="Day picker and 24h planner" />
    <MESSAGE value="Formated code, instagram sidebar" />
    <MESSAGE value="Select time, it does not fully work, will fix" />
    <MESSAGE value="User can choose activity, intensity, duration and remove activity" />
    <MESSAGE value="Front, form is under hour-row, cant fix it" />
    <MESSAGE value="Front, can add activity on front, cant delete it, it looks okay" />
    <MESSAGE value="Tried to do calendar tutorial, but its far too boring to translate html in hiccup, because hiccup is stupid for writing html.&#10;Getting back to old front. When im ready to upgrade app to next level, i will use modern calendar, right now i dont need it." />
    <MESSAGE value="Adding to base works, user can add activity from front, delete and edit dont work" />
    <MESSAGE value="User can see old activities, but problem is every activity is on same time, need to fix" />
    <option name="LAST_COMMIT_MESSAGE" value="User can see old activities, but problem is every activity is on same time, need to fix" />
  </component>
  <component name="XSLT-Support.FileAssociations.UIState">
    <expand />
    <select />
  </component>
</project>